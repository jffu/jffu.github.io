<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    

    
<script>!function(){var e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("use-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script>
    

<meta charset="utf-8" >

<title>从上往下读HSF源码</title>
<meta name="keywords" content="从上往下读HSF源码, jffu&#39;s blog">
<meta name="description" content="上万字笔记，从上往下领略HSF设计">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta property="og:title" content="从上往下读HSF源码">
<meta property="og:description" content="上万字笔记，从上往下领略HSF设计">

<link rel="shortcut icon" href="/favicon.ico">
<link rel="stylesheet" href="/style/main.css">

  <link rel="stylesheet" href="/style/simple-lightbox.min.css"><meta name="generator" content="Hexo 6.3.0"></head>
  <body>
    <div id="app" class="main">

<div class="site-header-container">
  <div class="site-header">
    <div class="left">
      <a href="https://jffu.github.io">
        <img class="avatar" src="/images/avatar.jpeg" alt="logo" width="32px" height="32px">
      </a>
      <a href="https://jffu.github.io">
        <h1 class="site-title">jffu&#39;s blog</h1>
      </a>
    </div>
    <div class="right">
        <i class="icon menu-switch icon-menu-outline" ></i>
    </div>
  </div>
</div>

<div class="menu-container" style="height: 0;opacity: 0;">
<nav class="menu-list">
  
    
      <a href="/" class="menu purple-link">
        首页
      </a>
    
  
    
      <a href="/tags" class="menu purple-link">
        标签
      </a>
    
  
    
      <a href="/archives" class="menu purple-link">
        归档
      </a>
    
  
    
      <a href="/about" class="menu purple-link">
        关于
      </a>
    
  
</nav>
</div>



  <div class="content-container">
    <div class="post-detail">
      
      <h2 class="post-title">从上往下读HSF源码</h2>
      <div class="post-info post-detail-info">
        <span><i class="icon icon-calendar-outline"></i> 2018-11-06</span>
        
          <span>
          <i class="icon icon-pricetags-outline"></i>
            
              <a href="/tags/Java/">
              Java
                
                  ，
                
              </a>
            
              <a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">
              中间件
                
              </a>
            
          </span>
        
      </div>
      <div class="post-content-wrapper">
        <div class="post-content">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>HSF是阿里内部最广泛使用的RPC框架，HSF2.2版本重构后，通过灵活的SPI扩展机制，将不同的功能分成从上到下分成4个领域：</p>
<ul>
<li>配置领域</li>
<li>服务领域</li>
<li>应用领域</li>
<li>框架领域</li>
</ul>
<p>结构非常清晰，对于想学习RPC机制的同学来说，其源码非常值得一读。</p>
<p><a class="simple-lightbox" target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/jffu/jffu-blog-images@main/img/Fv8dj3Mo_EF_K6058rPZxz_vRd6t.png"><img   src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/jffu/jffu-blog-images@main/img/Fv8dj3Mo_EF_K6058rPZxz_vRd6t.png"  lazyload></a></p>
<h1 id="1-配置领域"><a href="#1-配置领域" class="headerlink" title="1 配置领域"></a>1 配置领域</h1><p>配置领域是面向HSF使用者的入口，我们引入HSF框架后，通过配置provider和consumer，就可以使用HSF的能力了。</p>
<h2 id="1-1-配置方式"><a href="#1-1-配置方式" class="headerlink" title="1.1 配置方式"></a>1.1 配置方式</h2><p>配置是用户对HSF框架进行配置的入口，常见的几种配置方式：</p>
<ul>
<li>Spring Boot：通过<code>@HSFProvider</code>和<code>@HSFConsumer</code>注解配置Provider和Consumer</li>
<li>Spring：通过配置<code>HSFSpringProviderBean</code>和<code>HSFSpringConsumerBean</code>来进行配置</li>
<li>不依赖Spring：直接配置<code>HSFApiProviderBean</code>和<code>HSFApiProviderBean</code></li>
</ul>
<p>依次依赖下层提供的能力实现配置，例如<code>@HSFProvider</code>会配置<code>HSFSpringProviderBean</code>，<code>HSFSpringProviderBean</code>会配置<code>HSFApiProviderBean</code>。</p>
<p>配置的最终目的是根据配置信息构造和初始化服务元数据对象<code>ServiceMetadata</code>。<code>ServiceMetadata</code>是HSF的核心组件，包括了元数据信息本身的描述，调用链，以及服务信息的发布与订阅。</p>
<h2 id="1-2-代码流程"><a href="#1-2-代码流程" class="headerlink" title="1.2 代码流程"></a>1.2 代码流程</h2><p>配置部分的代码分为两步：</p>
<ol>
<li>配置<code>APIBean</code>（<code>HSFApiProviderBean</code>&#x2F;<code>HSFApiConsumerBean</code>），<code>APIBean</code>是HSF提供给使用者的配置入口；</li>
<li>基于<code>APIBean</code>初始化<code>ServiceMetadata</code>；</li>
</ol>
<h3 id="1-2-1-APIBean配置"><a href="#1-2-1-APIBean配置" class="headerlink" title="1.2.1 APIBean配置"></a>1.2.1 <code>APIBean</code>配置</h3><p>以Spring Boot下的使用为例，配置<code>APIBean</code>的代码流程就是<code>@HSFProvider</code>和<code>@HSFConsumer</code>两个注解的解析和初始化流程。两个注解的解析方式：</p>
<ul>
<li><code>@HSFProvider</code>：直接向Spring容器中注入<code>HSFSpringProviderBean</code>的<code>BeanDefinition</code></li>
<li><code>@HSFConsumer</code>：通过<code>HsfConsumerPostProcessor</code>这个<code>BeanFactoryPostProcessor</code>，在Spring的<code>BeanFactory</code>初始化完成后回调<code>postProcessBeanFactory</code>，在其中获取所有bean，解析标注了<code>@HSFConsumer</code>注解的字段变量，注入<code>HSFSpringConsumerBean</code>的<code>BeanDefinition</code></li>
</ul>
<p>虽然注解解析方式并不一致，但最终都是将每个服务接口外部的配置转换为一个对应的<code>ServiceMetadata</code>对象的属性。</p>
<p>以Provider为例，流程图：<br><a class="simple-lightbox" target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/jffu/jffu-blog-images@main/img/FrbuOhcZfUuNzmXpPQdBlRc8npLt.png"><img   src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/jffu/jffu-blog-images@main/img/FrbuOhcZfUuNzmXpPQdBlRc8npLt.png"  lazyload></a></p>
<h4 id="1-2-1-1-HSFProvider"><a href="#1-2-1-1-HSFProvider" class="headerlink" title="1.2.1.1 @HSFProvider"></a>1.2.1.1 <code>@HSFProvider</code></h4><p>以发布时使用的<code>@HSFProvider</code>为例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HSFProvider(serviceInterface = OrderService.class, serviceGroup = &quot;HSF&quot;, serviceVersion = &quot;1.0.0&quot;, clientTimeout = 3000)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>@HSFProvider</code>中定义了所有发布相关的配置，包括最重要的三个属性：<code>serviceInterface</code>&#x2F;<code>serviceVersion</code>&#x2F;<code>serviceGroup</code>，以及一些其他属性，例如客户端超时<code>clientTimeout</code>、核心线程池数<code>corePoolSize</code>等等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Import(HsfProviderAnnotationRegistrar.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> HSFProvider &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The value may indicate a suggestion for a logical component name,</span></span><br><span class="line"><span class="comment">     * to be turned into a Spring bean in case of an autodetected component.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the suggested component name, if any</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * HSF service interface</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Class&lt;?&gt; serviceInterface() <span class="keyword">default</span> Object.class;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * HSF service version</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">serviceVersion</span><span class="params">()</span> <span class="keyword">default</span> Constants.DEFAULT_VERSION;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * HSF service group</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">serviceGroup</span><span class="params">()</span> <span class="keyword">default</span> Constants.DEFAULT_GROUP;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 省略</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>@HSFProvider</code>通过Spring的<code>@Import</code>注解引入了<code>HsfProviderAnnotationRegistrar</code>，由<code>HsfProviderAnnotationRegistrar</code>负责向Spring容器中注入<code>HSFSpringProviderBean</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Import(HsfProviderAnnotationRegistrar.class)</span></span><br></pre></td></tr></table></figure>

<h4 id="1-2-1-2-HsfProviderAnnotationRegistrar"><a href="#1-2-1-2-HsfProviderAnnotationRegistrar" class="headerlink" title="1.2.1.2 HsfProviderAnnotationRegistrar"></a>1.2.1.2 <code>HsfProviderAnnotationRegistrar</code></h4><p><code>HsfProviderAnnotationRegistrar</code>的主要工作：使用<code>HsfProviderBeanDefinitionBuilder</code>构造<code>HSFSpringProviderBean</code>的<code>BeanDefinition</code>，添加到Spring容器中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line">    </span><br><span class="line">        targetClass = <span class="built_in">this</span>.classLoader.loadClass(className);</span><br><span class="line"></span><br><span class="line">        <span class="type">HSFProvider</span> <span class="variable">hsfProvider</span> <span class="operator">=</span> AnnotationUtils.findAnnotation(targetClass, HSFProvider.class);</span><br><span class="line"></span><br><span class="line">        configIfNecessary(hsfProperties);</span><br><span class="line">		<span class="comment">// 通过HsfProviderBeanDefinitionBuilder生成BeanDefinition</span></span><br><span class="line">        <span class="type">HsfProviderBeanDefinitionBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HsfProviderBeanDefinitionBuilder</span>(targetBeanName, hsfProvider)</span><br><span class="line">                .clazz(targetClass)</span><br><span class="line">                .properties(hsfProperties);</span><br><span class="line"></span><br><span class="line">        <span class="type">BeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> builder.build(registry);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (beanDefinition != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (registry.containsBeanDefinition(beanName)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanDefinitionValidationException</span>(</span><br><span class="line">                        <span class="string">&quot;BeanDefinition with the same beanName already existed, please check your config! beanName:&quot;</span></span><br><span class="line">                                + beanName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 向Spring容器注册</span></span><br><span class="line">            registry.registerBeanDefinition(beanName, beanDefinition);</span><br><span class="line">            logger.info(<span class="string">&quot;[HSF Starter] register HSF provider bean: &#123;&#125;, targetClass: &#123;&#125;&quot;</span>, beanName, className);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">// 省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-1-3-HsfProviderBeanDefinitionBuilder"><a href="#1-2-1-3-HsfProviderBeanDefinitionBuilder" class="headerlink" title="1.2.1.3 HsfProviderBeanDefinitionBuilder"></a>1.2.1.3 <code>HsfProviderBeanDefinitionBuilder</code></h4><p><code>HsfProviderBeanDefinitionBuilder#build</code>负责生成<code>HSFSpringProviderBean</code>的<code>BeanDefinition</code>，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">BeanDefinition <span class="title function_">build</span><span class="params">(BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">	<span class="comment">// 省略一些校验代码</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成HSFSpringProviderBean</span></span><br><span class="line">    <span class="type">BeanDefinitionBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> BeanDefinitionBuilder.genericBeanDefinition(HSFSpringProviderBean.class);</span><br><span class="line">    <span class="comment">// 配置初始化方法</span></span><br><span class="line">    builder.setInitMethodName(Constants.INIT_METHOD);</span><br><span class="line">    <span class="comment">// 配置要被注入的属性</span></span><br><span class="line">    builder.addPropertyValue(<span class="string">&quot;serviceInterface&quot;</span>, serviceInterface);</span><br><span class="line">    builder.addPropertyValue(<span class="string">&quot;serviceVersion&quot;</span>, ProviderPropertiesResolver.resolveVersion(annotation, serviceInterface, properties));</span><br><span class="line">    builder.addPropertyValue(<span class="string">&quot;serviceGroup&quot;</span>, ProviderPropertiesResolver.resolveGroup(annotation, serviceInterface, properties));</span><br><span class="line">    builder.addPropertyValue(<span class="string">&quot;serviceName&quot;</span>, annotation.serviceName());</span><br><span class="line">	<span class="comment">// 省略其他属性配置</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 生成BeanDefinition</span></span><br><span class="line">    <span class="keyword">return</span> builder.getBeanDefinition();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-1-4-HSFApiProviderBean"><a href="#1-2-1-4-HSFApiProviderBean" class="headerlink" title="1.2.1.4 HSFApiProviderBean"></a>1.2.1.4 <code>HSFApiProviderBean</code></h4><p>向Spring容器注入<code>HSFSpringProviderBean</code>后，属性配置部分的工作实际上已经完成了。有了配置属性，就可以构造服务的元数据对象<code>ServiceMetaData</code>。</p>
<p><code>HSFApiProviderBean</code>实际上是<code>ServiceMetaData</code>的一层简单封装：</p>
<ol>
<li><p><code>HSFApiProviderBean</code>的构造函数完成<code>ServiceMetaData</code>的构造和属性赋值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">HSFApiProviderBean</span><span class="params">()</span> &#123;</span><br><span class="line">    metadata = <span class="keyword">new</span> <span class="title class_">ServiceMetadata</span>(applicationModel);</span><br><span class="line">    <span class="comment">// 省略metadata属性赋值代码...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>HSFApiProviderBean#init</code>被Spring容器调用后，调用<code>ServiceMetaData#init</code>完成<code>ServiceMetaData</code>的初始化，调用<code>metadata#exportSync</code>完成服务发布</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    initWithoutPub();</span><br><span class="line">    publish();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initWithoutPub</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 避免被初始化多次</span></span><br><span class="line">    <span class="keyword">if</span> (!inited.compareAndSet(<span class="literal">false</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    checkConfig();</span><br><span class="line">	<span class="comment">// 调用metadata#init完成metadata初始化</span></span><br><span class="line">    metadata.init();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">publish</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 省略部分代码</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 调用metadata#exportSync完成服务发布</span></span><br><span class="line">    metadata.exportSync();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="1-2-2-ServiceMetaData初始化"><a href="#1-2-2-ServiceMetaData初始化" class="headerlink" title="1.2.2 ServiceMetaData初始化"></a>1.2.2 <code>ServiceMetaData</code>初始化</h3><p>基本流程：</p>
<ol>
<li><p>进行元数据的预初始化，这一步通过调用<code>ServiceMetadataBeforeInit#beforeInit</code>完成</p>
<p>主要任务是配置应用领域对象<code>Registry</code>和<code>Protocol</code>，用于服务的注册和发现</p>
</li>
<li><p>进行一些组件的配置，通过<code>ServiceComponent#init</code>完成</p>
<p>例如通过<code>MachineRoomRuleComponent</code>订阅机房规则，通过<code>RouteRuleComponent</code>订阅服务路由规则，通过<code>WeightingRuleServiceComponent</code>订阅权重规则，这些规则主要放在<code>Diamond</code>上</p>
</li>
<li><p><strong>关键步骤</strong>：构造<code>protocolInterceptorChain</code>，HSF服务注册发现机制的核心组件</p>
</li>
<li><p><strong>关键步骤</strong>：构造<code>InvocationHandlerChain</code>，HSF调用机制的核心组件</p>
</li>
</ol>
<p><code>ServiceMetaData</code>初始化最主要的任务就是完成两条拦截器链<code>protocolInterceptorChain</code>和<code>invocationHandlerChain</code>的构造，后续服务注册&#x2F;订阅、服务调用的相关能力都是通过拦截器链来实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 防止一个服务被发布多次</span></span><br><span class="line">    <span class="keyword">if</span> (!initFlag.compareAndSet(<span class="literal">false</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 预初始化，目前的实现是配置应用领域对象Registry和Protocol</span></span><br><span class="line">    List&lt;ServiceMetadataBeforeInit&gt; serviceMetadataBeforeInits = applicationModel.getServiceContainer().getInstances(</span><br><span class="line">            ServiceMetadataBeforeInit.class);</span><br><span class="line">    <span class="keyword">for</span> (ServiceMetadataBeforeInit serviceMetadataBeforeInit : serviceMetadataBeforeInits) &#123;</span><br><span class="line">        serviceMetadataBeforeInit.beforeInit(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 进行一些组件的配置，主要是订阅规则</span></span><br><span class="line">    List&lt;ServiceComponent&gt; components = applicationModel.getServiceContainer().</span><br><span class="line">            getInstances(ServiceComponent.class, isProvider ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;provider&quot;</span>&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;consumer&quot;</span>&#125;);</span><br><span class="line">    <span class="keyword">for</span> (ServiceComponent component : components) &#123;</span><br><span class="line">        component.init(<span class="built_in">this</span>);</span><br><span class="line">        componentMap.put(component.name(), component);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 关键：构造Protocol的拦截器链ProtocolInterceptorChain</span></span><br><span class="line">    <span class="keyword">if</span> (protocols.isEmpty()) &#123;</span><br><span class="line">        protocols.addAll(applicationModel.getServiceContainer().getInstances(Protocol.class));</span><br><span class="line">    &#125;</span><br><span class="line">    protocolFilterChain = ProtocolInterceptorChainBuilder.build(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 关键：构造调用链，由InvocationHandler构成</span></span><br><span class="line">    <span class="type">InvocationHandlerFactory</span> <span class="variable">invocationHandlerFactory</span> <span class="operator">=</span> applicationModel.getServiceContainer()</span><br><span class="line">            .getInstance(InvocationHandlerFactory.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (invocationHandlerFactory == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;cannot find one valid implementation for InvocationHandlerFactory&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isProvider()) &#123;</span><br><span class="line">        <span class="comment">// 服务端调用链的拼接</span></span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">serverInvocationHandler</span> <span class="operator">=</span> invocationHandlerFactory.createInvocationHandler(getTarget());</span><br><span class="line">        invocationHandler = InvocationHandlerChainFactory.buildHandlerChain(<span class="built_in">this</span>, serverInvocationHandler);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 客户端调用链的拼接</span></span><br><span class="line">        invocationHandler = InvocationHandlerChainFactory.buildHandlerChain(<span class="built_in">this</span>, consumerHandlerHitch);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//bridge</span></span><br><span class="line">        <span class="type">SyncInvocationHandler</span> <span class="variable">clientSyncInvocationHandler</span> <span class="operator">=</span> invocationHandlerFactory.createSyncInvocationHandler(</span><br><span class="line">                invocationHandler);</span><br><span class="line">        syncInvocationHandler = SyncInvocationHandlerChainFactory</span><br><span class="line">                .buildSyncInvocationHandlerChain(<span class="built_in">this</span>, clientSyncInvocationHandler);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-2-3-其他"><a href="#1-2-3-其他" class="headerlink" title="1.2.3 其他"></a>1.2.3 其他</h3><h4 id="1-2-3-1-客户端的动态代理生成"><a href="#1-2-3-1-客户端的动态代理生成" class="headerlink" title="1.2.3.1 客户端的动态代理生成"></a>1.2.3.1 客户端的动态代理生成</h4><p>对服务调用方（Consumer），<code>APIBean</code>的配置即<code>HSFApiConsumerBean</code>的配置。由于需要生成用于调用对应服务的动态代理对象，<code>HSFApiConsumerBean#init</code>比<code>HSFApiProviderBean#init</code>稍微复杂一些：</p>
<ol>
<li><p>首先通过<code>ServiceMetaData#init</code>初始化<code>metadata</code>；</p>
</li>
<li><p>然后生成对应服务接口的动态代理，并配置到<code>metadata</code>对象中。</p>
<p>后续调用服务接口时，从<code>metadata</code>中取出动态代理用于调用远端服务；</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.taobao.hsf.app.api.util.HSFApiConsumerBean#init()</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	<span class="comment">// 省略部分代码</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (metadata) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!metadata.getBeanInitFlag().compareAndSet(<span class="literal">false</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化metadata对象</span></span><br><span class="line">        metadata.init();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 关键步骤：生成服务接口的动态代理，并配置到metadata中</span></span><br><span class="line">            <span class="comment">// 后续调用服务接口时，取出target对象用于RPC调用</span></span><br><span class="line">            metadata.setTarget(consume(metadata));</span><br><span class="line">            LOGGER.info(<span class="string">&quot;generate proxy successfully for &quot;</span> + metadata.getUniqueName());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			<span class="comment">// 省略</span></span><br><span class="line">        &#125;</span><br><span class="line">		</span><br><span class="line">        <span class="comment">// 省略</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>HSF默认使用JDK动态代理机制，基本流程：</p>
<ol>
<li><p>首先从缓存中查找服务实例，如果存在直接返回，避免重复创建</p>
</li>
<li><p>生成调用远程HSF服务的代理</p>
<ul>
<li>根据<code>ProxyDecoratorGenerator#getDecorateInterfaces</code>获取代理类实现的接口。HSF默认提供3种<code>ProxyDecoratorGenerator</code>的实现类<ul>
<li><code>BizInterfaceDecorator</code>：远端服务的接口</li>
<li><code>EchoInterfaceDecorator</code>：<code>EchoService</code>，应该是用于echo测试用</li>
<li><code>GenericInterfaceDecorator</code>：<code>GenericService</code>，用于支持泛化调用（不依赖二方包，传入需要调用的方法名，方法签名和参数值进行调用服务）</li>
</ul>
</li>
<li><strong>关键步骤</strong>：通过<code>ProxyFactory#getProxy</code>生成代理类对象</li>
</ul>
</li>
<li><p>生成<code>ConsumerServiceModel</code>，其中包含每个接口方法对象<code>Method</code>对应的<code>ConsumerMethodModel</code>对象，封装了方法的各类信息</p>
</li>
<li><p>通过<code>ApplicationModel#initConsumerService</code>向当前应用添加服务全限定名与消费服务</p>
</li>
<li><p><strong>关键步骤</strong>：通过<code>ServiceMetaData#referSync</code>进行订阅</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.taobao.hsf.app.api.util.HSFApiConsumerBean#consume</span></span><br><span class="line"><span class="keyword">private</span> Object <span class="title function_">consume</span><span class="params">(<span class="keyword">final</span> ServiceMetadata metadata)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 首先从缓存中查找服务实例，如果存在直接返回，避免重复创建</span></span><br><span class="line">    <span class="keyword">if</span> (applicationModel.getConsumedServiceModel(metadata.getUniqueName()) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> applicationModel.getConsumedServiceModel(metadata.getUniqueName()).getProxyObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 生成调用远程HSF服务的代理</span></span><br><span class="line">    <span class="comment">// 2.1 获得代理类需要实现的接口</span></span><br><span class="line">    <span class="type">ProxyDecoratorGenerator</span> <span class="variable">proxyDecoratorGenerator</span> <span class="operator">=</span> HSFServiceContainer.getInstance(</span><br><span class="line">            ProxyDecoratorGenerator.class);</span><br><span class="line">    Class&lt;?&gt;[] decorateInterfaces = proxyDecoratorGenerator.getDecorateInterfaces(metadata);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.2 通过ProxyFactory#getProxy生成代理类对象</span></span><br><span class="line">    <span class="type">ProxyFactory</span> <span class="variable">proxyFactory</span> <span class="operator">=</span> HSFServiceContainer.getInstance(ProxyFactory.class, metadata.getProxyStyle());</span><br><span class="line">    <span class="type">Object</span> <span class="variable">proxy</span> <span class="operator">=</span> proxyFactory.getProxy(metadata, decorateInterfaces);</span><br><span class="line">    Method[] methods = proxyFactory.getMethods(proxy);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 生成ConsumerServiceModel，包含方法信息</span></span><br><span class="line">    <span class="type">ConsumerServiceModel</span> <span class="variable">consumerServiceModel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConsumerServiceModel</span>(metadata, proxy, methods);</span><br><span class="line">    metadata.setConsumerServiceModel(consumerServiceModel);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 4. 向当前应用添加服务全限定名与消费服务</span></span><br><span class="line">    <span class="comment">//TODO 这里是client的注册，这里应该生成RPCClient</span></span><br><span class="line">    applicationModel.initConsumerService(metadata.getUniqueName(), consumerServiceModel);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 进行服务订阅</span></span><br><span class="line">    metadata.referSync();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> proxy;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><code>ProxyFactory</code>的默认实现类是<code>JdkProxyFactory</code>，内部通过JDK动态代理机制生成<code>Proxy</code>，对应的<code>ProxyHandler</code>为<code>JdkProxyInvocationHandler</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.taobao.hsf.proxy.JdkProxyFactory#getProxy</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">getProxy</span><span class="params">(ServiceMetadata metadata, Class&lt;?&gt;... interfacesArray)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">JdkProxyInvocationHandler</span> <span class="variable">jdkProxyInvocationHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdkProxyInvocationHandler</span>(metadata);</span><br><span class="line">        <span class="comment">// JDK动态代理</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> Proxy.newProxyInstance(metadata.getIfClazz().getClassLoader(), interfacesArray, jdkProxyInvocationHandler);</span><br><span class="line">        jdkProxyInvocationHandler.init(instance);</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">HSFException</span>(<span class="string">&quot;failed to generate jdk proxy&quot;</span>,t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>JdkProxyInvocationHandler#invoke</code>就是HSF调用的核心实现入口，它调用<code>InvocationUtil#invoke</code>完成HSF一次调用的工作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(<span class="keyword">final</span> Object proxy, <span class="keyword">final</span> Method method, <span class="keyword">final</span> Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    ApplicationModelFactory.setCurrentApplication(serviceMetadata.getApplicationModel());</span><br><span class="line">	<span class="comment">// 获得方法对应的ConsumerMethodModel，在HSFApiConsumerBean#consume中设置</span></span><br><span class="line">    <span class="type">ConsumerMethodModel</span> <span class="variable">methodModel</span> <span class="operator">=</span> serviceMetadata.getConsumerServiceModel().getMethodModel(method);</span><br><span class="line">    <span class="comment">// 开始一次调用过程</span></span><br><span class="line">    <span class="keyword">return</span> InvocationUtil.invoke(methodModel, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="2-服务领域1-调用层"><a href="#2-服务领域1-调用层" class="headerlink" title="2 服务领域1 - 调用层"></a>2 服务领域1 - 调用层</h1><p>服务领域从上往下涵盖了<code>InvocationHandler</code>（调用层）、<code>Router</code>（路由）和<code>LoadBlance</code>（负载均衡）三层。在服务领域内，一次客户端调用从开始，经过由<code>InvocationHandler</code>组成的调用链完成调用层的处理，然后交给<code>Router</code>做路由选址，选址完成后交给<code>LoadBlance</code>在选址结果中做负载均衡选出一个地址发起远程调用。</p>
<p><a class="simple-lightbox" target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/jffu/jffu-blog-images@main/img/FpPMp5h1KOMSWjpRsoFmWkBI83mv.png"><img   src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/jffu/jffu-blog-images@main/img/FpPMp5h1KOMSWjpRsoFmWkBI83mv.png"  lazyload></a></p>
<h2 id="2-1-调用层设计"><a href="#2-1-调用层设计" class="headerlink" title="2.1 调用层设计"></a>2.1 调用层设计</h2><h3 id="2-1-1-设计理念"><a href="#2-1-1-设计理念" class="headerlink" title="2.1.1 设计理念"></a>2.1.1 设计理念</h3><p>HSF使用了<code>InvocationHandler</code>接口表示对一个请求<code>Invocation</code>进行处理使用的处理器，处理完成返回一个异步的结果对象<code>ListenableFuture&lt;RPCResult&gt;</code>。</p>
<p>由于对请求的处理可能五花八门，处理的过程设计成异步流水线模式，流水线处理对应<code>InvocationHandler</code>链的调用，链上的每个<code>InvocationHandler</code>节点根据业务逻辑进行对应的处理，然后交给下一个节点。</p>
<p><strong>服务端的调用处理器链：</strong></p>
<p>以HSF服务端为例，在初始化完成后，它的链结构如下：</p>
<p><a class="simple-lightbox" target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/jffu/jffu-blog-images@main/img/FkbJmR1oDHJzuZIxaRVBTDPiJb4L.png"><img   src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/jffu/jffu-blog-images@main/img/FkbJmR1oDHJzuZIxaRVBTDPiJb4L.png"  lazyload></a><br>每个<code>InvocationHandler</code>各司其职：</p>
<ul>
<li><code>ServerContextInvocationHandler</code>：在服务处理阶段，首先将服务对应的应用信息<code>ApplicationModel</code>设置到线程上下文，后面的<code>InvocationHandler</code>可以从上下文中获得应用信息；</li>
<li><code>FilterInvocationHandler</code>：构造扩展的服务端过滤器<code>RPCFilter</code>链</li>
<li><code>ReflectInvocationHandler</code>：最终完成反射调用服务端方法</li>
</ul>
<p><strong>客户端的调用处理器链：</strong></p>
<p>客户端的处理器链结构比服务端复杂，由于要支持异步调用，构造时首先构造了异步的调用执行器链，然后将异步调用链拼装到同步调用链的尾部。中间通过<code>AsyncToSyncInvocationHandler</code>桥接。<br><a class="simple-lightbox" target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/jffu/jffu-blog-images@main/img/FqUrqBtVBMK4q2J0YyM3cz5i8Jzi.png"><img   src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/jffu/jffu-blog-images@main/img/FqUrqBtVBMK4q2J0YyM3cz5i8Jzi.png"  lazyload></a></p>
<h3 id="2-1-2-主要类"><a href="#2-1-2-主要类" class="headerlink" title="2.1.2 主要类"></a>2.1.2 主要类</h3><ul>
<li><p><code>Invocation</code>：代表一次调用请求，封装了调用请求的各类信息；</p>
</li>
<li><p><code>RPCResult</code>：代表调用结果，封装了返回响应等数据；</p>
</li>
<li><p><code>ListenableFuture</code>：异步结果，扩展了<code>Future</code>，加入监听器回调能力；</p>
</li>
<li><p><code>InvocationHandler</code>：调用处理器，对<code>Invocation</code>处理后返回<code>ListenableFuture&lt;RPCResult&gt;</code>，表示一次调用的异步结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">     * 调用，发送请求</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> invocation 请求</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 异步计算结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Throwable 异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ListenableFuture&lt;RPCResult&gt; <span class="title function_">invoke</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>InvocationHandlerInterceptor</code>：调用处理器链上的节点类型为<code>InvocationHandlerInterceptor</code>，它继承了<code>InvocationHandler</code>接口，提供设置下一个<code>InvocationHandler</code>的能力。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Scope(Scope.Option.PROTOTYPE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">InvocationHandlerInterceptor</span> <span class="keyword">extends</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置调用处理器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> invocationHandler 调用处理器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setInvocationHandler</span><span class="params">(InvocationHandler invocationHandler)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><a class="simple-lightbox" target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/jffu/jffu-blog-images@main/img/FhLhHkUjFAwzXIojIDv8OQvyoCGC.png"><img   src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/jffu/jffu-blog-images@main/img/FhLhHkUjFAwzXIojIDv8OQvyoCGC.png"  lazyload></a></p>
<h2 id="2-2-扩展机制"><a href="#2-2-扩展机制" class="headerlink" title="2.2 扩展机制"></a>2.2 扩展机制</h2><p>HSF在调用层增加扩展的过滤器<code>RPCFilter</code>，支持对请求进行自定义处理，在服务端和客户端分别对应<code>ServerFilter</code>和<code>ClientFilter</code>。</p>
<blockquote>
<p>对于一次调用，发起请求阶段会经过<code>RPCFilter.invoke</code>方法，它能拦截住HSF的请求。当请求发送到远端完成处理之后，数据被写回，当响应到客户端后，将会调用<code>RPCFilter.onResponse</code>方法，因为请求<code>Invocation</code>在发起后会被记录，所以处理响应的线程会拿着当次调用的请求<code>Invocation</code>和远端的响应<code>RPCResult</code>调用<code>RPCFilter.onResponse</code>方法。</p>
</blockquote>
<p><a class="simple-lightbox" target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/jffu/jffu-blog-images@main/img/Fj1GlncpSYpoFGhr99OJKwVhTq4A.png"><img   src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/jffu/jffu-blog-images@main/img/Fj1GlncpSYpoFGhr99OJKwVhTq4A.png"  lazyload></a><br><code>ServerFilter</code>和<code>ClientFilter</code>同样也是链式的。在拼装<code>InvocationHandler</code>链时，服务端和客户端都有一个<code>FilterInvocationHandler</code>节点。它实现了<code>LifeCycle</code>接口，其<code>start()</code>方法会被回调然后调用<code>RPCFilterBuilder#buildInvokerChain</code>拼装扩展过滤器链。</p>
<h2 id="2-3-代码流程"><a href="#2-3-代码流程" class="headerlink" title="2.3 代码流程"></a>2.3 代码流程</h2><h3 id="2-3-1-调用链拼接"><a href="#2-3-1-调用链拼接" class="headerlink" title="2.3.1 调用链拼接"></a>2.3.1 调用链拼接</h3><h4 id="2-3-1-1-通用流程"><a href="#2-3-1-1-通用流程" class="headerlink" title="2.3.1.1 通用流程"></a>2.3.1.1 通用流程</h4><p>在配置领域配置<code>APIBean</code>并初始化服务元数据<code>ServiceMetaData</code>时，在<code>ServiceMetaData#init</code>中调用<code>com.taobao.hsf.invocation.InvocationHandlerChainFactory#buildHandlerChain</code>完成了<code>InvocationHandler</code>链<code>InvocationHandlerChain</code>的初始化。</p>
<p>HSF代码中存在很多类似的链式结构，初始化过程大体相似：</p>
<ol>
<li>通过SPI加载对应处理器（或者说拦截器）接口的所有实现类，对<code>InvocationHandler</code>链是<code>InvocationHandlerInterceptor</code>，顺序由<code>@Order</code>注解指定；</li>
<li>串联各个实现类成一条链</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> InvocationHandler <span class="title function_">buildHandlerChain</span><span class="params">(ServiceMetadata metadata, InvocationHandler invocationHandler)</span> &#123;</span><br><span class="line">    <span class="number">1.</span> 通过SPI加装InvocationHandlerInterceptor实现类列表</span><br><span class="line">    List&lt;InvocationHandlerInterceptor&gt; handlers;</span><br><span class="line">    <span class="keyword">if</span> (metadata.isProvider()) &#123;</span><br><span class="line">        handlers = HSFServiceContainer.getInstances(InvocationHandlerInterceptor.class, <span class="string">&quot;server&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        handlers = HSFServiceContainer.getInstances(InvocationHandlerInterceptor.class, <span class="string">&quot;client&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 进行串联</span></span><br><span class="line">    <span class="type">InvocationHandler</span> <span class="variable">last</span> <span class="operator">=</span> invocationHandler;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> handlers.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">InvocationHandlerInterceptor</span> <span class="variable">handler</span> <span class="operator">=</span> handlers.get(i);</span><br><span class="line"></span><br><span class="line">        handler.setInvocationHandler(last);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (handler <span class="keyword">instanceof</span> ServiceMetadataAware) &#123;</span><br><span class="line">            ((ServiceMetadataAware) handler).setServiceMetadata(metadata);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (handler <span class="keyword">instanceof</span> LifeCycle) &#123;</span><br><span class="line">            ((LifeCycle) handler).start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        last = handler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> last;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-1-2-客户端拼接1：初始化阶段"><a href="#2-3-1-2-客户端拼接1：初始化阶段" class="headerlink" title="2.3.1.2 客户端拼接1：初始化阶段"></a>2.3.1.2 客户端拼接1：初始化阶段</h4><p>由于客户端需要支持异步调用，它在拼接时会有两条调用链结构，参考<code>ServiceMetadata#init</code>中的拼接部分代码：</p>
<ol>
<li>构造异步调用链<code>invocationHandler</code></li>
<li>构造桥接对象<code>clientSyncInvocationHandler</code>，类型是<code>AsyncToSyncInvocationHandler</code>，后面拼接异步调用链</li>
<li>构造同步调用链，并将桥接对象拼接在同步调用链之后</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.taobao.hsf.model.metadata.ServiceMetadata#init</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 构造异步处理器链invocationHandler</span></span><br><span class="line">invocationHandler = InvocationHandlerChainFactory.buildHandlerChain(<span class="built_in">this</span>, consumerHandlerHitch);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 构造桥接对象，后面拼接异步调用链</span></span><br><span class="line"><span class="type">SyncInvocationHandler</span> <span class="variable">clientSyncInvocationHandler</span> <span class="operator">=</span> invocationHandlerFactory.createSyncInvocationHandler(</span><br><span class="line">        invocationHandler);</span><br><span class="line"><span class="comment">// 3. 构造同步调用链，并将桥接对象拼接在同步调用链之后</span></span><br><span class="line">syncInvocationHandler = SyncInvocationHandlerChainFactory</span><br><span class="line">        .buildSyncInvocationHandlerChain(<span class="built_in">this</span>, clientSyncInvocationHandler);</span><br></pre></td></tr></table></figure>

<h4 id="2-3-1-3-客户端拼接2：订阅阶段"><a href="#2-3-1-3-客户端拼接2：订阅阶段" class="headerlink" title="2.3.1.3 客户端拼接2：订阅阶段"></a>2.3.1.3 客户端拼接2：订阅阶段</h4><p>在<code>ServiceMetadata#init</code>中只完成部分客户端调用链的拼接，还缺少几部分，需要在订阅阶段通过<code>protocolFilterChain</code>链上特定节点的<code>Protocol#refer</code>方法构建并拼接上：</p>
<ol>
<li><p>发起远程调用使用的<code>RemotingRPCProtocolComponent</code>。HSF提供灵活的扩展机制，不同的RPC机制（HSF、Dubbo）可以使用不同的调用逻辑，远程调用处理器的拼接放在在服务订阅时触发；</p>
<p>默认情况下，<code>RemotingRPCProtocolComponent</code>由<code>HSFProtol</code>生成：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> InvocationHandler <span class="title function_">refer</span><span class="params">(ServiceMetadata serviceMetadata)</span> &#123;</span><br><span class="line">    <span class="comment">// 通过查找名称为HSF的InvocationHandler加载到RemotingRPCProtocolComponent</span></span><br><span class="line">    <span class="keyword">return</span> HSFServiceContainer.getInstance(InvocationHandler.class, <span class="string">&quot;HSF&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Scope(Scope.Option.PROTOTYPE)</span></span><br><span class="line"><span class="meta">@Name(&quot;HSF&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemotingRPCProtocolComponent</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span>, ApplicationModelAware &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>扩展过滤器<code>RPCFilter</code>链。<code>RPCFilter</code>需要被整合到调用处理器中，因此每个<code>RPCFilter</code>都需要被转换成为<code>InvocationHandler</code>，这一步在<code>FilterInvocationHandler#refer</code>中完成；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Order(501)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FilterProtocolInterceptor</span> <span class="keyword">extends</span> <span class="title class_">AbstractDelegateProtocolInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> InvocationHandler <span class="title function_">refer</span><span class="params">(ServiceMetadata serviceMetadata)</span> &#123;</span><br><span class="line">        <span class="comment">// 这里返回的是已经经由HSFProtocol添加的RemotingRPCProtocolComponent</span></span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">invocationHandler</span> <span class="operator">=</span>  protocol.refer(serviceMetadata);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">filterInvocationHandler</span> <span class="operator">=</span> RPCAfterFilterBuilder.buildInvokerChain(invocationHandler, serviceMetadata,<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> filterInvocationHandler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>注册中心配套的<code>InvocationHandler</code>，即<code>RegistryInvocationHandler</code>。由于需要将服务的元信息注册到对应的注册中心上，因此也是在订阅阶段拼接上去，在<code>com.taobao.hsf.registry.RegistryProtocolInterceptor#refer</code>中完成。</p>
</li>
</ol>
<p>订阅阶段的拼接通过<code>protocolFilterChain#refer</code>生成的<code>InvocationHandler</code>被串在了初始化阶段的调用链尾部，最终形成的客户端调用链如下：</p>
<p><a class="simple-lightbox" target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/jffu/jffu-blog-images@main/img/FmVRXic1XBK21Yrs--LFCSb2u8wl.png"><img   src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/jffu/jffu-blog-images@main/img/FmVRXic1XBK21Yrs--LFCSb2u8wl.png"  lazyload></a></p>
<blockquote>
<p>从同步调用链到异步调用链，经历了<code>ClientFilter</code>的层层过滤，最终通过<code>RegistryInvocationHandler</code>完成选址，由<code>RemotingRPCProtocolComponent</code>发起远程数据传输。</p>
</blockquote>
<h3 id="2-3-2-客户端调用"><a href="#2-3-2-客户端调用" class="headerlink" title="2.3.2 客户端调用"></a>2.3.2 客户端调用</h3><p>参考配置领域初始化，在每个服务元数据对象<code>ServiceMetadata</code>初始化调用<code>ServiceMetadata#init</code>时，会生成服务接口的动态代理。调用时，通过<code>InvocationUtil#invoke</code>作为入口开始对请求进行处理。真正的处理流程交给上一阶段拼接好的调用链。基本流程：</p>
<ol>
<li>根据请求方法、参数等信息构造请求对象<code>Invocation</code>；</li>
<li>获得<code>metadata</code>上的<code>InvocationHandler</code>链，交给<code>InvocationHandler</code>链处理请求，默认情况下，调用是同步的，所以获取的是<code>SyncInvocationHandler</code>；</li>
<li>获取和处理响应</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.taobao.hsf.InvocationUtil#invoke</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">invoke</span><span class="params">(ConsumerMethodModel methodModel, Object... args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="comment">// 1. 根据请求方法、参数等信息构造请求对象Invocation</span></span><br><span class="line">    <span class="type">Invocation</span> <span class="variable">invocation</span> <span class="operator">=</span> InvocationUtil.buildInvocation(methodModel, args);</span><br><span class="line">    <span class="comment">// 2. 获得metadata上的InvocationHandler链，交给InvocationHandler链处理</span></span><br><span class="line">    <span class="type">RPCResult</span> <span class="variable">rpcResult</span> <span class="operator">=</span> methodModel.getMetadata().getSyncInvocationHandler().invoke(invocation);</span><br><span class="line">    <span class="comment">// 3. 获取和处理响应</span></span><br><span class="line">    <span class="type">HSFResponse</span> <span class="variable">hsfResp</span> <span class="operator">=</span> rpcResult.getHsfResponse();</span><br><span class="line">    <span class="comment">// 异常处理</span></span><br><span class="line">    <span class="keyword">if</span> (hsfResp.isError()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (hsfResp.getAppResponse() <span class="keyword">instanceof</span> Throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">HSFException</span>(hsfResp.getErrorMsg(), (Throwable) hsfResp.getAppResponse());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">HSFException</span>(hsfResp.getErrorMsg());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Object</span> <span class="variable">appResponse</span> <span class="operator">=</span> hsfResp.getAppResponse();</span><br><span class="line">    <span class="comment">// 检查对端返回的业务层对象: 如果返回的是异常对象，则重新抛出异常</span></span><br><span class="line">    <span class="keyword">if</span> (appResponse <span class="keyword">instanceof</span> Throwable) &#123;</span><br><span class="line">        <span class="keyword">throw</span> (Throwable) appResponse;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> hsfResp.getAppResponse();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>调用链上有几个重要的节点：</p>
<ul>
<li><code>SyncInvocationHandler</code>：调用链的起点（同步调用），从这里开始对请求进行同步调用拦截处理，使用<code>SyncInvocationHandlerInterceptor</code>；</li>
<li><code>AsyncToSyncInvocationHandler</code>：同步和异步调用链间的桥接，完成同步转异步的过程；</li>
<li><code>FilterInvocationHandler</code>：扩展<code>RPCFilter</code>的起点；</li>
<li><code>RegistryInvocationHandler</code>：根据请求完成路由选址，最终选择出一个调用地址；</li>
<li><code>RemotingRPCProtocolComponent</code>：最终发起远程调用，通过<code>ClientStream</code>完成数据写出；</li>
</ul>
<p><a class="simple-lightbox" target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/jffu/jffu-blog-images@main/img/FtEi1L9sP_5A0Ek30peNgDHqMRZz.png"><img   src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/jffu/jffu-blog-images@main/img/FtEi1L9sP_5A0Ek30peNgDHqMRZz.png"  lazyload></a></p>
<h3 id="2-3-3-服务端调用"><a href="#2-3-3-服务端调用" class="headerlink" title="2.3.3 服务端调用"></a>2.3.3 服务端调用</h3><p>在网络层收到RPC请求后，经过解码、反序列化，会交给服务端处理请求的连接池。对服务领域，请求处理的入口是<code>com.taobao.hsf.remoting.provider.ProviderProcessor#handleRequest</code>。在这之前，客户端请求已经被封装为<code>Invocation</code>对象。</p>
<p><code>ProviderProcessor#handleRequest</code>的主要工作就是调用服务端的调用链，由于调用链返回的是一个异步结果<code>ListenableFuture&lt;RPCResult&gt;</code>，需要设置监听器回调。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ProviderProcessor#handleRequest</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ResponseStatus <span class="title function_">handleRequest</span><span class="params">(Invocation invocation, Output output)</span> &#123;</span><br><span class="line">	<span class="comment">// 省略次要代码</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 服务端调用链的调用，返回异步结果</span></span><br><span class="line">    ListenableFuture&lt;RPCResult&gt; rpcFuture = providerMetadata.getInvocationHandler().invoke(invocation);</span><br><span class="line">    <span class="comment">// 设置异步结果的回调</span></span><br><span class="line">    rpcFuture.addListener(<span class="keyword">new</span> <span class="title class_">OutputCallback</span>(invocation, rpcFuture, output));</span><br><span class="line">    <span class="comment">// 返回</span></span><br><span class="line">    <span class="keyword">return</span> invocation.getResponseStatus();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>服务端调用链的调用流程在原理上与客户端类似，经过一系列扩展过滤器<code>ServerFilter</code>之后，请求到达最终的<code>ReflectInvocationHandler</code>，在其中完成反射调用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ListenableFuture&lt;RPCResult&gt; <span class="title function_">invoke</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">	<span class="comment">// 省略次要代码</span></span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 反射调用，生成响应</span></span><br><span class="line">    <span class="type">HSFResponse</span> <span class="variable">hsfResponse</span> <span class="operator">=</span> handleRequest0(invocation, invocation.getHsfRequest(), defaultRPCFuture);</span><br><span class="line">    <span class="keyword">if</span> (hsfResponse == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> defaultRPCFuture;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">RPCResult</span> <span class="variable">rpcResult</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RPCResult</span>();</span><br><span class="line">    rpcResult.setHsfResponse(hsfResponse);</span><br><span class="line"></span><br><span class="line">    defaultRPCFuture.set(rpcResult);</span><br><span class="line">    <span class="keyword">return</span> defaultRPCFuture;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> HSFResponse <span class="title function_">handleRequest0</span><span class="params">(Invocation invocation, <span class="keyword">final</span> HSFRequest hsfRequest, SettableFuture&lt;RPCResult&gt; defaultRPCFuture)</span> &#123;</span><br><span class="line">	<span class="comment">// 精简次要代码</span></span><br><span class="line"></span><br><span class="line">    <span class="type">ProviderServiceModel</span> <span class="variable">serviceModel</span> <span class="operator">=</span> invocation.getServerInvocationContext().getServiceModel();</span><br><span class="line">    <span class="type">ProviderMethodModel</span> <span class="variable">methodModel</span> <span class="operator">=</span> invocation.getServerInvocationContext().getMethodModel();</span><br><span class="line"></span><br><span class="line">    <span class="type">HSFResponse</span> <span class="variable">hsfResponse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HSFResponse</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">remoteHost</span> <span class="operator">=</span> invocation.getPeerIP();</span><br><span class="line">    <span class="type">ClassLoader</span> <span class="variable">tcl</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line">    <span class="type">Method</span> <span class="variable">workerMethod</span> <span class="operator">=</span> methodModel.getMethod();</span><br><span class="line">    <span class="type">String</span> <span class="variable">clientAppName</span> <span class="operator">=</span> getAppNameOfClient(hsfRequest);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">Method</span> <span class="variable">injectIpMethod</span> <span class="operator">=</span> serviceModel.getInjectConsumerIpMethod();</span><br><span class="line">    <span class="keyword">if</span> (injectIpMethod != <span class="literal">null</span>) &#123;</span><br><span class="line">        injectConsumerIp(injectIpMethod, serviceModel.getServiceInstance(), remoteHost);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Object[] methodArgs = hsfRequest.getMethodArgs();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用业务应用时，切换为应用class loader</span></span><br><span class="line">    ClassLoaderUtil.switchContextLoader(serviceModel.getMetadata().getServicePojoClassLoader());</span><br><span class="line">    <span class="comment">// 反射调用</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">appResp</span> <span class="operator">=</span> workerMethod.invoke(serviceModel.getServiceInstance(), methodArgs);</span><br><span class="line"></span><br><span class="line">    hsfResponse.setAppResponse(appResp);</span><br><span class="line">    <span class="keyword">return</span> hsfResponse;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a class="simple-lightbox" target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/jffu/jffu-blog-images@main/img/FjwAG-oGTgUAslzBTkSelk8jRwgS.png"><img   src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/jffu/jffu-blog-images@main/img/FjwAG-oGTgUAslzBTkSelk8jRwgS.png"  lazyload></a></p>
<h1 id="3-服务领域2-路由"><a href="#3-服务领域2-路由" class="headerlink" title="3 服务领域2 - 路由"></a>3 服务领域2 - 路由</h1><h2 id="3-1-设计"><a href="#3-1-设计" class="headerlink" title="3.1 设计"></a>3.1 设计</h2><h3 id="3-1-1-设计框架"><a href="#3-1-1-设计框架" class="headerlink" title="3.1.1 设计框架"></a>3.1.1 设计框架</h3><p>整个HSF框架中，客户端（Consumer）的设计远比服务端要复杂。<code>Router</code>的设计是客户端调用的核心（如果不需要路由选址，那客户端的实现可以变得很简单）。路由设计中需要考虑一系列问题：</p>
<ol>
<li>每个服务的路由规则是不是都一样？</li>
<li>服务生命周期中，路由规则是不是不会改变？</li>
<li>如果需要自定义路由规则，该如何扩展？</li>
<li>等等…</li>
</ol>
<p>HSF通过由一系列<code>Router</code>实现类构成的树状路由结构来进行灵活的路由服务。</p>
<p><code>Router</code>的两个关键用途：</p>
<ul>
<li><p>地址切分</p>
<p>在收到<code>Registry</code>层推送的订阅地址列表时，<code>Router</code>会进行一次地址切分，<code>Router</code>链的节点上依次计算，每个节点都会留存一些计算的结果，并将计算的结果再次通知到后继节点。</p>
<p>地址切分是地址选择的前置步骤，切分后每个<code>Router</code>节点在后续调用进行路由选择时，只需要根据当前保存的地址进行处理。</p>
</li>
<li><p>地址选择</p>
<p>请求的地址选择。</p>
</li>
</ul>
<p><code>Router</code>链的结构：</p>
<ol>
<li><code>HeadRouter</code>是路由链的头节点，前面对接了<code>Registry</code>层的<code>AddressListener</code>链，请求从<code>HeadRouter</code>开始路由；</li>
<li><code>TailRouter</code>是路由链的尾节点，后面对接了<code>LoadBalancer</code>进行负载均衡，请求到<code>TailRouter</code>完成了路由选址；</li>
<li>除了<code>TailRouter</code>，其他<code>Router</code>节点可能有多个后继节点，每个节点根据路由规则：<ul>
<li>拦截返回地址</li>
<li>选择后继中的一个<code>Router</code>进行选址</li>
</ul>
</li>
</ol>
<p><a class="simple-lightbox" href="data:image/svg+xml;utf8,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22us-ascii%22%20standalone%3D%22no%22%3F%3E%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20contentStyleType%3D%22text%2Fcss%22%20height%3D%22483px%22%20preserveAspectRatio%3D%22none%22%20style%3D%22width%3A610px%3Bheight%3A483px%3Bbackground%3A%23FFFFFF%3B%22%20version%3D%221.1%22%20viewBox%3D%220%200%20610%20483%22%20width%3D%22610px%22%20zoomAndPan%3D%22magnify%22%3E%3Cdefs%2F%3E%3Cg%3E%3Cg%20id%3D%22elem_HeadRouter%22%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2246.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22123%22%20x%3D%22244%22%20y%3D%227%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2210%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2215%22%20x%3D%22347%22%20y%3D%2212%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22345%22%20y%3D%2214%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22345%22%20y%3D%2218%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2283%22%20x%3D%22259%22%20y%3D%2239.9951%22%3EHeadRouter%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_Router1.1%22%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2246.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22109%22%20x%3D%22172%22%20y%3D%22113%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2210%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2215%22%20x%3D%22261%22%20y%3D%22118%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22259%22%20y%3D%22120%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22259%22%20y%3D%22124%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2269%22%20x%3D%22187%22%20y%3D%22145.9951%22%3ERouter1.1%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_Router1.2%22%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2246.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22109%22%20x%3D%22330%22%20y%3D%22113%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2210%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2215%22%20x%3D%22419%22%20y%3D%22118%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22417%22%20y%3D%22120%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22417%22%20y%3D%22124%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2269%22%20x%3D%22345%22%20y%3D%22145.9951%22%3ERouter1.2%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_Router2.1%22%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2246.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22109%22%20x%3D%2221%22%20y%3D%22219%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2210%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2215%22%20x%3D%22110%22%20y%3D%22224%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22108%22%20y%3D%22226%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22108%22%20y%3D%22230%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2269%22%20x%3D%2236%22%20y%3D%22251.9951%22%3ERouter2.1%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_Router2.2%22%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2246.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22109%22%20x%3D%22172%22%20y%3D%22219%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2210%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2215%22%20x%3D%22261%22%20y%3D%22224%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22259%22%20y%3D%22226%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22259%22%20y%3D%22230%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2269%22%20x%3D%22187%22%20y%3D%22251.9951%22%3ERouter2.2%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_Router2.3%22%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2246.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22109%22%20x%3D%22330%22%20y%3D%22219%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2210%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2215%22%20x%3D%22419%22%20y%3D%22224%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22417%22%20y%3D%22226%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22417%22%20y%3D%22230%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2269%22%20x%3D%22345%22%20y%3D%22251.9951%22%3ERouter2.3%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_Router2.4%22%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2246.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22109%22%20x%3D%22481%22%20y%3D%22219%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2210%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2215%22%20x%3D%22570%22%20y%3D%22224%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22568%22%20y%3D%22226%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22568%22%20y%3D%22230%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2269%22%20x%3D%22496%22%20y%3D%22251.9951%22%3ERouter2.4%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_TailRouter.1%22%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2246.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22123%22%20x%3D%227%22%20y%3D%22325%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2210%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2215%22%20x%3D%22110%22%20y%3D%22330%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22108%22%20y%3D%22332%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22108%22%20y%3D%22336%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2283%22%20x%3D%2222%22%20y%3D%22357.9951%22%3ETailRouter.1%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_TailRouter.2%22%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2246.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22123%22%20x%3D%22165%22%20y%3D%22325%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2210%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2215%22%20x%3D%22268%22%20y%3D%22330%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22266%22%20y%3D%22332%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22266%22%20y%3D%22336%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2283%22%20x%3D%22180%22%20y%3D%22357.9951%22%3ETailRouter.2%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_TailRouter.3%22%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2246.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22123%22%20x%3D%22323%22%20y%3D%22325%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2210%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2215%22%20x%3D%22426%22%20y%3D%22330%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22424%22%20y%3D%22332%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22424%22%20y%3D%22336%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2283%22%20x%3D%22338%22%20y%3D%22357.9951%22%3ETailRouter.3%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_TailRouter.4%22%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2246.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22123%22%20x%3D%22481%22%20y%3D%22325%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2210%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2215%22%20x%3D%22584%22%20y%3D%22330%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22582%22%20y%3D%22332%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22582%22%20y%3D%22336%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2283%22%20x%3D%22496%22%20y%3D%22357.9951%22%3ETailRouter.4%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_LoadBalancer%22%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2246.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22133%22%20x%3D%22239%22%20y%3D%22431%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2210%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2215%22%20x%3D%22352%22%20y%3D%22436%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22350%22%20y%3D%22438%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22350%22%20y%3D%22442%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2293%22%20x%3D%22254%22%20y%3D%22463.9951%22%3ELoadBalancer%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22link_HeadRouter_Router1.1%22%3E%3Cpath%20d%3D%22M288.746%2C53.056%20C275.34%2C70.705%20260.2593%2C90.5571%20246.8593%2C108.1981%20%22%20fill%3D%22none%22%20id%3D%22HeadRouter-to-Router1.1%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22243.23%2C112.976%2C251.8592%2C108.2287%2C246.2544%2C108.9944%2C245.4886%2C103.3896%2C243.23%2C112.976%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22link_HeadRouter_Router1.2%22%3E%3Cpath%20d%3D%22M322.254%2C53.056%20C335.66%2C70.705%20350.7407%2C90.5571%20364.1407%2C108.1981%20%22%20fill%3D%22none%22%20id%3D%22HeadRouter-to-Router1.2%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22367.77%2C112.976%2C365.5114%2C103.3896%2C364.7456%2C108.9944%2C359.1408%2C108.2287%2C367.77%2C112.976%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22link_Router1.1_Router2.1%22%3E%3Cpath%20d%3D%22M194.477%2C159.056%20C168.852%2C176.705%20138.0314%2C197.9316%20112.4184%2C215.5726%20%22%20fill%3D%22none%22%20id%3D%22Router1.1-to-Router2.1%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22107.477%2C218.976%2C117.158%2C217.1652%2C111.5948%2C216.1399%2C112.6201%2C210.5767%2C107.477%2C218.976%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22link_Router1.1_Router2.2%22%3E%3Cpath%20d%3D%22M226.5%2C159.056%20C226.5%2C176.705%20226.5%2C195.335%20226.5%2C212.976%20%22%20fill%3D%22none%22%20id%3D%22Router1.1-to-Router2.2%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22226.5%2C218.976%2C230.5%2C209.976%2C226.5%2C213.976%2C222.5%2C209.976%2C226.5%2C218.976%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22link_Router1.2_Router2.3%22%3E%3Cpath%20d%3D%22M384.5%2C159.056%20C384.5%2C176.705%20384.5%2C195.335%20384.5%2C212.976%20%22%20fill%3D%22none%22%20id%3D%22Router1.2-to-Router2.3%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22384.5%2C218.976%2C388.5%2C209.976%2C384.5%2C213.976%2C380.5%2C209.976%2C384.5%2C218.976%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22link_Router1.2_Router2.4%22%3E%3Cpath%20d%3D%22M416.523%2C159.056%20C442.148%2C176.705%20472.9686%2C197.9316%20498.5816%2C215.5726%20%22%20fill%3D%22none%22%20id%3D%22Router1.2-to-Router2.4%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22503.523%2C218.976%2C498.3799%2C210.5767%2C499.4052%2C216.1399%2C493.842%2C217.1652%2C503.523%2C218.976%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22link_Router2.1_TailRouter.1%22%3E%3Cpath%20d%3D%22M74.0155%2C265.056%20C72.8276%2C282.705%2071.5726%2C301.3485%2070.3853%2C318.9895%20%22%20fill%3D%22none%22%20id%3D%22Router2.1-to-TailRouter.1%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%2269.9824%2C324.976%2C74.5777%2C316.2649%2C70.3182%2C319.9873%2C66.5958%2C315.7277%2C69.9824%2C324.976%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22link_Router2.2_TailRouter.2%22%3E%3Cpath%20d%3D%22M226.5%2C265.056%20C226.5%2C282.705%20226.5%2C301.335%20226.5%2C318.976%20%22%20fill%3D%22none%22%20id%3D%22Router2.2-to-TailRouter.2%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22226.5%2C324.976%2C230.5%2C315.976%2C226.5%2C319.976%2C222.5%2C315.976%2C226.5%2C324.976%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22link_Router2.3_TailRouter.3%22%3E%3Cpath%20d%3D%22M384.5%2C265.056%20C384.5%2C282.705%20384.5%2C301.335%20384.5%2C318.976%20%22%20fill%3D%22none%22%20id%3D%22Router2.3-to-TailRouter.3%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22384.5%2C324.976%2C388.5%2C315.976%2C384.5%2C319.976%2C380.5%2C315.976%2C384.5%2C324.976%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22link_Router2.4_TailRouter.4%22%3E%3Cpath%20d%3D%22M536.985%2C265.056%20C538.172%2C282.705%20539.4269%2C301.3486%20540.6149%2C318.9896%20%22%20fill%3D%22none%22%20id%3D%22Router2.4-to-TailRouter.4%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22541.018%2C324.976%2C544.4042%2C315.7276%2C540.682%2C319.9873%2C536.4223%2C316.2651%2C541.018%2C324.976%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22link_TailRouter.1_LoadBalancer%22%3E%3Cpath%20d%3D%22M118.762%2C371.056%20C158.981%2C388.7049%20209.6157%2C410.9243%20249.8167%2C428.5651%20%22%20fill%3D%22none%22%20id%3D%22TailRouter.1-to-LoadBalancer%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22255.311%2C430.9761%2C248.6769%2C423.6968%2C250.7324%2C428.967%2C245.4623%2C431.0225%2C255.311%2C430.9761%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22link_TailRouter.2_LoadBalancer%22%3E%3Cpath%20d%3D%22M243.254%2C371.056%20C256.66%2C388.7049%20271.7407%2C408.5574%20285.1407%2C426.1982%20%22%20fill%3D%22none%22%20id%3D%22TailRouter.2-to-LoadBalancer%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22288.77%2C430.9761%2C286.5113%2C421.3897%2C285.7456%2C426.9945%2C280.1408%2C426.2288%2C288.77%2C430.9761%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22link_TailRouter.3_LoadBalancer%22%3E%3Cpath%20d%3D%22M367.746%2C371.056%20C354.34%2C388.7049%20339.2593%2C408.5574%20325.8593%2C426.1982%20%22%20fill%3D%22none%22%20id%3D%22TailRouter.3-to-LoadBalancer%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22322.23%2C430.9761%2C330.8592%2C426.2288%2C325.2544%2C426.9945%2C324.4887%2C421.3897%2C322.23%2C430.9761%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22link_TailRouter.4_LoadBalancer%22%3E%3Cpath%20d%3D%22M492.238%2C371.056%20C452.019%2C388.7049%20401.3843%2C410.9243%20361.1833%2C428.5651%20%22%20fill%3D%22none%22%20id%3D%22TailRouter.4-to-LoadBalancer%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22355.689%2C430.9761%2C365.5377%2C431.0225%2C360.2676%2C428.967%2C362.3231%2C423.6968%2C355.689%2C430.9761%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E"><img   src="/images/loading.svg" data-src="data:image/svg+xml;utf8,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22us-ascii%22%20standalone%3D%22no%22%3F%3E%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20contentStyleType%3D%22text%2Fcss%22%20height%3D%22483px%22%20preserveAspectRatio%3D%22none%22%20style%3D%22width%3A610px%3Bheight%3A483px%3Bbackground%3A%23FFFFFF%3B%22%20version%3D%221.1%22%20viewBox%3D%220%200%20610%20483%22%20width%3D%22610px%22%20zoomAndPan%3D%22magnify%22%3E%3Cdefs%2F%3E%3Cg%3E%3Cg%20id%3D%22elem_HeadRouter%22%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2246.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22123%22%20x%3D%22244%22%20y%3D%227%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2210%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2215%22%20x%3D%22347%22%20y%3D%2212%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22345%22%20y%3D%2214%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22345%22%20y%3D%2218%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2283%22%20x%3D%22259%22%20y%3D%2239.9951%22%3EHeadRouter%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_Router1.1%22%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2246.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22109%22%20x%3D%22172%22%20y%3D%22113%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2210%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2215%22%20x%3D%22261%22%20y%3D%22118%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22259%22%20y%3D%22120%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22259%22%20y%3D%22124%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2269%22%20x%3D%22187%22%20y%3D%22145.9951%22%3ERouter1.1%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_Router1.2%22%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2246.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22109%22%20x%3D%22330%22%20y%3D%22113%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2210%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2215%22%20x%3D%22419%22%20y%3D%22118%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22417%22%20y%3D%22120%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22417%22%20y%3D%22124%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2269%22%20x%3D%22345%22%20y%3D%22145.9951%22%3ERouter1.2%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_Router2.1%22%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2246.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22109%22%20x%3D%2221%22%20y%3D%22219%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2210%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2215%22%20x%3D%22110%22%20y%3D%22224%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22108%22%20y%3D%22226%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22108%22%20y%3D%22230%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2269%22%20x%3D%2236%22%20y%3D%22251.9951%22%3ERouter2.1%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_Router2.2%22%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2246.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22109%22%20x%3D%22172%22%20y%3D%22219%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2210%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2215%22%20x%3D%22261%22%20y%3D%22224%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22259%22%20y%3D%22226%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22259%22%20y%3D%22230%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2269%22%20x%3D%22187%22%20y%3D%22251.9951%22%3ERouter2.2%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_Router2.3%22%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2246.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22109%22%20x%3D%22330%22%20y%3D%22219%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2210%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2215%22%20x%3D%22419%22%20y%3D%22224%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22417%22%20y%3D%22226%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22417%22%20y%3D%22230%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2269%22%20x%3D%22345%22%20y%3D%22251.9951%22%3ERouter2.3%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_Router2.4%22%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2246.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22109%22%20x%3D%22481%22%20y%3D%22219%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2210%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2215%22%20x%3D%22570%22%20y%3D%22224%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22568%22%20y%3D%22226%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22568%22%20y%3D%22230%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2269%22%20x%3D%22496%22%20y%3D%22251.9951%22%3ERouter2.4%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_TailRouter.1%22%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2246.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22123%22%20x%3D%227%22%20y%3D%22325%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2210%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2215%22%20x%3D%22110%22%20y%3D%22330%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22108%22%20y%3D%22332%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22108%22%20y%3D%22336%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2283%22%20x%3D%2222%22%20y%3D%22357.9951%22%3ETailRouter.1%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_TailRouter.2%22%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2246.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22123%22%20x%3D%22165%22%20y%3D%22325%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2210%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2215%22%20x%3D%22268%22%20y%3D%22330%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22266%22%20y%3D%22332%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22266%22%20y%3D%22336%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2283%22%20x%3D%22180%22%20y%3D%22357.9951%22%3ETailRouter.2%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_TailRouter.3%22%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2246.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22123%22%20x%3D%22323%22%20y%3D%22325%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2210%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2215%22%20x%3D%22426%22%20y%3D%22330%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22424%22%20y%3D%22332%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22424%22%20y%3D%22336%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2283%22%20x%3D%22338%22%20y%3D%22357.9951%22%3ETailRouter.3%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_TailRouter.4%22%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2246.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22123%22%20x%3D%22481%22%20y%3D%22325%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2210%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2215%22%20x%3D%22584%22%20y%3D%22330%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22582%22%20y%3D%22332%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22582%22%20y%3D%22336%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2283%22%20x%3D%22496%22%20y%3D%22357.9951%22%3ETailRouter.4%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_LoadBalancer%22%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2246.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22133%22%20x%3D%22239%22%20y%3D%22431%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%2210%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2215%22%20x%3D%22352%22%20y%3D%22436%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22350%22%20y%3D%22438%22%2F%3E%3Crect%20fill%3D%22%23F1F1F1%22%20height%3D%222%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%224%22%20x%3D%22350%22%20y%3D%22442%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2293%22%20x%3D%22254%22%20y%3D%22463.9951%22%3ELoadBalancer%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22link_HeadRouter_Router1.1%22%3E%3Cpath%20d%3D%22M288.746%2C53.056%20C275.34%2C70.705%20260.2593%2C90.5571%20246.8593%2C108.1981%20%22%20fill%3D%22none%22%20id%3D%22HeadRouter-to-Router1.1%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22243.23%2C112.976%2C251.8592%2C108.2287%2C246.2544%2C108.9944%2C245.4886%2C103.3896%2C243.23%2C112.976%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22link_HeadRouter_Router1.2%22%3E%3Cpath%20d%3D%22M322.254%2C53.056%20C335.66%2C70.705%20350.7407%2C90.5571%20364.1407%2C108.1981%20%22%20fill%3D%22none%22%20id%3D%22HeadRouter-to-Router1.2%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22367.77%2C112.976%2C365.5114%2C103.3896%2C364.7456%2C108.9944%2C359.1408%2C108.2287%2C367.77%2C112.976%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22link_Router1.1_Router2.1%22%3E%3Cpath%20d%3D%22M194.477%2C159.056%20C168.852%2C176.705%20138.0314%2C197.9316%20112.4184%2C215.5726%20%22%20fill%3D%22none%22%20id%3D%22Router1.1-to-Router2.1%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22107.477%2C218.976%2C117.158%2C217.1652%2C111.5948%2C216.1399%2C112.6201%2C210.5767%2C107.477%2C218.976%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22link_Router1.1_Router2.2%22%3E%3Cpath%20d%3D%22M226.5%2C159.056%20C226.5%2C176.705%20226.5%2C195.335%20226.5%2C212.976%20%22%20fill%3D%22none%22%20id%3D%22Router1.1-to-Router2.2%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22226.5%2C218.976%2C230.5%2C209.976%2C226.5%2C213.976%2C222.5%2C209.976%2C226.5%2C218.976%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22link_Router1.2_Router2.3%22%3E%3Cpath%20d%3D%22M384.5%2C159.056%20C384.5%2C176.705%20384.5%2C195.335%20384.5%2C212.976%20%22%20fill%3D%22none%22%20id%3D%22Router1.2-to-Router2.3%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22384.5%2C218.976%2C388.5%2C209.976%2C384.5%2C213.976%2C380.5%2C209.976%2C384.5%2C218.976%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22link_Router1.2_Router2.4%22%3E%3Cpath%20d%3D%22M416.523%2C159.056%20C442.148%2C176.705%20472.9686%2C197.9316%20498.5816%2C215.5726%20%22%20fill%3D%22none%22%20id%3D%22Router1.2-to-Router2.4%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22503.523%2C218.976%2C498.3799%2C210.5767%2C499.4052%2C216.1399%2C493.842%2C217.1652%2C503.523%2C218.976%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22link_Router2.1_TailRouter.1%22%3E%3Cpath%20d%3D%22M74.0155%2C265.056%20C72.8276%2C282.705%2071.5726%2C301.3485%2070.3853%2C318.9895%20%22%20fill%3D%22none%22%20id%3D%22Router2.1-to-TailRouter.1%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%2269.9824%2C324.976%2C74.5777%2C316.2649%2C70.3182%2C319.9873%2C66.5958%2C315.7277%2C69.9824%2C324.976%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22link_Router2.2_TailRouter.2%22%3E%3Cpath%20d%3D%22M226.5%2C265.056%20C226.5%2C282.705%20226.5%2C301.335%20226.5%2C318.976%20%22%20fill%3D%22none%22%20id%3D%22Router2.2-to-TailRouter.2%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22226.5%2C324.976%2C230.5%2C315.976%2C226.5%2C319.976%2C222.5%2C315.976%2C226.5%2C324.976%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22link_Router2.3_TailRouter.3%22%3E%3Cpath%20d%3D%22M384.5%2C265.056%20C384.5%2C282.705%20384.5%2C301.335%20384.5%2C318.976%20%22%20fill%3D%22none%22%20id%3D%22Router2.3-to-TailRouter.3%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22384.5%2C324.976%2C388.5%2C315.976%2C384.5%2C319.976%2C380.5%2C315.976%2C384.5%2C324.976%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22link_Router2.4_TailRouter.4%22%3E%3Cpath%20d%3D%22M536.985%2C265.056%20C538.172%2C282.705%20539.4269%2C301.3486%20540.6149%2C318.9896%20%22%20fill%3D%22none%22%20id%3D%22Router2.4-to-TailRouter.4%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22541.018%2C324.976%2C544.4042%2C315.7276%2C540.682%2C319.9873%2C536.4223%2C316.2651%2C541.018%2C324.976%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22link_TailRouter.1_LoadBalancer%22%3E%3Cpath%20d%3D%22M118.762%2C371.056%20C158.981%2C388.7049%20209.6157%2C410.9243%20249.8167%2C428.5651%20%22%20fill%3D%22none%22%20id%3D%22TailRouter.1-to-LoadBalancer%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22255.311%2C430.9761%2C248.6769%2C423.6968%2C250.7324%2C428.967%2C245.4623%2C431.0225%2C255.311%2C430.9761%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22link_TailRouter.2_LoadBalancer%22%3E%3Cpath%20d%3D%22M243.254%2C371.056%20C256.66%2C388.7049%20271.7407%2C408.5574%20285.1407%2C426.1982%20%22%20fill%3D%22none%22%20id%3D%22TailRouter.2-to-LoadBalancer%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22288.77%2C430.9761%2C286.5113%2C421.3897%2C285.7456%2C426.9945%2C280.1408%2C426.2288%2C288.77%2C430.9761%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22link_TailRouter.3_LoadBalancer%22%3E%3Cpath%20d%3D%22M367.746%2C371.056%20C354.34%2C388.7049%20339.2593%2C408.5574%20325.8593%2C426.1982%20%22%20fill%3D%22none%22%20id%3D%22TailRouter.3-to-LoadBalancer%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22322.23%2C430.9761%2C330.8592%2C426.2288%2C325.2544%2C426.9945%2C324.4887%2C421.3897%2C322.23%2C430.9761%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22link_TailRouter.4_LoadBalancer%22%3E%3Cpath%20d%3D%22M492.238%2C371.056%20C452.019%2C388.7049%20401.3843%2C410.9243%20361.1833%2C428.5651%20%22%20fill%3D%22none%22%20id%3D%22TailRouter.4-to-LoadBalancer%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22355.689%2C430.9761%2C365.5377%2C431.0225%2C360.2676%2C428.967%2C362.3231%2C423.6968%2C355.689%2C430.9761%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E"  lazyload></a></p>
<h3 id="3-1-2-主要类"><a href="#3-1-2-主要类" class="headerlink" title="3.1.2 主要类"></a>3.1.2 主要类</h3><p><a class="simple-lightbox" target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/jffu/jffu-blog-images@main/img/Fil5DYuBjafSDs3nd5pycKfiiErr.png"><img   src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/jffu/jffu-blog-images@main/img/Fil5DYuBjafSDs3nd5pycKfiiErr.png"  lazyload></a></p>
<h4 id="3-1-2-1-Router"><a href="#3-1-2-1-Router" class="headerlink" title="3.1.2.1 Router"></a>3.1.2.1 <code>Router</code></h4><p><code>Router</code>是路由层的核心。</p>
<ul>
<li><p><code>Router</code>的两个关键作用：地址切分<code>setServiceURLs</code>和地址选择<code>getServiceURL</code>，对应两个关键方法：</p>
<blockquote>
<table>
<thead>
<tr>
<th>方法</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>void setServiceURLs(List)</td>
<td>通知或者设置当前<code>Router</code>节点中的地址列表</td>
</tr>
<tr>
<td>ServiceURL getServiceURL(Invocation)</td>
<td>根据调用请求<code>Invocation</code>进行选址，返回符合要求的<code>ServiceURL</code></td>
</tr>
</tbody></table>
</blockquote>
</li>
<li><p>每个<code>Router</code>有一个对应的<code>RouterFactory</code>，用来生成后继节点的<code>Router</code>。<code>RouterFactory</code>的默认实现是<code>DefaultRouterFactory</code></p>
</li>
</ul>
<h4 id="3-1-2-2-AbstractRouter"><a href="#3-1-2-2-AbstractRouter" class="headerlink" title="3.1.2.2 AbstractRouter"></a>3.1.2.2 AbstractRouter</h4><p><code>AbstractRouter</code>提供了<code>Router</code>的基础实现，例如：名称、创建下一个<code>Router</code>的工厂实例、前驱节点推送的地址列表以及当前<code>Router</code>节点服务的<code>ServiceMetadata</code>。</p>
<blockquote>
<p> <code>AbstractRouter</code>是一个基本的骨架，在它上面开始衍生子节点，子节点有两种类型，一种是会尝试多个后继节点的<code>AbstractMultiTargetRouter</code>，另一种是只尝试一个后继节点的<code>AbstractSingleTargetRouter</code>。</p>
</blockquote>
<h4 id="3-1-2-3-HeadRouter"><a href="#3-1-2-3-HeadRouter" class="headerlink" title="3.1.2.3 HeadRouter"></a>3.1.2.3 <code>HeadRouter</code></h4><p><code>HeadRouter</code>是路由链的起点，同时也是地址监听器<code>AddressListener</code>链的结尾，它同时具备两类节点的属性。</p>
<ul>
<li>在收到<code>AddressListener</code>链下发的地址列表时，通过<code>setServiceURLs()</code>方法设置给路由链；</li>
<li>在收到调用请求（<code>ServiceURL getServiceURL(Invocation invocation)</code>被调用）时，将请求路由给下一个<code>Router</code>节点；</li>
</ul>
<h4 id="3-1-2-4-TailRouter"><a href="#3-1-2-4-TailRouter" class="headerlink" title="3.1.2.4 TailRouter"></a>3.1.2.4 <code>TailRouter</code></h4><p><code>TailRouter</code>是路由链的末尾，它后面对接负载均衡。它的<code>getServiceURL(Invocation invocation)</code>方法会调用负载均衡方法进行负载均衡。</p>
<h4 id="3-1-2-5-RouterFactory"><a href="#3-1-2-5-RouterFactory" class="headerlink" title="3.1.2.5 RouterFactory"></a>3.1.2.5 <code>RouterFactory</code></h4><p>  <code>RouterFactory</code>用于创建一个<code>Router</code>的后继节点，它的默认实现类是<code>DefaultRouterFactory</code>。<code>DefaultRouterFactory</code>的私有变量<code>routerClass</code>表示后继节点的类型，在创建方法<code>createRouter()</code>中会通过反射创建<code>routerClass</code>类型的<code>Router</code>实例。</p>
<h2 id="3-2-代码流程"><a href="#3-2-代码流程" class="headerlink" title="3.2 代码流程"></a>3.2 代码流程</h2><p>代码流程可以分为3部分：</p>
<ol>
<li>路由链初始化</li>
<li>地址切分</li>
<li>地址选择</li>
</ol>
<h3 id="3-2-1-路由链初始化"><a href="#3-2-1-路由链初始化" class="headerlink" title="3.2.1 路由链初始化"></a>3.2.1 路由链初始化</h3><p>参考<code>Registry</code>层文档，服务订阅时，拦截器链<code>protocolFilterChain</code>上<code>RegistryProtocolInterceptor</code>节点会启动<code>RegistryInvocationHandler</code>，<code>start()</code>方法触发：</p>
<ol>
<li><code>HeadRouter</code>节点构建</li>
<li><code>RouterChainBuilder</code>构建以<code>HeadRouter</code>开始的路由链</li>
<li><code>AddressListenerChainBuilder</code>构建以<code>HeadRouter</code>结束的地址监听器链</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Registry&gt; registries = serviceMetadata.getRegistries();</span><br><span class="line">    <span class="keyword">for</span> (Registry registry : registries) &#123;</span><br><span class="line">        <span class="comment">// 1. 构建HeadRouter</span></span><br><span class="line">        <span class="type">HeadRouter</span> <span class="variable">headRouter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HeadRouter</span>(serviceMetadata);</span><br><span class="line">        <span class="comment">// 2. 构建以HeadRouter开始的路由链</span></span><br><span class="line">        RouterChainBuilder.build(serviceMetadata, headRouter, TailRouter.class);</span><br><span class="line">        <span class="comment">// 3. 构建以HeadRouter结束的地址监听器链</span></span><br><span class="line">        <span class="type">RawAddressListener</span> <span class="variable">chain</span> <span class="operator">=</span> AddressListenerChainBuilder.build(serviceMetadata, protocol, headRouter);</span><br><span class="line"></span><br><span class="line">        registryClusterStrategyMap.put(registry, chain);</span><br><span class="line">        strategies.add(headRouter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    isBroadcast = serviceMetadata.isBroadcast();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>路由链的构建流程：</p>
<ol>
<li><p>通过SPI机制加载排好序的实现类对象</p>
<p>这一步与HSF中其他链式结构的构建一样。</p>
</li>
<li><p>构造<code>RouterFactory</code>链</p>
</li>
<li><p><strong>关键步骤</strong>：从<code>headRouter</code>开始依次给路由链上的每个<code>Router</code>设置对应的<code>RouterFactory</code></p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RouterChainBuilder</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">build</span><span class="params">(ServiceMetadata metadata, HeadRouter headRouter, Class&lt;? extends Router&gt; lastRouter)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 加载Router类对象，Scope为ProtoType，因此每个服务都有一组独立的Router</span></span><br><span class="line">        List&lt;String&gt; includeRouters = metadata.getIncludeRouters();</span><br><span class="line">        List&lt;Class&lt;?&gt;&gt; routerFilterClasses = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Class&lt;?&gt;&gt;(HSFServiceContainer.getExtensionClass(Router.class,</span><br><span class="line">                includeRouters == <span class="literal">null</span> ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;&#125; : includeRouters.toArray(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;&#125;)));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 构造RouterFactory链</span></span><br><span class="line">        <span class="type">RouterFactory</span> <span class="variable">lastFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultRouterFactory</span>(metadata, lastRouter, <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> routerFilterClasses.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            lastFactory = <span class="keyword">new</span> <span class="title class_">DefaultRouterFactory</span>(metadata, (Class&lt;Router&gt;) routerFilterClasses.get(i), lastFactory);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3. 从headRouter开始依次给路由链上的每个Router设置对应的RouterFactory</span></span><br><span class="line">        headRouter.setRouterFactory(lastFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第3步是构建路由链的关键。</p>
<ol>
<li><p><code>Router</code>节点调用<code>setRouterFactory()</code>设置<code>RouterFactory</code></p>
</li>
<li><p>调用<code>RouterFactory#createRouter</code>创建一到多个（调用多次<code>createRouter()</code>）后继<code>Router</code>节点</p>
<ul>
<li><code>RouterFactory</code>在构造时会传入需要创建的<code>Router</code>的Class对象，通过反射创建<code>Router</code>实例</li>
<li>创建得到<code>Router</code>对象实例后，回到步骤1，通过给创建出来的<code>Router</code>实例设置<code>RouterFactory</code>链上的下一个<code>RouterFactory</code></li>
</ul>
<p><a class="simple-lightbox" href="data:image/svg+xml;utf8,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22us-ascii%22%20standalone%3D%22no%22%3F%3E%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20contentStyleType%3D%22text%2Fcss%22%20height%3D%22350px%22%20preserveAspectRatio%3D%22none%22%20style%3D%22width%3A331px%3Bheight%3A350px%3Bbackground%3A%23FFFFFF%3B%22%20version%3D%221.1%22%20viewBox%3D%220%200%20331%20350%22%20width%3D%22331px%22%20zoomAndPan%3D%22magnify%22%3E%3Cdefs%2F%3E%3Cg%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%2235%22%20x2%3D%2235%22%20y1%3D%2236.2969%22%20y2%3D%22315.3594%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22195%22%20x2%3D%22195%22%20y1%3D%2236.2969%22%20y2%3D%22315.3594%22%2F%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2261%22%20x%3D%225%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2247%22%20x%3D%2212%22%20y%3D%2224.9951%22%3ERouter%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2261%22%20x%3D%225%22%20y%3D%22314.3594%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2247%22%20x%3D%2212%22%20y%3D%22334.3545%22%3ERouter%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22111%22%20x%3D%22140%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2297%22%20x%3D%22147%22%20y%3D%2224.9951%22%3ERouterFactory%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22111%22%20x%3D%22140%22%20y%3D%22314.3594%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2297%22%20x%3D%22147%22%20y%3D%22334.3545%22%3ERouterFactory%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22183.5%2C63.4297%2C193.5%2C67.4297%2C183.5%2C71.4297%2C187.5%2C67.4297%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%2235.5%22%20x2%3D%22189.5%22%20y1%3D%2267.4297%22%20y2%3D%2267.4297%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2283%22%20x%3D%2242.5%22%20y%3D%2262.3638%22%3EcreateRouter%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%22195.5%22%20x2%3D%22237.5%22%20y1%3D%2296.5625%22%20y2%3D%2296.5625%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%22237.5%22%20x2%3D%22237.5%22%20y1%3D%2296.5625%22%20y2%3D%22109.5625%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%22196.5%22%20x2%3D%22237.5%22%20y1%3D%22109.5625%22%20y2%3D%22109.5625%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22206.5%2C105.5625%2C196.5%2C109.5625%2C206.5%2C113.5625%2C202.5%2C109.5625%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22122%22%20x%3D%22202.5%22%20y%3D%2291.4966%22%3EnewInstance%20router%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%2246.5%2C134.6953%2C36.5%2C138.6953%2C46.5%2C142.6953%2C42.5%2C138.6953%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%2240.5%22%20x2%3D%22194.5%22%20y1%3D%22138.6953%22%20y2%3D%22138.6953%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22136%22%20x%3D%2252.5%22%20y%3D%22133.6294%22%3EsetServiceMeatadata%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%2246.5%2C163.8281%2C36.5%2C167.8281%2C46.5%2C171.8281%2C42.5%2C167.8281%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%2240.5%22%20x2%3D%22194.5%22%20y1%3D%22167.8281%22%20y2%3D%22167.8281%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22109%22%20x%3D%2252.5%22%20y%3D%22162.7622%22%3EsetRouterFactory%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22183.5%2C192.9609%2C193.5%2C196.9609%2C183.5%2C200.9609%2C187.5%2C196.9609%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%2235.5%22%20x2%3D%22189.5%22%20y1%3D%22196.9609%22%20y2%3D%22196.9609%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2283%22%20x%3D%2242.5%22%20y%3D%22191.895%22%3EcreateRouter%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%22195.5%22%20x2%3D%22237.5%22%20y1%3D%22226.0938%22%20y2%3D%22226.0938%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%22237.5%22%20x2%3D%22237.5%22%20y1%3D%22226.0938%22%20y2%3D%22239.0938%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%22196.5%22%20x2%3D%22237.5%22%20y1%3D%22239.0938%22%20y2%3D%22239.0938%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22206.5%2C235.0938%2C196.5%2C239.0938%2C206.5%2C243.0938%2C202.5%2C239.0938%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22122%22%20x%3D%22202.5%22%20y%3D%22221.0278%22%3EnewInstance%20router%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%2246.5%2C264.2266%2C36.5%2C268.2266%2C46.5%2C272.2266%2C42.5%2C268.2266%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%2240.5%22%20x2%3D%22194.5%22%20y1%3D%22268.2266%22%20y2%3D%22268.2266%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22136%22%20x%3D%2252.5%22%20y%3D%22263.1606%22%3EsetServiceMeatadata%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%2246.5%2C293.3594%2C36.5%2C297.3594%2C46.5%2C301.3594%2C42.5%2C297.3594%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%2240.5%22%20x2%3D%22194.5%22%20y1%3D%22297.3594%22%20y2%3D%22297.3594%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22109%22%20x%3D%2252.5%22%20y%3D%22292.2935%22%3EsetRouterFactory%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fsvg%3E"><img   src="/images/loading.svg" data-src="data:image/svg+xml;utf8,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22us-ascii%22%20standalone%3D%22no%22%3F%3E%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20contentStyleType%3D%22text%2Fcss%22%20height%3D%22350px%22%20preserveAspectRatio%3D%22none%22%20style%3D%22width%3A331px%3Bheight%3A350px%3Bbackground%3A%23FFFFFF%3B%22%20version%3D%221.1%22%20viewBox%3D%220%200%20331%20350%22%20width%3D%22331px%22%20zoomAndPan%3D%22magnify%22%3E%3Cdefs%2F%3E%3Cg%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%2235%22%20x2%3D%2235%22%20y1%3D%2236.2969%22%20y2%3D%22315.3594%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22195%22%20x2%3D%22195%22%20y1%3D%2236.2969%22%20y2%3D%22315.3594%22%2F%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2261%22%20x%3D%225%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2247%22%20x%3D%2212%22%20y%3D%2224.9951%22%3ERouter%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2261%22%20x%3D%225%22%20y%3D%22314.3594%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2247%22%20x%3D%2212%22%20y%3D%22334.3545%22%3ERouter%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22111%22%20x%3D%22140%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2297%22%20x%3D%22147%22%20y%3D%2224.9951%22%3ERouterFactory%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22111%22%20x%3D%22140%22%20y%3D%22314.3594%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2297%22%20x%3D%22147%22%20y%3D%22334.3545%22%3ERouterFactory%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22183.5%2C63.4297%2C193.5%2C67.4297%2C183.5%2C71.4297%2C187.5%2C67.4297%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%2235.5%22%20x2%3D%22189.5%22%20y1%3D%2267.4297%22%20y2%3D%2267.4297%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2283%22%20x%3D%2242.5%22%20y%3D%2262.3638%22%3EcreateRouter%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%22195.5%22%20x2%3D%22237.5%22%20y1%3D%2296.5625%22%20y2%3D%2296.5625%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%22237.5%22%20x2%3D%22237.5%22%20y1%3D%2296.5625%22%20y2%3D%22109.5625%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%22196.5%22%20x2%3D%22237.5%22%20y1%3D%22109.5625%22%20y2%3D%22109.5625%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22206.5%2C105.5625%2C196.5%2C109.5625%2C206.5%2C113.5625%2C202.5%2C109.5625%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22122%22%20x%3D%22202.5%22%20y%3D%2291.4966%22%3EnewInstance%20router%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%2246.5%2C134.6953%2C36.5%2C138.6953%2C46.5%2C142.6953%2C42.5%2C138.6953%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%2240.5%22%20x2%3D%22194.5%22%20y1%3D%22138.6953%22%20y2%3D%22138.6953%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22136%22%20x%3D%2252.5%22%20y%3D%22133.6294%22%3EsetServiceMeatadata%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%2246.5%2C163.8281%2C36.5%2C167.8281%2C46.5%2C171.8281%2C42.5%2C167.8281%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%2240.5%22%20x2%3D%22194.5%22%20y1%3D%22167.8281%22%20y2%3D%22167.8281%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22109%22%20x%3D%2252.5%22%20y%3D%22162.7622%22%3EsetRouterFactory%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22183.5%2C192.9609%2C193.5%2C196.9609%2C183.5%2C200.9609%2C187.5%2C196.9609%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%2235.5%22%20x2%3D%22189.5%22%20y1%3D%22196.9609%22%20y2%3D%22196.9609%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2283%22%20x%3D%2242.5%22%20y%3D%22191.895%22%3EcreateRouter%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%22195.5%22%20x2%3D%22237.5%22%20y1%3D%22226.0938%22%20y2%3D%22226.0938%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%22237.5%22%20x2%3D%22237.5%22%20y1%3D%22226.0938%22%20y2%3D%22239.0938%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%22196.5%22%20x2%3D%22237.5%22%20y1%3D%22239.0938%22%20y2%3D%22239.0938%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22206.5%2C235.0938%2C196.5%2C239.0938%2C206.5%2C243.0938%2C202.5%2C239.0938%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22122%22%20x%3D%22202.5%22%20y%3D%22221.0278%22%3EnewInstance%20router%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%2246.5%2C264.2266%2C36.5%2C268.2266%2C46.5%2C272.2266%2C42.5%2C268.2266%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%2240.5%22%20x2%3D%22194.5%22%20y1%3D%22268.2266%22%20y2%3D%22268.2266%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22136%22%20x%3D%2252.5%22%20y%3D%22263.1606%22%3EsetServiceMeatadata%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%2246.5%2C293.3594%2C36.5%2C297.3594%2C46.5%2C301.3594%2C42.5%2C297.3594%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3Bstroke-dasharray%3A2.0%2C2.0%3B%22%20x1%3D%2240.5%22%20x2%3D%22194.5%22%20y1%3D%22297.3594%22%20y2%3D%22297.3594%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22109%22%20x%3D%2252.5%22%20y%3D%22292.2935%22%3EsetRouterFactory%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fsvg%3E"  lazyload></a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Router <span class="title function_">createRouter</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="comment">// 1. 根据RouterFactory持有的Router Class反射创建router实例</span></span><br><span class="line">       <span class="type">Router</span> <span class="variable">router</span> <span class="operator">=</span> routerClass.newInstance();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (router <span class="keyword">instanceof</span> ServiceMetadataAware) &#123;</span><br><span class="line">           ((ServiceMetadataAware) router).setServiceMetadata(serviceMetadata);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 2. 继续给创建出来的Router实例设置RouterFactory链上的下一个RouterFactory</span></span><br><span class="line">       router.setRouterFactory(nextRouterFactory);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (router <span class="keyword">instanceof</span> LifeCycle) &#123;</span><br><span class="line">           ((LifeCycle) router).start();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> router;</span><br><span class="line">   &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">HSFException</span>(<span class="string">&quot;fail to create router instance for [&quot;</span> + routerClass.getName() + <span class="string">&quot;]&quot;</span>, throwable);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="3-2-2-地址切分"><a href="#3-2-2-地址切分" class="headerlink" title="3.2.2 地址切分"></a>3.2.2 地址切分</h3><p>从<code>Registry</code>层推送的地址列表在经过一系列<code>RawAddressListener</code>和<code>AddressListener</code>后，到达<code>HeadRouter</code>，开始地址切分的过程。</p>
<ol>
<li><p><code>HeadRouter</code>的<code>notify()</code>方法触发地址切分，通过调用<code>router.setServiceURLs(getServiceURLs())</code>将地址通知到后继节点</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notify</span><span class="params">(Registry registry, Protocol protocol, <span class="keyword">final</span> ServiceMetadata serviceMetadata,</span></span><br><span class="line"><span class="params">                   List&lt;ServiceURL&gt; addresses)</span> &#123;</span><br><span class="line">    <span class="comment">// notify触发地址切分过程</span></span><br><span class="line">    setServiceURLs(addresses);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setServiceURLs</span><span class="params">(List&lt;ServiceURL&gt; serviceURLs)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.setServiceURLs(serviceURLs);</span><br><span class="line">    <span class="comment">// 调用后继节点的setServiceURLs方法，通知到后继节点进行处理</span></span><br><span class="line">    router.setServiceURLs(getServiceURLs());</span><br><span class="line">    <span class="keyword">if</span> (shouldPrintRouterSnapshot()) &#123;</span><br><span class="line">        LOGGER.info(<span class="string">&quot;HSF router snapshot on service &#123;&#125;:\n&#123;&#125;&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;serviceMetadata.getUniqueName(), getRouterSnapshotTreeString(router)&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>具体实现类的<code>Router</code>根据自身切分策略进行切分，步骤：</p>
<ul>
<li><p>通过调用<code>super.setServiceURLs(addresses)</code>将收到的地址列表保存到自身</p>
</li>
<li><p>根据需要对地址列表切分，将切分后的地址列表分别通知给不同的后继节点</p>
<p>这一步在很多<code>Router</code>实现中采用了异步刷新方式，并通过信号量控制并发。</p>
<p>地址切分不一定减少传给后继节点的地址，<code>WeightRouter</code>的例子：</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setServiceURLs</span><span class="params">(List&lt;ServiceURL&gt; addresses)</span> &#123;</span><br><span class="line">    <span class="comment">// 保存地址列表</span></span><br><span class="line">    <span class="built_in">super</span>.setServiceURLs(addresses);</span><br><span class="line">    <span class="comment">// 开启异步刷新</span></span><br><span class="line">    scheduleRefresh();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">scheduleRefresh</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 通过信号量控制并发数目</span></span><br><span class="line">    <span class="keyword">if</span>(refreshPermit.tryAcquire()) &#123;</span><br><span class="line">        serviceMetadata.getScheduledExecutorService().submit(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                refreshPermit.release();</span><br><span class="line">                <span class="comment">// 在异步线程里刷新</span></span><br><span class="line">                refresh();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (weightingRule == <span class="literal">null</span> || weightingRule.getExpireTime() &lt;= System.currentTimeMillis()) &#123;</span><br><span class="line">        nextRouter.setServiceURLs(serviceURLs);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        List&lt;ServiceURL&gt; addedAddresses = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;ServiceURL&gt;();</span><br><span class="line">        <span class="comment">// 重复增加权重高的地址节点</span></span><br><span class="line">        <span class="keyword">for</span> (ServiceURL address : serviceURLs) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">weight</span> <span class="operator">=</span> weightingRule.getWeight(address.getHost());</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; weight; i++) &#123;</span><br><span class="line">                addedAddresses.add(address);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        weightedAddressList.clear();</span><br><span class="line">        weightedAddressList.addAll(addedAddresses);</span><br><span class="line"></span><br><span class="line">        addedAddresses.addAll(serviceURLs);</span><br><span class="line">        <span class="comment">// 将权重化后地址节点列表通知到后继节点</span></span><br><span class="line">        nextRouter.setServiceURLs(addedAddresses);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>走到<code>TailRouter</code>，不再往下传递，完成一次地址切分</p>
</li>
</ol>
<p>地址切分完成后，每个<code>Router</code>节点可能保存了0到多个地址。下次地址通知时，再次进行切分，更新地址列表。</p>
<h3 id="3-2-3-地址选择"><a href="#3-2-3-地址选择" class="headerlink" title="3.2.3 地址选择"></a>3.2.3 地址选择</h3><p>完成地址切分后，每个<code>Router</code>节点在收到地址选择请求时，根据切分后得到的地址列表进行选择。</p>
<p>地址选择通过<code>ServiceURL getServiceURL(Invocation invocation)</code>方法完成。</p>
<blockquote>
<p>选址过程实际上就是在<code>Router</code>树上的节点决策过程，在每个<code>Router</code>节点上，根据请求上下文，决定返回哪一个后继节点，最终请求将会促使<code>Router</code>树返回一个叶子节点，这个节点的类型是<code>TailRouter</code>，再由它将请求传递给负载均衡服务进行最终的地址筛选。</p>
</blockquote>
<p>选址流程：</p>
<ol>
<li><p><code>RegistryInvocationHandle#invoke</code>通过调用<code>HeadRouter#getServiceURL</code>，开始一次调用的选址过程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RegistryInvocationHandler#invoke</span></span><br><span class="line"><span class="keyword">for</span> (HeadRouter headRouter : strategies) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isBroadcast) &#123;</span><br><span class="line">        <span class="comment">// 广播的情况，通过getServiceURLs选择一组地址</span></span><br><span class="line">        List&lt;ServiceURL&gt; addresses = headRouter.getServiceURLs(invocation);</span><br><span class="line">		<span class="comment">// 省略</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 一般的情况，通过getServiceURL选择一个地址</span></span><br><span class="line">        <span class="type">ServiceURL</span> <span class="variable">address</span> <span class="operator">=</span> headRouter.getServiceURL(invocation);</span><br><span class="line">        <span class="keyword">if</span> (address != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 经过选定的地址发起调用</span></span><br><span class="line">            invocation.setTargetAddress(address);</span><br><span class="line">            <span class="keyword">return</span> delegate.invoke(invocation);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 省略</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 找不到可用地址时抛出异常</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">HSFServiceAddressNotFoundException</span>(<span class="string">&quot;&quot;</span>, LoggerHelper.getErrorCodeStr(</span><br><span class="line">            <span class="string">&quot;HSF&quot;</span>,</span><br><span class="line">            <span class="string">&quot;HSF-0001&quot;</span>,</span><br><span class="line">            <span class="string">&quot;BIZ&quot;</span>,</span><br><span class="line">            <span class="string">&quot;[HSF-Consumer] can&#x27;t find target service addresses, target serviceName:&quot;</span> +</span><br><span class="line">                    invocation.getTargetServiceUniqueName() + <span class="string">&quot; Group:&quot;</span> + serviceMetadata.getGroup()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>HeadRouter</code>直接将选址工作委托给后继节点（前置增加路由trace记录）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HeadRouter#getServiceURL</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;ServiceURL&gt; <span class="title function_">getServiceURLs</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> HSFException &#123;</span><br><span class="line">    <span class="comment">// router trace for each invocation</span></span><br><span class="line">    <span class="type">RouterSnapshotTreeNode</span> <span class="variable">routerState</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RouterSnapshotTreeNode</span>(ROUTER_NAME, router.getServiceURLs().size());</span><br><span class="line">    invocation.setRouterState(routerState);</span><br><span class="line">	<span class="comment">// 委托给后继节点进行选址</span></span><br><span class="line">    <span class="keyword">return</span> router.getServiceURLs(invocation);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>后继节点依次进行根据自身的选址策略进行选址路由，常见的几种可能：</p>
<ul>
<li><p>作为<code>AbstractSingleTargetRouter</code>，选择一个后继<code>Router</code>，将地址选择委托给后继<code>Router</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractSingleTargetRouter#getServiceURL</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ServiceURL <span class="title function_">getServiceURL</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> HSFException &#123;</span><br><span class="line">    <span class="type">Router</span> <span class="variable">router</span> <span class="operator">=</span> selectRouter(invocation);</span><br><span class="line">    <span class="keyword">if</span> (router != <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="comment">// 省略</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用后继router的getServiceURL()方法，将地址选择委托给后继节点</span></span><br><span class="line">        <span class="type">ServiceURL</span> <span class="variable">serviceURL</span> <span class="operator">=</span> router.getServiceURL(invocation);</span><br><span class="line"></span><br><span class="line">        invocation.setRouterState(parent);</span><br><span class="line">        <span class="keyword">return</span> serviceURL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>作为<code>AbstractMultiTargetRouter</code>，选择一组后继<code>Router</code>，遍历并返回第一个返回的地址。例子：<code>MachineRoomRouter</code>，<code>UnitRouter</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractMultiTargetRouter#getServiceURL</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ServiceURL <span class="title function_">getServiceURL</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> HSFException &#123;</span><br><span class="line">	<span class="comment">// 省略</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取后继的一组Router节点</span></span><br><span class="line">    Router[] routers = selectRouters(invocation);</span><br><span class="line">    <span class="keyword">if</span> (routers != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Router router : routers) &#123;</span><br><span class="line">			<span class="comment">// 省略</span></span><br><span class="line">			</span><br><span class="line">            <span class="comment">// 如果能够通过router获得可用的地址，就返回这个地址</span></span><br><span class="line">            <span class="type">ServiceURL</span> <span class="variable">result</span> <span class="operator">=</span> router.getServiceURL(invocation);</span><br><span class="line">            <span class="keyword">if</span> (result != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>直接拦截返回，例如<code>UserSpecifiedIpRouter</code>在设置了<code>directTargetServerIp</code>或者<code>targetServerIp</code>时，直接返回设置的地址</p>
</li>
<li><p>对后继节点返回的地址进行处理后返回可用地址，例如<code>ConnectivityRouter</code>会进行连通性检测</p>
</li>
</ul>
</li>
<li><p>如果没有被<code>UserSpecifiedIpRouter</code>一类的<code>Router</code>拦截，地址选择会走到路由链的末尾<code>TailRouter</code>，交给负载均衡选择一个地址后返回</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TailRouter#getServiceURL</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ServiceURL <span class="title function_">getServiceURL</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> HSFException &#123;</span><br><span class="line">    List&lt;ServiceURL&gt; tmpAddressList = getServiceURLs(invocation);</span><br><span class="line">    <span class="comment">// 通过负载均衡选择一个地址</span></span><br><span class="line">    <span class="keyword">for</span> (LoadBalancer loadBalancer : loadBalancers) &#123;</span><br><span class="line">        <span class="keyword">if</span> (loadBalancer.accept(invocation))</span><br><span class="line">            <span class="keyword">return</span> loadBalancer.select(tmpAddressList, invocation);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>目录</strong></p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.atatech.org/articles/123424">从上往下读HSF源码1-配置领域</a></li>
<li><a target="_blank" rel="noopener" href="https://www.atatech.org/articles/123425">从上往下读HSF源码2-服务领域1-调用层</a></li>
<li><a target="_blank" rel="noopener" href="https://www.atatech.org/articles/123427">从上往下读HSF源码3-服务领域2-路由</a></li>
<li><a target="_blank" rel="noopener" href="https://www.atatech.org/articles/123428">从上往下读HSF源码4-服务领域3-负载均衡</a></li>
<li><a target="_blank" rel="noopener" href="https://www.atatech.org/articles/123429">从上往下读HSF源码5-应用领域1-Registry</a></li>
<li><a target="_blank" rel="noopener" href="https://www.atatech.org/articles/123430">从上往下读HSF源码6-应用领域2-Protocol</a></li>
<li><a target="_blank" rel="noopener" href="https://www.atatech.org/articles/123432">从上往下读HSF源码7-框架领域1-总体设计</a></li>
<li><a target="_blank" rel="noopener" href="https://www.atatech.org/articles/123433">从上往下读HSF源码8-框架领域2-编解码</a></li>
<li><a target="_blank" rel="noopener" href="https://www.atatech.org/articles/123434">从上往下读HSF源码9-框架领域3-网络层</a></li>
</ol>
<h1 id="4-服务领域3-负载均衡"><a href="#4-服务领域3-负载均衡" class="headerlink" title="4 服务领域3 - 负载均衡"></a>4 服务领域3 - 负载均衡</h1><h2 id="4-1-负载均衡的设计和定义"><a href="#4-1-负载均衡的设计和定义" class="headerlink" title="4.1 负载均衡的设计和定义"></a>4.1 负载均衡的设计和定义</h2><p>HSF中的负载均衡是路由的补充。</p>
<ul>
<li>路由链负责根据路由规则选择出一到多个可用地址</li>
<li>负载均衡负责在路由链的路由结果中选择一个地址</li>
</ul>
<p>负载均衡的设计比较简单。对应的<code>LoadBalancer</code>抽象只有两个方法：</p>
<ul>
<li><code>select</code>：在一组<code>ServiceURL</code>中，根据负载均衡策略选择一个地址</li>
<li><code>accept</code>：判断是否适用于该次调用，适用时才会使用该<code>LoadBalancer</code>进行负载均衡</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">LoadBalancer</span> &#123;</span><br><span class="line"></span><br><span class="line">    ServiceURL <span class="title function_">select</span><span class="params">(List&lt;ServiceURL&gt; addresses, Invocation invocation)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">accept</span><span class="params">(Invocation invocation)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对负载均衡进行扩展同样是通过SPI机制加载自定义的<code>LoadBalancer</code>实现类即可，因为在<code>Router</code>链的尾节点<code>TailRouter</code>上进行负载均衡器选择时，是遍历找到第一个可用（<code>accept()</code>返回true）的<code>LoadBalancer</code>，所以自定义的<code>LoadBalancer</code>需要设置更小的<code>@Order</code>值才能确保生效。</p>
<h2 id="4-2-代码流程"><a href="#4-2-代码流程" class="headerlink" title="4.2 代码流程"></a>4.2 代码流程</h2><h3 id="4-2-1-初始化"><a href="#4-2-1-初始化" class="headerlink" title="4.2.1 初始化"></a>4.2.1 初始化</h3><p>在构造<code>TailRouter</code>节点时，构建完成<code>LoadBalancer</code>列表。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> List&lt;LoadBalancer&gt; loadBalancers;</span><br><span class="line"><span class="keyword">public</span> <span class="title function_">TailRouter</span><span class="params">()</span> &#123;</span><br><span class="line">    loadBalancers = HSFServiceContainer.getInstances(LoadBalancer.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-2-实现类"><a href="#4-2-2-实现类" class="headerlink" title="4.2.2 实现类"></a>4.2.2 实现类</h3><p>根据负载均衡策略，HSF默认提供了几类<code>LoadBalancer</code>。默认使用<code>RandomLoadBalancer</code>。</p>
<table>
<thead>
<tr>
<th>实现类</th>
<th>负载均衡策略</th>
<th>Order</th>
<th>生效</th>
</tr>
</thead>
<tbody><tr>
<td>RRLoadBalancer</td>
<td>轮询</td>
<td>50</td>
<td>元数据配置了enableRRLoadbalancer</td>
</tr>
<tr>
<td>WeightLoadBalancer</td>
<td>加权轮询</td>
<td>300</td>
<td>启用并且在ConfigServer配置了权重</td>
</tr>
<tr>
<td>RandomLoadBalancer</td>
<td>随机</td>
<td>MAX</td>
<td>默认生效</td>
</tr>
<tr>
<td>ConsistentHashLoadBalancer</td>
<td>一致性Hash</td>
<td>100</td>
<td>元数据配置consistent</td>
</tr>
</tbody></table>
<p>默认的<code>RandomLoadBalancer</code>实现较简单。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RandomLoadBalancer</span> <span class="keyword">implements</span> <span class="title class_">LoadBalancer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ServiceURL <span class="title function_">select</span><span class="params">(List&lt;ServiceURL&gt; addresses, Invocation invocation)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (addresses == <span class="literal">null</span> || addresses.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 伪随机选取</span></span><br><span class="line">        <span class="keyword">return</span> addresses.get(random.nextInt(addresses.size()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">accept</span><span class="params">(Invocation invocation)</span> &#123;</span><br><span class="line">        <span class="comment">// 默认返回true</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="5-应用领域1-Registry"><a href="#5-应用领域1-Registry" class="headerlink" title="5 应用领域1 - Registry"></a>5 应用领域1 - Registry</h1><h2 id="5-1-接口和能力"><a href="#5-1-接口和能力" class="headerlink" title="5.1 接口和能力"></a>5.1 接口和能力</h2><p><code>Registry</code>负责与注册中心的交互，作为注册中心客户端的抽象，提供两大类能力：</p>
<ul>
<li>服务注册：服务提供者Provider通过<code>Registry</code>向注册中心注册服务信息；</li>
<li>服务订阅：服务使用者Consumer通过<code>Registry</code>向注册中心订阅感兴趣的服务信息；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Registry</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(ServiceMetadata metadata, List&lt;ServiceURL&gt; serviceURLs)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">unregister</span><span class="params">(ServiceMetadata metadata)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(Protocol protocol, ServiceMetadata metadata, RawAddressListener listener)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">unsubscribe</span><span class="params">(Protocol protocol, ServiceMetadata metadata, RawAddressListener listener)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ConfigServer是HSF默认的注册中心，对应的<code>Registry</code>实现为<code>ConfigServerRegistry</code>。</p>
<p><a class="simple-lightbox" href="data:image/svg+xml;utf8,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22us-ascii%22%20standalone%3D%22no%22%3F%3E%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20contentStyleType%3D%22text%2Fcss%22%20height%3D%22846px%22%20preserveAspectRatio%3D%22none%22%20style%3D%22width%3A686px%3Bheight%3A846px%3Bbackground%3A%23FFFFFF%3B%22%20version%3D%221.1%22%20viewBox%3D%220%200%20686%20846%22%20width%3D%22686px%22%20zoomAndPan%3D%22magnify%22%3E%3Cdefs%2F%3E%3Cg%3E%3Cg%20id%3D%22elem_Registry%22%3E%3Crect%20codeLine%3D%221%22%20fill%3D%22%23F1F1F1%22%20height%3D%22113.1875%22%20id%3D%22Registry%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22672%22%20x%3D%227%22%20y%3D%227%22%2F%3E%3Cellipse%20cx%3D%22310.75%22%20cy%3D%2223%22%20fill%3D%22%23B4A7E5%22%20rx%3D%2211%22%20ry%3D%2211%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpath%20d%3D%22M306.6719%2C18.7656%20L306.6719%2C16.6094%20L314.0625%2C16.6094%20L314.0625%2C18.7656%20L311.5938%2C18.7656%20L311.5938%2C26.8438%20L314.0625%2C26.8438%20L314.0625%2C29%20L306.6719%2C29%20L306.6719%2C26.8438%20L309.1406%2C26.8438%20L309.1406%2C18.7656%20L306.6719%2C18.7656%20Z%20%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20font-style%3D%22italic%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2256%22%20x%3D%22331.25%22%20y%3D%2227.8467%22%3ERegistry%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%228%22%20x2%3D%22678%22%20y1%3D%2239%22%20y2%3D%2239%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%228%22%20x2%3D%22678%22%20y1%3D%2247%22%20y2%3D%2247%22%2F%3E%3Cellipse%20cx%3D%2218%22%20cy%3D%2260.6484%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22503%22%20x%3D%2227%22%20y%3D%2263.9951%22%3Eregister(ServiceMetadata%20metadata%2C%20List%26lt%3BServiceURL%26gt%3B%20serviceURLs)%3A%20void%3C%2Ftext%3E%3Cellipse%20cx%3D%2218%22%20cy%3D%2276.9453%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22301%22%20x%3D%2227%22%20y%3D%2280.292%22%3Eunregister(ServiceMetadata%20metadata)%3A%20void%3C%2Ftext%3E%3Cellipse%20cx%3D%2218%22%20cy%3D%2293.2422%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22628%22%20x%3D%2227%22%20y%3D%2296.5889%22%3Esubscribe(Protocol%20protocol%2C%20ServiceMetadata%20metadata%2C%20RawAddressListener%20listener)%3A%20void%3C%2Ftext%3E%3Cellipse%20cx%3D%2218%22%20cy%3D%22109.5391%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22646%22%20x%3D%2227%22%20y%3D%22112.8857%22%3Eunsubscribe(Protocol%20protocol%2C%20ServiceMetadata%20metadata%2C%20RawAddressListener%20listener)%3A%20void%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_ServiceMetadata%22%3E%3Crect%20codeLine%3D%228%22%20fill%3D%22%23F1F1F1%22%20height%3D%2248%22%20id%3D%22ServiceMetadata%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22146%22%20x%3D%22207%22%20y%3D%22180%22%2F%3E%3Cellipse%20cx%3D%22222%22%20cy%3D%22196%22%20fill%3D%22%23ADD1B2%22%20rx%3D%2211%22%20ry%3D%2211%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpath%20d%3D%22M224.9688%2C201.6406%20Q224.3906%2C201.9375%20223.75%2C202.0781%20Q223.1094%2C202.2344%20222.4063%2C202.2344%20Q219.9063%2C202.2344%20218.5781%2C200.5938%20Q217.2656%2C198.9375%20217.2656%2C195.8125%20Q217.2656%2C192.6875%20218.5781%2C191.0313%20Q219.9063%2C189.375%20222.4063%2C189.375%20Q223.1094%2C189.375%20223.75%2C189.5313%20Q224.4063%2C189.6875%20224.9688%2C189.9844%20L224.9688%2C192.7031%20Q224.3438%2C192.125%20223.75%2C191.8594%20Q223.1563%2C191.5781%20222.5313%2C191.5781%20Q221.1875%2C191.5781%20220.5%2C192.6563%20Q219.8125%2C193.7188%20219.8125%2C195.8125%20Q219.8125%2C197.9063%20220.5%2C198.9844%20Q221.1875%2C200.0469%20222.5313%2C200.0469%20Q223.1563%2C200.0469%20223.75%2C199.7813%20Q224.3438%2C199.5%20224.9688%2C198.9219%20L224.9688%2C201.6406%20Z%20%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22114%22%20x%3D%22236%22%20y%3D%22200.8467%22%3EServiceMetadata%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22208%22%20x2%3D%22352%22%20y1%3D%22212%22%20y2%3D%22212%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22208%22%20x2%3D%22352%22%20y1%3D%22220%22%20y2%3D%22220%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_ServiceURL%22%3E%3Crect%20codeLine%3D%2211%22%20fill%3D%22%23F1F1F1%22%20height%3D%22129.4844%22%20id%3D%22ServiceURL%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22338%22%20x%3D%22174%22%20y%3D%22288%22%2F%3E%3Cellipse%20cx%3D%22300.25%22%20cy%3D%22304%22%20fill%3D%22%23B4A7E5%22%20rx%3D%2211%22%20ry%3D%2211%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpath%20d%3D%22M296.1719%2C299.7656%20L296.1719%2C297.6094%20L303.5625%2C297.6094%20L303.5625%2C299.7656%20L301.0938%2C299.7656%20L301.0938%2C307.8438%20L303.5625%2C307.8438%20L303.5625%2C310%20L296.1719%2C310%20L296.1719%2C307.8438%20L298.6406%2C307.8438%20L298.6406%2C299.7656%20L296.1719%2C299.7656%20Z%20%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20font-style%3D%22italic%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2277%22%20x%3D%22320.75%22%20y%3D%22308.8467%22%3EServiceURL%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22175%22%20x2%3D%22511%22%20y1%3D%22320%22%20y2%3D%22320%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22175%22%20x2%3D%22511%22%20y1%3D%22328%22%20y2%3D%22328%22%2F%3E%3Cellipse%20cx%3D%22185%22%20cy%3D%22341.6484%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22139%22%20x%3D%22194%22%20y%3D%22344.9951%22%3EgetProtocol()%3A%20String%3C%2Ftext%3E%3Cellipse%20cx%3D%22185%22%20cy%3D%22357.9453%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22114%22%20x%3D%22194%22%20y%3D%22361.292%22%3EgetHost()%3A%20String%3C%2Ftext%3E%3Cellipse%20cx%3D%22185%22%20cy%3D%22374.2422%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2287%22%20x%3D%22194%22%20y%3D%22377.5889%22%3EgetPort()%3A%20int%3C%2Ftext%3E%3Cellipse%20cx%3D%22185%22%20cy%3D%22390.5391%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22221%22%20x%3D%22194%22%20y%3D%22393.8857%22%3EgetParameter(String%20key)%3A%20String%3C%2Ftext%3E%3Cellipse%20cx%3D%22185%22%20cy%3D%22406.8359%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22312%22%20x%3D%22194%22%20y%3D%22410.1826%22%3EgetConnectionSupport()%3A%20ConnectionSupport%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_ConnectionSupport%22%3E%3Crect%20codeLine%3D%2219%22%20fill%3D%22%23F1F1F1%22%20height%3D%2280.5938%22%20id%3D%22ConnectionSupport%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22268%22%20x%3D%22209%22%20y%3D%22477%22%2F%3E%3Cellipse%20cx%3D%22271.25%22%20cy%3D%22493%22%20fill%3D%22%23B4A7E5%22%20rx%3D%2211%22%20ry%3D%2211%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpath%20d%3D%22M267.1719%2C488.7656%20L267.1719%2C486.6094%20L274.5625%2C486.6094%20L274.5625%2C488.7656%20L272.0938%2C488.7656%20L272.0938%2C496.8438%20L274.5625%2C496.8438%20L274.5625%2C499%20L267.1719%2C499%20L267.1719%2C496.8438%20L269.6406%2C496.8438%20L269.6406%2C488.7656%20L267.1719%2C488.7656%20Z%20%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20font-style%3D%22italic%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22135%22%20x%3D%22291.75%22%20y%3D%22497.8467%22%3EConnectionSupport%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22210%22%20x2%3D%22476%22%20y1%3D%22509%22%20y2%3D%22509%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22210%22%20x2%3D%22476%22%20y1%3D%22517%22%20y2%3D%22517%22%2F%3E%3Cellipse%20cx%3D%22220%22%20cy%3D%22530.6484%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22231%22%20x%3D%22229%22%20y%3D%22533.9951%22%3EpollConnectionID()%3A%20ConnectionID%3C%2Ftext%3E%3Cellipse%20cx%3D%22220%22%20cy%3D%22546.9453%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22242%22%20x%3D%22229%22%20y%3D%22550.292%22%3EpeekConnectionID()%3A%20ConnectionID%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_ConnectionID%22%3E%3Crect%20codeLine%3D%2224%22%20fill%3D%22%23F1F1F1%22%20height%3D%2280.5938%22%20id%3D%22ConnectionID%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22222%22%20x%3D%22232%22%20y%3D%22618%22%2F%3E%3Cellipse%20cx%3D%22291.75%22%20cy%3D%22634%22%20fill%3D%22%23B4A7E5%22%20rx%3D%2211%22%20ry%3D%2211%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpath%20d%3D%22M287.6719%2C629.7656%20L287.6719%2C627.6094%20L295.0625%2C627.6094%20L295.0625%2C629.7656%20L292.5938%2C629.7656%20L292.5938%2C637.8438%20L295.0625%2C637.8438%20L295.0625%2C640%20L287.6719%2C640%20L287.6719%2C637.8438%20L290.1406%2C637.8438%20L290.1406%2C629.7656%20L287.6719%2C629.7656%20Z%20%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20font-style%3D%22italic%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2294%22%20x%3D%22312.25%22%20y%3D%22638.8467%22%3EConnectionID%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22233%22%20x2%3D%22453%22%20y1%3D%22650%22%20y2%3D%22650%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22233%22%20x2%3D%22453%22%20y1%3D%22658%22%20y2%3D%22658%22%2F%3E%3Cellipse%20cx%3D%22243%22%20cy%3D%22671.6484%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2296%22%20x%3D%22252%22%20y%3D%22674.9951%22%3EgetID()%3A%20String%3C%2Ftext%3E%3Cellipse%20cx%3D%22243%22%20cy%3D%22687.9453%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22196%22%20x%3D%22252%22%20y%3D%22691.292%22%3EgetServiceURL()%3A%20ServiceURL%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_ClientStream%22%3E%3Crect%20codeLine%3D%2229%22%20fill%3D%22%23F1F1F1%22%20height%3D%2280.5938%22%20id%3D%22ClientStream%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22434%22%20x%3D%22126%22%20y%3D%22759%22%2F%3E%3Cellipse%20cx%3D%22294.75%22%20cy%3D%22775%22%20fill%3D%22%23B4A7E5%22%20rx%3D%2211%22%20ry%3D%2211%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpath%20d%3D%22M290.6719%2C770.7656%20L290.6719%2C768.6094%20L298.0625%2C768.6094%20L298.0625%2C770.7656%20L295.5938%2C770.7656%20L295.5938%2C778.8438%20L298.0625%2C778.8438%20L298.0625%2C781%20L290.6719%2C781%20L290.6719%2C778.8438%20L293.1406%2C778.8438%20L293.1406%2C770.7656%20L290.6719%2C770.7656%20Z%20%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20font-style%3D%22italic%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2288%22%20x%3D%22315.25%22%20y%3D%22779.8467%22%3EClientStream%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22127%22%20x2%3D%22559%22%20y1%3D%22791%22%20y2%3D%22791%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22127%22%20x2%3D%22559%22%20y1%3D%22799%22%20y2%3D%22799%22%2F%3E%3Cellipse%20cx%3D%22137%22%20cy%3D%22812.6484%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22205%22%20x%3D%22146%22%20y%3D%22815.9951%22%3EconnectionID()%3A%20ConnectionID%3C%2Ftext%3E%3Cellipse%20cx%3D%22137%22%20cy%3D%22828.9453%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22408%22%20x%3D%22146%22%20y%3D%22832.292%22%3Ewrite(Invocation%20invocation)%3A%20ListenableFuture%26lt%3BRPCResult%26gt%3B%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22link_Registry_ServiceMetadata%22%3E%3Cpath%20codeLine%3D%2234%22%20d%3D%22M317.738%2C120.035%20C308.222%2C140.957%20300.3985%2C158.1565%20292.9635%2C174.5005%20%22%20fill%3D%22none%22%20id%3D%22Registry-to-ServiceMetadata%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22290.479%2C179.962%2C297.8467%2C173.4261%2C292.5494%2C175.4108%2C290.5647%2C170.1135%2C290.479%2C179.962%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2223%22%20x%3D%22290.0279%22%20y%3D%22140.3029%22%3E0..*%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2223%22%20x%3D%22267.2174%22%20y%3D%22168.9643%22%3E0..*%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22link_Registry_ServiceURL%22%3E%3Cpath%20codeLine%3D%2235%22%20d%3D%22M359.313%2C120.114%20C364.078%2C138.953%20368.638%2C160.23%20371%2C180%20C375.277%2C215.797%20370.8069%2C249.6971%20363.3869%2C281.9061%20%22%20fill%3D%22none%22%20id%3D%22Registry-to-ServiceURL%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22362.04%2C287.753%2C367.9583%2C279.8807%2C363.1625%2C282.8806%2C360.1625%2C278.0848%2C362.04%2C287.753%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2223%22%20x%3D%22336.9297%22%20y%3D%22140.392%22%3E0..*%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2223%22%20x%3D%22339.8647%22%20y%3D%22276.8987%22%3E0..*%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22link_ServiceMetadata_ServiceURL%22%3E%3Cpath%20codeLine%3D%2236%22%20d%3D%22M289.983%2C228.213%20C296.922%2C244.35%20304.1586%2C261.1801%20313.2916%2C282.4171%20%22%20fill%3D%22none%22%20id%3D%22ServiceMetadata-to-ServiceURL%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22315.662%2C287.929%2C315.781%2C278.0809%2C313.6867%2C283.3357%2C308.4318%2C281.2414%2C315.662%2C287.929%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%228%22%20x%3D%22283.4414%22%20y%3D%22248.0261%22%3E1%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2223%22%20x%3D%22288.4141%22%20y%3D%22277.0939%22%3E0..*%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22link_ServiceURL_ConnectionSupport%22%3E%3Cpath%20codeLine%3D%2237%22%20d%3D%22M343%2C429.454%20C343%2C449.433%20343%2C452.888%20343%2C470.704%20%22%20fill%3D%22none%22%20id%3D%22ServiceURL-ConnectionSupport%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22none%22%20points%3D%22343%2C417.454%2C339%2C423.454%2C343%2C429.454%2C347%2C423.454%2C343%2C417.454%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22343%2C476.704%2C347%2C467.704%2C343%2C471.704%2C339%2C467.704%2C343%2C476.704%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%228%22%20x%3D%22334.5625%22%20y%3D%22437.4263%22%3E1%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%228%22%20x%3D%22334.3375%22%20y%3D%22465.8165%22%3E1%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22link_ConnectionSupport_ConnectionID%22%3E%3Cpath%20codeLine%3D%2238%22%20d%3D%22M343%2C570.332%20C343%2C588.944%20343%2C593.05%20343%2C611.662%20%22%20fill%3D%22none%22%20id%3D%22ConnectionSupport-ConnectionID%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22none%22%20points%3D%22343%2C558.332%2C339%2C564.332%2C343%2C570.332%2C347%2C564.332%2C343%2C558.332%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22343%2C617.662%2C347%2C608.662%2C343%2C612.662%2C339%2C608.662%2C343%2C617.662%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%228%22%20x%3D%22334.4125%22%20y%3D%22577.5372%22%3E1%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2223%22%20x%3D%22318.1672%22%20y%3D%22607.068%22%3E1..*%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22link_ConnectionID_ClientStream%22%3E%3Cpath%20codeLine%3D%2239%22%20d%3D%22M343%2C699.332%20C343%2C717.944%20343%2C734.0499%20343%2C752.6624%20%22%20fill%3D%22none%22%20id%3D%22ConnectionID-to-ClientStream%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22343%2C758.6624%2C347%2C749.6624%2C343%2C753.6624%2C339%2C749.6624%2C343%2C758.6624%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%228%22%20x%3D%22334.4125%22%20y%3D%22718.5372%22%3E1%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%228%22%20x%3D%22334.3625%22%20y%3D%22748.0684%22%3E1%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E"><img   src="/images/loading.svg" data-src="data:image/svg+xml;utf8,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22us-ascii%22%20standalone%3D%22no%22%3F%3E%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20contentStyleType%3D%22text%2Fcss%22%20height%3D%22846px%22%20preserveAspectRatio%3D%22none%22%20style%3D%22width%3A686px%3Bheight%3A846px%3Bbackground%3A%23FFFFFF%3B%22%20version%3D%221.1%22%20viewBox%3D%220%200%20686%20846%22%20width%3D%22686px%22%20zoomAndPan%3D%22magnify%22%3E%3Cdefs%2F%3E%3Cg%3E%3Cg%20id%3D%22elem_Registry%22%3E%3Crect%20codeLine%3D%221%22%20fill%3D%22%23F1F1F1%22%20height%3D%22113.1875%22%20id%3D%22Registry%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22672%22%20x%3D%227%22%20y%3D%227%22%2F%3E%3Cellipse%20cx%3D%22310.75%22%20cy%3D%2223%22%20fill%3D%22%23B4A7E5%22%20rx%3D%2211%22%20ry%3D%2211%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpath%20d%3D%22M306.6719%2C18.7656%20L306.6719%2C16.6094%20L314.0625%2C16.6094%20L314.0625%2C18.7656%20L311.5938%2C18.7656%20L311.5938%2C26.8438%20L314.0625%2C26.8438%20L314.0625%2C29%20L306.6719%2C29%20L306.6719%2C26.8438%20L309.1406%2C26.8438%20L309.1406%2C18.7656%20L306.6719%2C18.7656%20Z%20%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20font-style%3D%22italic%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2256%22%20x%3D%22331.25%22%20y%3D%2227.8467%22%3ERegistry%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%228%22%20x2%3D%22678%22%20y1%3D%2239%22%20y2%3D%2239%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%228%22%20x2%3D%22678%22%20y1%3D%2247%22%20y2%3D%2247%22%2F%3E%3Cellipse%20cx%3D%2218%22%20cy%3D%2260.6484%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22503%22%20x%3D%2227%22%20y%3D%2263.9951%22%3Eregister(ServiceMetadata%20metadata%2C%20List%26lt%3BServiceURL%26gt%3B%20serviceURLs)%3A%20void%3C%2Ftext%3E%3Cellipse%20cx%3D%2218%22%20cy%3D%2276.9453%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22301%22%20x%3D%2227%22%20y%3D%2280.292%22%3Eunregister(ServiceMetadata%20metadata)%3A%20void%3C%2Ftext%3E%3Cellipse%20cx%3D%2218%22%20cy%3D%2293.2422%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22628%22%20x%3D%2227%22%20y%3D%2296.5889%22%3Esubscribe(Protocol%20protocol%2C%20ServiceMetadata%20metadata%2C%20RawAddressListener%20listener)%3A%20void%3C%2Ftext%3E%3Cellipse%20cx%3D%2218%22%20cy%3D%22109.5391%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22646%22%20x%3D%2227%22%20y%3D%22112.8857%22%3Eunsubscribe(Protocol%20protocol%2C%20ServiceMetadata%20metadata%2C%20RawAddressListener%20listener)%3A%20void%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_ServiceMetadata%22%3E%3Crect%20codeLine%3D%228%22%20fill%3D%22%23F1F1F1%22%20height%3D%2248%22%20id%3D%22ServiceMetadata%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22146%22%20x%3D%22207%22%20y%3D%22180%22%2F%3E%3Cellipse%20cx%3D%22222%22%20cy%3D%22196%22%20fill%3D%22%23ADD1B2%22%20rx%3D%2211%22%20ry%3D%2211%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpath%20d%3D%22M224.9688%2C201.6406%20Q224.3906%2C201.9375%20223.75%2C202.0781%20Q223.1094%2C202.2344%20222.4063%2C202.2344%20Q219.9063%2C202.2344%20218.5781%2C200.5938%20Q217.2656%2C198.9375%20217.2656%2C195.8125%20Q217.2656%2C192.6875%20218.5781%2C191.0313%20Q219.9063%2C189.375%20222.4063%2C189.375%20Q223.1094%2C189.375%20223.75%2C189.5313%20Q224.4063%2C189.6875%20224.9688%2C189.9844%20L224.9688%2C192.7031%20Q224.3438%2C192.125%20223.75%2C191.8594%20Q223.1563%2C191.5781%20222.5313%2C191.5781%20Q221.1875%2C191.5781%20220.5%2C192.6563%20Q219.8125%2C193.7188%20219.8125%2C195.8125%20Q219.8125%2C197.9063%20220.5%2C198.9844%20Q221.1875%2C200.0469%20222.5313%2C200.0469%20Q223.1563%2C200.0469%20223.75%2C199.7813%20Q224.3438%2C199.5%20224.9688%2C198.9219%20L224.9688%2C201.6406%20Z%20%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22114%22%20x%3D%22236%22%20y%3D%22200.8467%22%3EServiceMetadata%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22208%22%20x2%3D%22352%22%20y1%3D%22212%22%20y2%3D%22212%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22208%22%20x2%3D%22352%22%20y1%3D%22220%22%20y2%3D%22220%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_ServiceURL%22%3E%3Crect%20codeLine%3D%2211%22%20fill%3D%22%23F1F1F1%22%20height%3D%22129.4844%22%20id%3D%22ServiceURL%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22338%22%20x%3D%22174%22%20y%3D%22288%22%2F%3E%3Cellipse%20cx%3D%22300.25%22%20cy%3D%22304%22%20fill%3D%22%23B4A7E5%22%20rx%3D%2211%22%20ry%3D%2211%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpath%20d%3D%22M296.1719%2C299.7656%20L296.1719%2C297.6094%20L303.5625%2C297.6094%20L303.5625%2C299.7656%20L301.0938%2C299.7656%20L301.0938%2C307.8438%20L303.5625%2C307.8438%20L303.5625%2C310%20L296.1719%2C310%20L296.1719%2C307.8438%20L298.6406%2C307.8438%20L298.6406%2C299.7656%20L296.1719%2C299.7656%20Z%20%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20font-style%3D%22italic%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2277%22%20x%3D%22320.75%22%20y%3D%22308.8467%22%3EServiceURL%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22175%22%20x2%3D%22511%22%20y1%3D%22320%22%20y2%3D%22320%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22175%22%20x2%3D%22511%22%20y1%3D%22328%22%20y2%3D%22328%22%2F%3E%3Cellipse%20cx%3D%22185%22%20cy%3D%22341.6484%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22139%22%20x%3D%22194%22%20y%3D%22344.9951%22%3EgetProtocol()%3A%20String%3C%2Ftext%3E%3Cellipse%20cx%3D%22185%22%20cy%3D%22357.9453%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22114%22%20x%3D%22194%22%20y%3D%22361.292%22%3EgetHost()%3A%20String%3C%2Ftext%3E%3Cellipse%20cx%3D%22185%22%20cy%3D%22374.2422%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2287%22%20x%3D%22194%22%20y%3D%22377.5889%22%3EgetPort()%3A%20int%3C%2Ftext%3E%3Cellipse%20cx%3D%22185%22%20cy%3D%22390.5391%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22221%22%20x%3D%22194%22%20y%3D%22393.8857%22%3EgetParameter(String%20key)%3A%20String%3C%2Ftext%3E%3Cellipse%20cx%3D%22185%22%20cy%3D%22406.8359%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22312%22%20x%3D%22194%22%20y%3D%22410.1826%22%3EgetConnectionSupport()%3A%20ConnectionSupport%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_ConnectionSupport%22%3E%3Crect%20codeLine%3D%2219%22%20fill%3D%22%23F1F1F1%22%20height%3D%2280.5938%22%20id%3D%22ConnectionSupport%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22268%22%20x%3D%22209%22%20y%3D%22477%22%2F%3E%3Cellipse%20cx%3D%22271.25%22%20cy%3D%22493%22%20fill%3D%22%23B4A7E5%22%20rx%3D%2211%22%20ry%3D%2211%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpath%20d%3D%22M267.1719%2C488.7656%20L267.1719%2C486.6094%20L274.5625%2C486.6094%20L274.5625%2C488.7656%20L272.0938%2C488.7656%20L272.0938%2C496.8438%20L274.5625%2C496.8438%20L274.5625%2C499%20L267.1719%2C499%20L267.1719%2C496.8438%20L269.6406%2C496.8438%20L269.6406%2C488.7656%20L267.1719%2C488.7656%20Z%20%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20font-style%3D%22italic%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22135%22%20x%3D%22291.75%22%20y%3D%22497.8467%22%3EConnectionSupport%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22210%22%20x2%3D%22476%22%20y1%3D%22509%22%20y2%3D%22509%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22210%22%20x2%3D%22476%22%20y1%3D%22517%22%20y2%3D%22517%22%2F%3E%3Cellipse%20cx%3D%22220%22%20cy%3D%22530.6484%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22231%22%20x%3D%22229%22%20y%3D%22533.9951%22%3EpollConnectionID()%3A%20ConnectionID%3C%2Ftext%3E%3Cellipse%20cx%3D%22220%22%20cy%3D%22546.9453%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22242%22%20x%3D%22229%22%20y%3D%22550.292%22%3EpeekConnectionID()%3A%20ConnectionID%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_ConnectionID%22%3E%3Crect%20codeLine%3D%2224%22%20fill%3D%22%23F1F1F1%22%20height%3D%2280.5938%22%20id%3D%22ConnectionID%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22222%22%20x%3D%22232%22%20y%3D%22618%22%2F%3E%3Cellipse%20cx%3D%22291.75%22%20cy%3D%22634%22%20fill%3D%22%23B4A7E5%22%20rx%3D%2211%22%20ry%3D%2211%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpath%20d%3D%22M287.6719%2C629.7656%20L287.6719%2C627.6094%20L295.0625%2C627.6094%20L295.0625%2C629.7656%20L292.5938%2C629.7656%20L292.5938%2C637.8438%20L295.0625%2C637.8438%20L295.0625%2C640%20L287.6719%2C640%20L287.6719%2C637.8438%20L290.1406%2C637.8438%20L290.1406%2C629.7656%20L287.6719%2C629.7656%20Z%20%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20font-style%3D%22italic%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2294%22%20x%3D%22312.25%22%20y%3D%22638.8467%22%3EConnectionID%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22233%22%20x2%3D%22453%22%20y1%3D%22650%22%20y2%3D%22650%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22233%22%20x2%3D%22453%22%20y1%3D%22658%22%20y2%3D%22658%22%2F%3E%3Cellipse%20cx%3D%22243%22%20cy%3D%22671.6484%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2296%22%20x%3D%22252%22%20y%3D%22674.9951%22%3EgetID()%3A%20String%3C%2Ftext%3E%3Cellipse%20cx%3D%22243%22%20cy%3D%22687.9453%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22196%22%20x%3D%22252%22%20y%3D%22691.292%22%3EgetServiceURL()%3A%20ServiceURL%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_ClientStream%22%3E%3Crect%20codeLine%3D%2229%22%20fill%3D%22%23F1F1F1%22%20height%3D%2280.5938%22%20id%3D%22ClientStream%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22434%22%20x%3D%22126%22%20y%3D%22759%22%2F%3E%3Cellipse%20cx%3D%22294.75%22%20cy%3D%22775%22%20fill%3D%22%23B4A7E5%22%20rx%3D%2211%22%20ry%3D%2211%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpath%20d%3D%22M290.6719%2C770.7656%20L290.6719%2C768.6094%20L298.0625%2C768.6094%20L298.0625%2C770.7656%20L295.5938%2C770.7656%20L295.5938%2C778.8438%20L298.0625%2C778.8438%20L298.0625%2C781%20L290.6719%2C781%20L290.6719%2C778.8438%20L293.1406%2C778.8438%20L293.1406%2C770.7656%20L290.6719%2C770.7656%20Z%20%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20font-style%3D%22italic%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2288%22%20x%3D%22315.25%22%20y%3D%22779.8467%22%3EClientStream%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22127%22%20x2%3D%22559%22%20y1%3D%22791%22%20y2%3D%22791%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22127%22%20x2%3D%22559%22%20y1%3D%22799%22%20y2%3D%22799%22%2F%3E%3Cellipse%20cx%3D%22137%22%20cy%3D%22812.6484%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22205%22%20x%3D%22146%22%20y%3D%22815.9951%22%3EconnectionID()%3A%20ConnectionID%3C%2Ftext%3E%3Cellipse%20cx%3D%22137%22%20cy%3D%22828.9453%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22408%22%20x%3D%22146%22%20y%3D%22832.292%22%3Ewrite(Invocation%20invocation)%3A%20ListenableFuture%26lt%3BRPCResult%26gt%3B%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22link_Registry_ServiceMetadata%22%3E%3Cpath%20codeLine%3D%2234%22%20d%3D%22M317.738%2C120.035%20C308.222%2C140.957%20300.3985%2C158.1565%20292.9635%2C174.5005%20%22%20fill%3D%22none%22%20id%3D%22Registry-to-ServiceMetadata%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22290.479%2C179.962%2C297.8467%2C173.4261%2C292.5494%2C175.4108%2C290.5647%2C170.1135%2C290.479%2C179.962%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2223%22%20x%3D%22290.0279%22%20y%3D%22140.3029%22%3E0..*%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2223%22%20x%3D%22267.2174%22%20y%3D%22168.9643%22%3E0..*%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22link_Registry_ServiceURL%22%3E%3Cpath%20codeLine%3D%2235%22%20d%3D%22M359.313%2C120.114%20C364.078%2C138.953%20368.638%2C160.23%20371%2C180%20C375.277%2C215.797%20370.8069%2C249.6971%20363.3869%2C281.9061%20%22%20fill%3D%22none%22%20id%3D%22Registry-to-ServiceURL%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22362.04%2C287.753%2C367.9583%2C279.8807%2C363.1625%2C282.8806%2C360.1625%2C278.0848%2C362.04%2C287.753%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2223%22%20x%3D%22336.9297%22%20y%3D%22140.392%22%3E0..*%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2223%22%20x%3D%22339.8647%22%20y%3D%22276.8987%22%3E0..*%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22link_ServiceMetadata_ServiceURL%22%3E%3Cpath%20codeLine%3D%2236%22%20d%3D%22M289.983%2C228.213%20C296.922%2C244.35%20304.1586%2C261.1801%20313.2916%2C282.4171%20%22%20fill%3D%22none%22%20id%3D%22ServiceMetadata-to-ServiceURL%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22315.662%2C287.929%2C315.781%2C278.0809%2C313.6867%2C283.3357%2C308.4318%2C281.2414%2C315.662%2C287.929%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%228%22%20x%3D%22283.4414%22%20y%3D%22248.0261%22%3E1%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2223%22%20x%3D%22288.4141%22%20y%3D%22277.0939%22%3E0..*%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22link_ServiceURL_ConnectionSupport%22%3E%3Cpath%20codeLine%3D%2237%22%20d%3D%22M343%2C429.454%20C343%2C449.433%20343%2C452.888%20343%2C470.704%20%22%20fill%3D%22none%22%20id%3D%22ServiceURL-ConnectionSupport%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22none%22%20points%3D%22343%2C417.454%2C339%2C423.454%2C343%2C429.454%2C347%2C423.454%2C343%2C417.454%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22343%2C476.704%2C347%2C467.704%2C343%2C471.704%2C339%2C467.704%2C343%2C476.704%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%228%22%20x%3D%22334.5625%22%20y%3D%22437.4263%22%3E1%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%228%22%20x%3D%22334.3375%22%20y%3D%22465.8165%22%3E1%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22link_ConnectionSupport_ConnectionID%22%3E%3Cpath%20codeLine%3D%2238%22%20d%3D%22M343%2C570.332%20C343%2C588.944%20343%2C593.05%20343%2C611.662%20%22%20fill%3D%22none%22%20id%3D%22ConnectionSupport-ConnectionID%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22none%22%20points%3D%22343%2C558.332%2C339%2C564.332%2C343%2C570.332%2C347%2C564.332%2C343%2C558.332%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22343%2C617.662%2C347%2C608.662%2C343%2C612.662%2C339%2C608.662%2C343%2C617.662%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%228%22%20x%3D%22334.4125%22%20y%3D%22577.5372%22%3E1%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2223%22%20x%3D%22318.1672%22%20y%3D%22607.068%22%3E1..*%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22link_ConnectionID_ClientStream%22%3E%3Cpath%20codeLine%3D%2239%22%20d%3D%22M343%2C699.332%20C343%2C717.944%20343%2C734.0499%20343%2C752.6624%20%22%20fill%3D%22none%22%20id%3D%22ConnectionID-to-ClientStream%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22343%2C758.6624%2C347%2C749.6624%2C343%2C753.6624%2C339%2C749.6624%2C343%2C758.6624%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%228%22%20x%3D%22334.4125%22%20y%3D%22718.5372%22%3E1%3C%2Ftext%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%228%22%20x%3D%22334.3625%22%20y%3D%22748.0684%22%3E1%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E"  lazyload></a></p>
<h2 id="5-2-服务发布"><a href="#5-2-服务发布" class="headerlink" title="5.2 服务发布"></a>5.2 服务发布</h2><p>服务发布的基本流程：</p>
<ol>
<li><p><code>init</code>：初始化服务元信息<code>ServiceMetadata</code>，其中初始化了<code>protocolFilterChain</code>作为协议过滤器链，通过SPI机制加载；</p>
</li>
<li><p><code>export</code>：发布<code>ServiceMetadata</code>，异步任务中执行<code>protocolFilterChain</code>链里的每个过滤器的<code>export()</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;ServiceURL&gt; <span class="title function_">export</span><span class="params">(ServiceMetadata serviceMetadata, InvocationHandler invocationHandler)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>RegistryProtocolInterceptor</code>作为<code>protocolFilterChain</code>中一个拦截器，在<code>export()</code>里完成服务发布动作；</p>
</li>
<li><p>默认使用<code>ConfigServerRegistry</code>作为<code>Registry</code>的实现类完成向ConfigServer发布服务信息；</p>
</li>
</ol>
<p>服务发布在<code>RegistryProtocolInterceptor</code>中实现，支持同时向不同的注册中心发布服务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RegistryProtocolInterceptor#export</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;ServiceURL&gt; <span class="title function_">export</span><span class="params">(ServiceMetadata serviceMetadata, InvocationHandler invocationHandler)</span> &#123;</span><br><span class="line">    List&lt;ServiceURL&gt; serviceURLs = protocol.export(serviceMetadata, invocationHandler);</span><br><span class="line">    <span class="comment">// 返回true则表示可以发布到注册中心</span></span><br><span class="line">    <span class="keyword">if</span> (serviceMetadata.isRegistryPub()) &#123;</span><br><span class="line">        <span class="comment">// 向注册中心列表中的每一个注册中心发布</span></span><br><span class="line">        List&lt;Registry&gt; registries = serviceMetadata.getRegistries();</span><br><span class="line">        <span class="keyword">for</span> (Registry registry : registries) &#123;</span><br><span class="line">            registry.register(serviceMetadata, serviceURLs);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> serviceURLs;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用<code>ConfigServer</code>的客户端<code>ConfigClient</code>的API发布数据。注册中心结构类似<code>Map&lt;String, List&lt;Object&gt;&gt;</code>，包含了几个数据：</p>
<ul>
<li><p><code>publisherId</code></p>
<p>发布者，格式为：<code>HSFProvider-服务全类名:版本</code>，例如<code>HSFProvider-com.alibaba.middleware.hsf.guide.api.service.HelloWorldService:1.0.0</code></p>
</li>
<li><p><code>dataID</code></p>
<p>类似发布的key，格式为<code>服务全类名:版本</code>，例如<code>com.alibaba.middleware.hsf.guide.api.service.HelloWorldService:1.0.0</code></p>
</li>
<li><p><code>data</code></p>
<p>类似发布的value，封装了服务的各类信息，包括IP+端口，序列化协议，超时等，例如<code>30.8.88.143:61231?_p=hessian2&amp;v=2.0&amp;_TIMEOUT=3000&amp;_ih2=y&amp;_SERIALIZETYPE=hessian&amp;ut=CENTER</code></p>
</li>
</ul>
<p>代码参考<code>com.taobao.hsf.registry.cs.ConfigServerRegistry#doRegister</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ConfigServerRegistry#doRegister</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doRegister</span><span class="params">(ServiceMetadata metadata, String serviceURL, String protocol, String csCluster,</span></span><br><span class="line"><span class="params">                        Map&lt;String, PublisherRegistrationPair&gt; service2PublisherMap)</span> &#123;</span><br><span class="line">    <span class="comment">// 避免重复发布</span></span><br><span class="line">    <span class="keyword">if</span> (service2PublisherMap.containsKey(metadata.getUniqueName())) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 填充发布的信息</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">publisherId</span> <span class="operator">=</span> PUBLISHER_PREFIX + metadata.getUniqueName();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">dataID</span> <span class="operator">=</span> generateDataId(metadata, protocol);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> protocol.equalsIgnoreCase(<span class="string">&quot;hsf&quot;</span>) ? serviceURL.substring(<span class="string">&quot;hsf://&quot;</span>.length()) : serviceURL;</span><br><span class="line"></span><br><span class="line">    PublisherRegistration&lt;String&gt; registration = <span class="keyword">new</span> <span class="title class_">PublisherRegistration</span>&lt;String&gt;(publisherId, dataID);</span><br><span class="line">    <span class="comment">// 设置分组，默认为HSF</span></span><br><span class="line">    registration.setGroup(metadata.getGroup());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// configclient do not recognize DEFAULT as a center id</span></span><br><span class="line">    <span class="keyword">if</span> (!DEFAULT.equals(csCluster)) &#123;</span><br><span class="line">        registration.setLocalAttribute(LocalAttribute.ATTRIBUTE_CENTER, csCluster);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 使用ConfigClient发布到ConfigServer</span></span><br><span class="line">    Publisher&lt;String&gt; publisher = PublisherRegistrar.register(registration);</span><br><span class="line">    publisher.publish(data);</span><br><span class="line">    service2PublisherMap.put(metadata.getUniqueName(), <span class="keyword">new</span> <span class="title class_">PublisherRegistrationPair</span>(publisher, registration));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-3-服务订阅"><a href="#5-3-服务订阅" class="headerlink" title="5.3 服务订阅"></a>5.3 服务订阅</h2><h3 id="5-3-1-基本流程"><a href="#5-3-1-基本流程" class="headerlink" title="5.3.1 基本流程"></a>5.3.1 基本流程</h3><p>服务订阅的基本流程与服务发布类似：</p>
<ol>
<li><p>init - 也是初始化服务元信息<code>ServiceMetadata</code>，在<code>HSFApiConsumerBean</code> 的<code>init()</code>中；</p>
</li>
<li><p>refersync - 通过<code>ServiceMetadata</code>的<code>referSync()</code>方法开始同步订阅服务；</p>
</li>
<li><p>依次执行<code>protocolFilterChain</code>中拦截器的<code>refer()</code>，在<code>RegistryProtocolInterceptor</code>中，委托</p>
<p><code>RegistryInvocationHandler</code>来进行订阅；</p>
<ul>
<li><code>RegistryInvocationHandler</code>会初始化一条<code>RawAddressListener</code>的链，后面收到地址变更通知时，会执行链上的监听器方法，参考<code>start()</code>方法</li>
</ul>
</li>
<li><p>默认使用<code>ConfigServerRegistry</code>作为<code>Registry</code>的实现类完成服务订阅；</p>
</li>
<li><p>使用指定的listener监听注册中心发来的数据；</p>
</li>
</ol>
<p>订阅同样使用<code>ConfigClient</code>的API，需要提供与发布服务相同的dataId和group。参考<code>com.taobao.hsf.registry.cs.ConfigServerRegistry#subscribe()</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(<span class="keyword">final</span> String protocol, <span class="keyword">final</span> ServiceMetadata metadata,</span></span><br><span class="line"><span class="params">                       <span class="keyword">final</span> MergeDataSource.MySubscriberDataObserver listener, String csCluster)</span> &#123;</span><br><span class="line">    <span class="comment">// 配置与发布服务相同的dataID和group</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">cs_subscriberId</span> <span class="operator">=</span> SUBSCRIBER_PREFIX + metadata.getUniqueName();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">dataID</span> <span class="operator">=</span> generateDataId(metadata, protocol);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">group</span> <span class="operator">=</span> metadata.getGroup();</span><br><span class="line">    <span class="comment">// 使用ConfigClient API完成服务订阅</span></span><br><span class="line">    <span class="type">SubscriberRegistration</span> <span class="variable">cs_registration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubscriberRegistration</span>(cs_subscriberId, dataID);</span><br><span class="line">    <span class="keyword">if</span> (!DEFAULT.equals(csCluster)) &#123;</span><br><span class="line">        cs_registration.setLocalAttribute(LocalAttribute.ATTRIBUTE_CENTER, csCluster);</span><br><span class="line">    &#125;</span><br><span class="line">    cs_registration.setGroup(group);</span><br><span class="line">    <span class="type">Subscriber</span> <span class="variable">subscriber</span> <span class="operator">=</span> SubscriberRegistrar.register(cs_registration);</span><br><span class="line">    subscriber.setDataObserver(listener);</span><br><span class="line">    listener.setSubscriber(subscriber);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-2-地址监听器"><a href="#5-3-2-地址监听器" class="headerlink" title="5.3.2 地址监听器"></a>5.3.2 地址监听器</h3><h4 id="5-3-2-1-分类"><a href="#5-3-2-1-分类" class="headerlink" title="5.3.2.1 分类"></a>5.3.2.1 分类</h4><p>服务订阅后，需要指定一个<code>Observer</code>来侦听从注册中心<code>ConfigServer</code>发来的消息。具体处理逻辑交给地址监听器。</p>
<p>HSF定义了两类地址监听器的抽象来处理地址变更消息，区别在于地址的表示结构不同：面向原生字符串的地址监听器<code>RawAddressListener</code>，和将字符串在客户端转化为<code>ServiceURL</code>后的地址监听器<code>AddressListener</code>：</p>
<ul>
<li><p><code>RawAddressListener</code>。在<code>Observer</code>收到数据时，会通知<code>RawAddressListener</code>进行处理。<code>RawAddressListener</code>链在<code>RegistryInvocationHandler</code>启动时时初始化。这里处理的地址还是字符串表示的地址，类似<code>30.8.88.143:61231?_p=hessian2&amp;v=2.0&amp;_TIMEOUT=3000&amp;_ih2=y&amp;_SERIALIZETYPE=hessian&amp;ut=CENTER</code>，即服务发布方发给ConfigServer的原始数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RawAddressListener</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">     * 来自注册中心registry对于流程protocol关于服务元数据serviceMetadata的通知，通知内容是addresses</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registry        注册中心</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> protocol        流程</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> serviceMetadata 服务元数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> addresses       地址列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">notify</span><span class="params">(Registry registry, Protocol protocol, ServiceMetadata serviceMetadata, List&lt;String&gt; addresses)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>AddressListener</code>。HSF框架中对服务地址使用<code>ServiceURL</code>对象表示，在处理时也是根据这个对象结构来处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AddressListener</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 流程订阅服务serviceMetadata，收到订阅地址的列表</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registry        注册中心</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> protocol        流程</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> serviceMetadata 服务元数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> addresses       地址列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">notify</span><span class="params">(Registry registry, Protocol protocol, ServiceMetadata serviceMetadata, List&lt;ServiceURL&gt; addresses)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="5-3-2-2-构造"><a href="#5-3-2-2-构造" class="headerlink" title="5.3.2.2 构造"></a>5.3.2.2 构造</h4><p><code>RegistryInvocationHandler</code>构造了一条地址监听器的链。因为HSF客户端在订阅时，需要处理地址分片、路由等复杂逻辑，为了便于扩展，HSF设计使用SPI加载不同的地址监听器成为链式结构，在链上的每个节点做扩展处理。</p>
<p>两类地址监听器<code>RawAddressListener</code>和<code>AddressListener</code>通过<code>RawAddressListenerAdaptor</code>桥接，串联成一条完整的地址监听器链：</p>
<ul>
<li>链的起点是<code>RawAddressListenerInterceptor</code>，直接对订阅得到的原生地址做处理；</li>
<li>链的中间点是<code>RawAddressListenerAdaptor</code>，前面衔接<code>RawAddressListenerInterceptor</code>，后面衔接<code>AddressListenerInterceptor</code>，将原生地址字符串转换为<code>ServiceURL</code>；</li>
<li>链的终点是<code>HeadRouter</code>，是<code>Router</code>链的起点，用于地址路由。因为位于地址监听器链上，最终地址变更会通知到路由链；</li>
</ul>
<p><a class="simple-lightbox" href="data:image/svg+xml;utf8,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22us-ascii%22%20standalone%3D%22no%22%3F%3E%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20contentStyleType%3D%22text%2Fcss%22%20height%3D%22178px%22%20preserveAspectRatio%3D%22none%22%20style%3D%22width%3A814px%3Bheight%3A178px%3Bbackground%3A%23FFFFFF%3B%22%20version%3D%221.1%22%20viewBox%3D%220%200%20814%20178%22%20width%3D%22814px%22%20zoomAndPan%3D%22magnify%22%3E%3Cdefs%2F%3E%3Cg%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22120%22%20x2%3D%22120%22%20y1%3D%2236.2969%22%20y2%3D%22143.6953%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22350%22%20x2%3D%22350%22%20y1%3D%2236.2969%22%20y2%3D%22143.6953%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22566%22%20x2%3D%22566%22%20y1%3D%2236.2969%22%20y2%3D%22143.6953%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22745%22%20x2%3D%22745%22%20y1%3D%2236.2969%22%20y2%3D%22143.6953%22%2F%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22231%22%20x%3D%225%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22217%22%20x%3D%2212%22%20y%3D%2224.9951%22%3ERawAddressListenerInterceptor%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22231%22%20x%3D%225%22%20y%3D%22142.6953%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22217%22%20x%3D%2212%22%20y%3D%22162.6904%22%3ERawAddressListenerInterceptor%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22209%22%20x%3D%22246%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22195%22%20x%3D%22253%22%20y%3D%2224.9951%22%3ERawAddressListenerAdaptor%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22209%22%20x%3D%22246%22%20y%3D%22142.6953%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22195%22%20x%3D%22253%22%20y%3D%22162.6904%22%3ERawAddressListenerAdaptor%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22202%22%20x%3D%22465%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22188%22%20x%3D%22472%22%20y%3D%2224.9951%22%3EAddressListenerInterceptor%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22202%22%20x%3D%22465%22%20y%3D%22142.6953%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22188%22%20x%3D%22472%22%20y%3D%22162.6904%22%3EAddressListenerInterceptor%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22126%22%20x%3D%22682%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22112%22%20x%3D%22689%22%20y%3D%2224.9951%22%3EAddressListener%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22126%22%20x%3D%22682%22%20y%3D%22142.6953%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22112%22%20x%3D%22689%22%20y%3D%22162.6904%22%3EAddressListener%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22338.5%2C63.4297%2C348.5%2C67.4297%2C338.5%2C71.4297%2C342.5%2C67.4297%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22120.5%22%20x2%3D%22344.5%22%20y1%3D%2267.4297%22%20y2%3D%2267.4297%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22121%22%20x%3D%22127.5%22%20y%3D%2262.3638%22%3Enotify%20List%26lt%3BString%26gt%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22554%2C92.5625%2C564%2C96.5625%2C554%2C100.5625%2C558%2C96.5625%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22350.5%22%20x2%3D%22560%22%20y1%3D%2296.5625%22%20y2%3D%2296.5625%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22155%22%20x%3D%22357.5%22%20y%3D%2291.4966%22%3Enotify%20List%26lt%3BServiceURL%26gt%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22733%2C121.6953%2C743%2C125.6953%2C733%2C129.6953%2C737%2C125.6953%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22566%22%20x2%3D%22739%22%20y1%3D%22125.6953%22%20y2%3D%22125.6953%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22155%22%20x%3D%22573%22%20y%3D%22120.6294%22%3Enotify%20List%26lt%3BServiceURL%26gt%3B%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fsvg%3E"><img   src="/images/loading.svg" data-src="data:image/svg+xml;utf8,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22us-ascii%22%20standalone%3D%22no%22%3F%3E%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20contentStyleType%3D%22text%2Fcss%22%20height%3D%22178px%22%20preserveAspectRatio%3D%22none%22%20style%3D%22width%3A814px%3Bheight%3A178px%3Bbackground%3A%23FFFFFF%3B%22%20version%3D%221.1%22%20viewBox%3D%220%200%20814%20178%22%20width%3D%22814px%22%20zoomAndPan%3D%22magnify%22%3E%3Cdefs%2F%3E%3Cg%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22120%22%20x2%3D%22120%22%20y1%3D%2236.2969%22%20y2%3D%22143.6953%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22350%22%20x2%3D%22350%22%20y1%3D%2236.2969%22%20y2%3D%22143.6953%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22566%22%20x2%3D%22566%22%20y1%3D%2236.2969%22%20y2%3D%22143.6953%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22745%22%20x2%3D%22745%22%20y1%3D%2236.2969%22%20y2%3D%22143.6953%22%2F%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22231%22%20x%3D%225%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22217%22%20x%3D%2212%22%20y%3D%2224.9951%22%3ERawAddressListenerInterceptor%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22231%22%20x%3D%225%22%20y%3D%22142.6953%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22217%22%20x%3D%2212%22%20y%3D%22162.6904%22%3ERawAddressListenerInterceptor%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22209%22%20x%3D%22246%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22195%22%20x%3D%22253%22%20y%3D%2224.9951%22%3ERawAddressListenerAdaptor%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22209%22%20x%3D%22246%22%20y%3D%22142.6953%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22195%22%20x%3D%22253%22%20y%3D%22162.6904%22%3ERawAddressListenerAdaptor%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22202%22%20x%3D%22465%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22188%22%20x%3D%22472%22%20y%3D%2224.9951%22%3EAddressListenerInterceptor%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22202%22%20x%3D%22465%22%20y%3D%22142.6953%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22188%22%20x%3D%22472%22%20y%3D%22162.6904%22%3EAddressListenerInterceptor%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22126%22%20x%3D%22682%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22112%22%20x%3D%22689%22%20y%3D%2224.9951%22%3EAddressListener%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22126%22%20x%3D%22682%22%20y%3D%22142.6953%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22112%22%20x%3D%22689%22%20y%3D%22162.6904%22%3EAddressListener%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22338.5%2C63.4297%2C348.5%2C67.4297%2C338.5%2C71.4297%2C342.5%2C67.4297%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22120.5%22%20x2%3D%22344.5%22%20y1%3D%2267.4297%22%20y2%3D%2267.4297%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22121%22%20x%3D%22127.5%22%20y%3D%2262.3638%22%3Enotify%20List%26lt%3BString%26gt%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22554%2C92.5625%2C564%2C96.5625%2C554%2C100.5625%2C558%2C96.5625%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22350.5%22%20x2%3D%22560%22%20y1%3D%2296.5625%22%20y2%3D%2296.5625%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22155%22%20x%3D%22357.5%22%20y%3D%2291.4966%22%3Enotify%20List%26lt%3BServiceURL%26gt%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22733%2C121.6953%2C743%2C125.6953%2C733%2C129.6953%2C737%2C125.6953%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22566%22%20x2%3D%22739%22%20y1%3D%22125.6953%22%20y2%3D%22125.6953%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22155%22%20x%3D%22573%22%20y%3D%22120.6294%22%3Enotify%20List%26lt%3BServiceURL%26gt%3B%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fsvg%3E"  lazyload></a></p>
<p>构造流程：</p>
<ol>
<li><p>监听器链的构造入口在<code>RegistryInvocationHandler#start</code>：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RegistryInvocationHandler#start</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Registry&gt; registries = serviceMetadata.getRegistries();</span><br><span class="line">    <span class="keyword">for</span> (Registry registry : registries) &#123;</span><br><span class="line">        <span class="comment">//setup HeadRouter for each registry</span></span><br><span class="line">        <span class="type">HeadRouter</span> <span class="variable">headRouter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HeadRouter</span>(serviceMetadata);</span><br><span class="line">        RouterChainBuilder.build(serviceMetadata, headRouter, TailRouter.class);</span><br><span class="line">        <span class="comment">// 构建当前服务元数据的地址监听器链</span></span><br><span class="line">        <span class="type">RawAddressListener</span> <span class="variable">chain</span> <span class="operator">=</span> AddressListenerChainBuilder.build(serviceMetadata, protocol, headRouter);</span><br><span class="line"></span><br><span class="line">        registryClusterStrategyMap.put(registry, chain);</span><br><span class="line">        strategies.add(headRouter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    isBroadcast = serviceMetadata.isBroadcast();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>AddressListenerChainBuilder#build</code>构建chain</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> RawAddressListener <span class="title function_">build</span><span class="params">(ServiceMetadata serviceMetadata, Protocol protocol,</span></span><br><span class="line"><span class="params">                                       AddressListener addressListener)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载原生地址拦截器列表</span></span><br><span class="line">    List&lt;RawAddressListenerInterceptor&gt; handlers = HSFServiceContainer.getInstances(</span><br><span class="line">            RawAddressListenerInterceptor.class);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 省略，Aware类型判断和赋值</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造用于承前启后的RawAddressListenerAdaptor</span></span><br><span class="line">    <span class="type">RawAddressListenerAdaptor</span> <span class="variable">adaptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RawAddressListenerAdaptor</span>();</span><br><span class="line">    <span class="comment">// 构建地址监听器链</span></span><br><span class="line">    <span class="type">AddressListener</span> <span class="variable">addressListenerChain</span> <span class="operator">=</span> buildAddressListener(addressListener);</span><br><span class="line">    <span class="comment">// adaptor连接到地址监听器</span></span><br><span class="line">    adaptor.setAddressListener(addressListenerChain);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 串联原生监听器列表里的RawAddressListener，adaptor在最后</span></span><br><span class="line">    <span class="type">RawAddressListener</span> <span class="variable">last</span> <span class="operator">=</span> adaptor;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> handlers.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        handlers.get(i).setAddressListener(last);</span><br><span class="line">        last = handlers.get(i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> last;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构建地址监听器链，方法与原生地址监听器链类似</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> AddressListener <span class="title function_">buildAddressListener</span><span class="params">(AddressListener addressListener)</span> &#123;</span><br><span class="line">    List&lt;AddressListenerInterceptor&gt; handlers = HSFServiceContainer.getInstances(AddressListenerInterceptor.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//init</span></span><br><span class="line">    <span class="type">AddressListener</span> <span class="variable">last</span> <span class="operator">=</span> addressListener;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> handlers.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        handlers.get(i).setAddressListener(last);</span><br><span class="line">        last = handlers.get(i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> last;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="5-3-3-3-拦截器"><a href="#5-3-3-3-拦截器" class="headerlink" title="5.3.3.3 拦截器"></a>5.3.3.3 拦截器</h4><p>实际链上原生地址监听器和地址监听器的节点都是拦截器<code>RawAddressListenerInterceptor</code>或者<code>AddressListenerInterceptor</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Scope(Scope.Option.PROTOTYPE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RawAddressListenerInterceptor</span> <span class="keyword">extends</span> <span class="title class_">RawAddressListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setAddressListener</span><span class="params">(RawAddressListener rawAddressListener)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Scope(Scope.Option.PROTOTYPE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AddressListenerInterceptor</span> <span class="keyword">extends</span> <span class="title class_">AddressListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置下一个地址监听器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> addressListener 地址监听器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setAddressListener</span><span class="params">(AddressListener addressListener)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>关键的一点是可以看到它的Scope是PROTOTYPE，也就是说 <strong>我们之前形成的地址通知链，每个服务都会具备一条，而且服务和服务之间是不会共享这些节点实例的</strong> 。</p>
<p>一个服务一条调用链，一条地址通知链</p>
</blockquote>
<p>一些拦截器的实现持有了单个服务特有的信息，例如<code>AddressCalculateMergeInterceptor</code>中保存了ConfigServer每次推送数据的快照，因此HSF设计一个服务的拦截器Scope为PROTOTYPE，即一个服务一条调用链。</p>
<p>HSF内置了一系列拦截器，参考：</p>
<p><a target="_blank" rel="noopener" href="http://site.alibaba.net/middleware-container/hsf-guide/hsf-guide-book/chapter16-8.html">HSF2.2通常具备的原生地址拦截器</a></p>
<p><a target="_blank" rel="noopener" href="http://site.alibaba.net/middleware-container/hsf-guide/hsf-guide-book/chapter16-9.html">HSF2.2通常具备的地址拦截器</a></p>
<h2 id="5-4-总结"><a href="#5-4-总结" class="headerlink" title="5.4 总结"></a>5.4 总结</h2><ol>
<li><code>Registry</code>的功能：与注册中心（默认ConfigServer）交互，服务发布&#x2F;去发布，服务订阅&#x2F;去订阅；</li>
<li><code>RegistryProtocolInterceptor</code>作为<code>ProtocolInterceptor</code>的扩展，实现与注册中心的交互逻辑；</li>
<li>服务发布逻辑：向注册中心发布指定格式（dataId、data…）的地址数据，完成发布；</li>
<li>服务订阅逻辑：向注册中心订阅指定的“主题”，并使用地址监听器来处理地址变更通知；</li>
<li>服务订阅有两类地址监听器：<code>RawAddressListener</code>和<code>AddressListener</code>，区别在于地址的表示结构不一样。两类监听器组成一条监听器链，通过<code>RawAddressListenerAdaptor</code>在中间串联为一条完整的链；</li>
<li>监听器链的末端指向一个<code>HeadRouter</code>，因此地址变更最终会通知到路由器链；</li>
<li>监听器链里的节点类型实际上是<code>RawAddressListenerInterceptor</code>和<code>AddressListenerInterceptor</code>HSF提供了一系列默认的拦截器实现，也可以扩展；</li>
</ol>
<h1 id="6-应用领域2-Protocol"><a href="#6-应用领域2-Protocol" class="headerlink" title="6 应用领域2 - Protocol"></a>6 应用领域2 - Protocol</h1><h2 id="6-1-接口和能力"><a href="#6-1-接口和能力" class="headerlink" title="6.1 接口和能力"></a>6.1 接口和能力</h2><h3 id="6-1-1-Protocol"><a href="#6-1-1-Protocol" class="headerlink" title="6.1.1 Protocol"></a>6.1.1 <code>Protocol</code></h3><p><code>Protocol</code>对应HSF的流程接口，定义了一个服务在发布或者订阅过程中的步骤。实际上是负责了HSF整个领域中的服务注册与发现。参考<code>Protocol</code>接口定义：</p>
<p><a class="simple-lightbox" href="data:image/svg+xml;utf8,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22us-ascii%22%20standalone%3D%22no%22%3F%3E%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20contentStyleType%3D%22text%2Fcss%22%20height%3D%22166px%22%20preserveAspectRatio%3D%22none%22%20style%3D%22width%3A723px%3Bheight%3A166px%3Bbackground%3A%23FFFFFF%3B%22%20version%3D%221.1%22%20viewBox%3D%220%200%20723%20166%22%20width%3D%22723px%22%20zoomAndPan%3D%22magnify%22%3E%3Cdefs%2F%3E%3Cg%3E%3Cg%20id%3D%22elem_Protocol%22%3E%3Crect%20codeLine%3D%221%22%20fill%3D%22%23F1F1F1%22%20height%3D%22145.7813%22%20id%3D%22Protocol%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22702%22%20x%3D%227%22%20y%3D%227%22%2F%3E%3Cellipse%20cx%3D%22325.25%22%20cy%3D%2223%22%20fill%3D%22%23B4A7E5%22%20rx%3D%2211%22%20ry%3D%2211%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpath%20d%3D%22M321.1719%2C18.7656%20L321.1719%2C16.6094%20L328.5625%2C16.6094%20L328.5625%2C18.7656%20L326.0938%2C18.7656%20L326.0938%2C26.8438%20L328.5625%2C26.8438%20L328.5625%2C29%20L321.1719%2C29%20L321.1719%2C26.8438%20L323.6406%2C26.8438%20L323.6406%2C18.7656%20L321.1719%2C18.7656%20Z%20%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20font-style%3D%22italic%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2257%22%20x%3D%22345.75%22%20y%3D%2227.8467%22%3EProtocol%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%228%22%20x2%3D%22708%22%20y1%3D%2239%22%20y2%3D%2239%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%228%22%20x2%3D%22708%22%20y1%3D%2247%22%20y2%3D%2247%22%2F%3E%3Cellipse%20cx%3D%2218%22%20cy%3D%2260.6484%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22676%22%20x%3D%2227%22%20y%3D%2263.9951%22%3Eexport(ServiceMetadata%20serviceMetadata%2C%20InvocationHandler%20invocationHandler)%3A%20List%26lt%3BServiceURL%26gt%3B%3C%2Ftext%3E%3Cellipse%20cx%3D%2218%22%20cy%3D%2276.9453%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22340%22%20x%3D%2227%22%20y%3D%2280.292%22%3Eunexport(ServiceMetadata%20serviceMetadata)%3A%20void%3C%2Ftext%3E%3Cellipse%20cx%3D%2218%22%20cy%3D%2293.2422%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22405%22%20x%3D%2227%22%20y%3D%2296.5889%22%3Erefer(ServiceMetadata%20serviceMetadata)%3A%20InvocationHandler%3C%2Ftext%3E%3Cellipse%20cx%3D%2218%22%20cy%3D%22109.5391%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22328%22%20x%3D%2227%22%20y%3D%22112.8857%22%3Eunrefer(ServiceMetadata%20serviceMetadata)%3A%20void%3C%2Ftext%3E%3Cellipse%20cx%3D%2218%22%20cy%3D%22125.8359%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22259%22%20x%3D%2227%22%20y%3D%22129.1826%22%3EgetSupportedProtocol()%3A%20List%26lt%3BString%26gt%3B%3C%2Ftext%3E%3Cellipse%20cx%3D%2218%22%20cy%3D%22142.1328%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22502%22%20x%3D%2227%22%20y%3D%22145.4795%22%3Eaccept(ServiceMetadata%20serviceMetadata%2C%20String%20serviceURL)%3A%20ServiceURL%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E"><img   src="/images/loading.svg" data-src="data:image/svg+xml;utf8,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22us-ascii%22%20standalone%3D%22no%22%3F%3E%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20contentStyleType%3D%22text%2Fcss%22%20height%3D%22166px%22%20preserveAspectRatio%3D%22none%22%20style%3D%22width%3A723px%3Bheight%3A166px%3Bbackground%3A%23FFFFFF%3B%22%20version%3D%221.1%22%20viewBox%3D%220%200%20723%20166%22%20width%3D%22723px%22%20zoomAndPan%3D%22magnify%22%3E%3Cdefs%2F%3E%3Cg%3E%3Cg%20id%3D%22elem_Protocol%22%3E%3Crect%20codeLine%3D%221%22%20fill%3D%22%23F1F1F1%22%20height%3D%22145.7813%22%20id%3D%22Protocol%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22702%22%20x%3D%227%22%20y%3D%227%22%2F%3E%3Cellipse%20cx%3D%22325.25%22%20cy%3D%2223%22%20fill%3D%22%23B4A7E5%22%20rx%3D%2211%22%20ry%3D%2211%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpath%20d%3D%22M321.1719%2C18.7656%20L321.1719%2C16.6094%20L328.5625%2C16.6094%20L328.5625%2C18.7656%20L326.0938%2C18.7656%20L326.0938%2C26.8438%20L328.5625%2C26.8438%20L328.5625%2C29%20L321.1719%2C29%20L321.1719%2C26.8438%20L323.6406%2C26.8438%20L323.6406%2C18.7656%20L321.1719%2C18.7656%20Z%20%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20font-style%3D%22italic%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2257%22%20x%3D%22345.75%22%20y%3D%2227.8467%22%3EProtocol%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%228%22%20x2%3D%22708%22%20y1%3D%2239%22%20y2%3D%2239%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%228%22%20x2%3D%22708%22%20y1%3D%2247%22%20y2%3D%2247%22%2F%3E%3Cellipse%20cx%3D%2218%22%20cy%3D%2260.6484%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22676%22%20x%3D%2227%22%20y%3D%2263.9951%22%3Eexport(ServiceMetadata%20serviceMetadata%2C%20InvocationHandler%20invocationHandler)%3A%20List%26lt%3BServiceURL%26gt%3B%3C%2Ftext%3E%3Cellipse%20cx%3D%2218%22%20cy%3D%2276.9453%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22340%22%20x%3D%2227%22%20y%3D%2280.292%22%3Eunexport(ServiceMetadata%20serviceMetadata)%3A%20void%3C%2Ftext%3E%3Cellipse%20cx%3D%2218%22%20cy%3D%2293.2422%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22405%22%20x%3D%2227%22%20y%3D%2296.5889%22%3Erefer(ServiceMetadata%20serviceMetadata)%3A%20InvocationHandler%3C%2Ftext%3E%3Cellipse%20cx%3D%2218%22%20cy%3D%22109.5391%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22328%22%20x%3D%2227%22%20y%3D%22112.8857%22%3Eunrefer(ServiceMetadata%20serviceMetadata)%3A%20void%3C%2Ftext%3E%3Cellipse%20cx%3D%2218%22%20cy%3D%22125.8359%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22259%22%20x%3D%2227%22%20y%3D%22129.1826%22%3EgetSupportedProtocol()%3A%20List%26lt%3BString%26gt%3B%3C%2Ftext%3E%3Cellipse%20cx%3D%2218%22%20cy%3D%22142.1328%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22502%22%20x%3D%2227%22%20y%3D%22145.4795%22%3Eaccept(ServiceMetadata%20serviceMetadata%2C%20String%20serviceURL)%3A%20ServiceURL%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E"  lazyload></a></p>
<p>关键方法：</p>
<ul>
<li><code>export()</code> - Provider发布服务，serviceMetadata表示服务元数据，invocationHandler表示请求处理器；</li>
<li><code>refer()</code> - Consumer订阅服务，指定serviceMetadata作为待订阅服务的标识；</li>
</ul>
<p><code>Protocol</code>的默认实现是<code>HSFProtocol</code>。</p>
<h3 id="6-1-2-ProtocolInterceptor"><a href="#6-1-2-ProtocolInterceptor" class="headerlink" title="6.1.2 ProtocolInterceptor"></a>6.1.2 <code>ProtocolInterceptor</code></h3><p>在<code>Protocol</code>基础上，服务发布和订阅都需要支持扩展能力，在过程中做额外的操作。HSF定义了<code>ProtocolInterceptor</code>。<code>ProtocolInterceptor</code>继承<code>Protocol</code>接口，提供了一个<code>setProtocol(Protocol protocol)</code>方法来设置下一个<code>Protocol</code>，通过这种方式，不同功能的<code>ProtocolInterceptor</code>组成一条拦截器链。例如用于向注册中心发布服务的<code>RegistryProtocolInterceptor</code>也是链上的一个节点。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ProtocolInterceptor</span> <span class="keyword">extends</span> <span class="title class_">Protocol</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置后一个Interceptor</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> protocol 流程</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setProtocol</span><span class="params">(Protocol protocol)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>HSF提供了<code>ProtocolInterceptor</code>的抽象实现类<code>AbstractDelegateProtocolInterceptor</code>，提供每个方法的默认实现，不同功能的拦截器通过继承<code>AbstractDelegateProtocolInterceptor</code>并重写感兴趣的方法来实现功能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractDelegateProtocolInterceptor</span> <span class="keyword">implements</span> <span class="title class_">ProtocolInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Protocol protocol;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setProtocol</span><span class="params">(Protocol protocol)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.protocol = protocol;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;ServiceURL&gt; <span class="title function_">export</span><span class="params">(ServiceMetadata serviceMetadata, InvocationHandler invocationHandler)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> protocol.export(serviceMetadata,invocationHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unexport</span><span class="params">(ServiceMetadata serviceMetadata)</span> &#123;</span><br><span class="line">        protocol.unexport(serviceMetadata);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> InvocationHandler <span class="title function_">refer</span><span class="params">(ServiceMetadata serviceMetadata)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> protocol.refer(serviceMetadata);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unrefer</span><span class="params">(ServiceMetadata serviceMetadata)</span> &#123;</span><br><span class="line">        protocol.unrefer(serviceMetadata);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getSupportedProtocol</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> protocol.getSupportedProtocol();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ServiceURL <span class="title function_">accept</span><span class="params">(ServiceMetadata serviceMetadata, String serviceURL)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> protocol.accept(serviceMetadata, serviceURL);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="6-2-代码流程"><a href="#6-2-代码流程" class="headerlink" title="6.2 代码流程"></a>6.2 代码流程</h2><p>基本流程：</p>
<ol>
<li><code>ProtocolInterceptor</code>链初始化</li>
<li>服务发布&#x2F;订阅</li>
</ol>
<h3 id="6-2-1-构造ProtocolInterceptor链"><a href="#6-2-1-构造ProtocolInterceptor链" class="headerlink" title="6.2.1 构造ProtocolInterceptor链"></a>6.2.1 构造<code>ProtocolInterceptor</code>链</h3><p><code>ProtocolInterceptor</code>链的构造在初始化服务元数据<code>ServiceMetadata</code>时完成，对应<code>ServiceMetadata#init()</code>方法。一个<code>HSFApiConsumerBean</code>或者<code>HSFApiProviderBean</code>初始化时都会走到<code>ServiceMetadata#init()</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="comment">// 省略</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// SPI加载所有Protocol实例，默认是HSFProtocol</span></span><br><span class="line">    <span class="keyword">if</span> (protocols.isEmpty()) &#123;</span><br><span class="line">      protocols.addAll(applicationModel.getServiceContainer().getInstances(Protocol.class));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 构造ProtocolInterceptor链</span></span><br><span class="line">    protocolFilterChain = ProtocolInterceptorChainBuilder.build(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体的构造工作在<code>ProtocolInterceptorChainBuilder#build</code>中完成。类似的组装责任链代码在HSF中比较常见，例如组装<code>Registry</code>中的地址监听器<code>AddressListener</code>链。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">List&lt;ProtocolInterceptor&gt; handlers = HSFServiceContainer.getInstances(ProtocolInterceptor.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 默认</span></span><br><span class="line"><span class="type">Protocol</span> <span class="variable">last</span> <span class="operator">=</span> protocol;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> handlers.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">    handlers.get(i).setProtocol(last);</span><br><span class="line">    last = handlers.get(i);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> last;</span><br></pre></td></tr></table></figure>

<p>默认情况下，链上的最后一个节点是<code>HSFProtocol</code>，而之前是一系列不同功能的<code>ProtocolInterceptor</code>，按照<code>@Order</code>注解值排序。</p>
<p>参考<a target="_blank" rel="noopener" href="http://site.alibaba.net/middleware-container/hsf-guide/hsf-guide-book/chapter15-4.html">服务提供者的基本流程</a>：</p>
<blockquote>
<table>
<thead>
<tr>
<th>优先级</th>
<th>扩展点</th>
<th>功能描述</th>
</tr>
</thead>
<tbody><tr>
<td>10</td>
<td>MetadataReportProtocolInterceptor</td>
<td>发布接口元数据到redis</td>
</tr>
<tr>
<td>100</td>
<td>DelayPublishProtocolInterceptor</td>
<td>检测是否是延迟发布，如果是，将会设置不发布到注册中心</td>
</tr>
<tr>
<td>200</td>
<td>CodeployProtocolInterceptor</td>
<td>合并部署，非main应用不能发布服务</td>
</tr>
<tr>
<td>250</td>
<td>EagleEyeProtocolInterceptor</td>
<td>发布租户信息到ServiceURL</td>
</tr>
<tr>
<td>300</td>
<td>SiteProtocolInterceptor</td>
<td>发布机箱信息到ServiceURL</td>
</tr>
<tr>
<td>300</td>
<td>UnitProtocolInterceptor</td>
<td>发布单元信息到ServiceURL，中心不发单元服务</td>
</tr>
<tr>
<td>400</td>
<td>GroupingProtocolInterceptor</td>
<td>订阅服务的归组规则</td>
</tr>
<tr>
<td><strong>500</strong></td>
<td><strong>RegistryProtocolInterceptor</strong></td>
<td><strong>发布到注册中心或者取消注册中心的订阅</strong></td>
</tr>
<tr>
<td>600</td>
<td>ServicePubComponent</td>
<td>向应用的发布单注册需要发布的服务，更新发布单的服务状态</td>
</tr>
<tr>
<td>600</td>
<td>TPSRuleProtocolInterceptor</td>
<td>订阅服务的TPS限流规则</td>
</tr>
</tbody></table>
</blockquote>
<p>注：新版本中增加了几个新的<code>ProtocolInterceptor</code></p>
<table>
<thead>
<tr>
<th>优先级</th>
<th>扩展点</th>
<th>功能描述</th>
</tr>
</thead>
<tbody><tr>
<td>260</td>
<td>RegionProtocolInterceptor</td>
<td>处理区域Region信息</td>
</tr>
<tr>
<td>100</td>
<td>FilterProtocolInterceptor</td>
<td>载入RPCFilter扩展，与InvocationHandler组成一条链</td>
</tr>
</tbody></table>
<h3 id="6-2-2-服务发布"><a href="#6-2-2-服务发布" class="headerlink" title="6.2.2 服务发布"></a>6.2.2 服务发布</h3><p>基本流程：</p>
<ol>
<li><p>在<code>HSFApiProviderBean#init</code>时，触发服务元数据对象<code>ServiceMetadata</code>的初始化和异步发布动作：<code>ServiceMetadata#export</code>；</p>
</li>
<li><p>执行<code>ServiceMetadata</code>中的拦截器链<code>protocolFilterChain</code>，执行每一个<code>ProtocolInterceptor</code>的<code>export()</code>方法，拦截器的扩展逻辑放在<code>export()</code>之前或之后；</p>
</li>
<li><p>末尾节点<code>HSFProtocol</code>的<code>export()</code>方法执行时，完成以下动作：</p>
<ul>
<li>第一次调用时，启动HSF server服务端侦听，Server的默认实现用的Netty</li>
<li>通过<code>threadPoolService</code>为服务分配线程池</li>
<li>根据IP、端口和服务元信息生成Target地址信息，示例<code>hsf://1.1.1.1:52375?_p=hessian2&amp;v=2.0&amp;_TIMEOUT=3000&amp;_ih2=y&amp;_SERIALIZETYPE=hessian&amp;ut=CENTER</code>，并创建结构化对象<code>ServiceURL</code>返回</li>
</ul>
</li>
</ol>
<p><a class="simple-lightbox" href="data:image/svg+xml;utf8,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22us-ascii%22%20standalone%3D%22no%22%3F%3E%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20contentStyleType%3D%22text%2Fcss%22%20height%3D%22502px%22%20preserveAspectRatio%3D%22none%22%20style%3D%22width%3A863px%3Bheight%3A502px%3Bbackground%3A%23FFFFFF%3B%22%20version%3D%221.1%22%20viewBox%3D%220%200%20863%20502%22%20width%3D%22863px%22%20zoomAndPan%3D%22magnify%22%3E%3Cdefs%2F%3E%3Cg%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%22382.0625%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22200.5%22%20y%3D%2267.4297%22%2F%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%22331.9297%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22346.5%22%20y%3D%2296.5625%22%2F%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%22211.5313%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22507.5%22%20y%3D%22167.8281%22%2F%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%22141.3984%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22622.5%22%20y%3D%22223.9609%22%2F%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%2256.1328%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22763.5%22%20y%3D%22253.0938%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%2269%22%20x2%3D%2269%22%20y1%3D%2236.2969%22%20y2%3D%22467.4922%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22205%22%20x2%3D%22205%22%20y1%3D%2236.2969%22%20y2%3D%22467.4922%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22351%22%20x2%3D%22351%22%20y1%3D%2236.2969%22%20y2%3D%22467.4922%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22512%22%20x2%3D%22512%22%20y1%3D%2236.2969%22%20y2%3D%22467.4922%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22627.5%22%20x2%3D%22627.5%22%20y1%3D%2236.2969%22%20y2%3D%22467.4922%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22768.5%22%20x2%3D%22768.5%22%20y1%3D%2236.2969%22%20y2%3D%22467.4922%22%2F%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22128%22%20x%3D%225%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22114%22%20x%3D%2212%22%20y%3D%2224.9951%22%3EServiceMetadata%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22128%22%20x%3D%225%22%20y%3D%22466.4922%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22114%22%20x%3D%2212%22%20y%3D%22486.4873%22%3EServiceMetadata%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22125%22%20x%3D%22143%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22111%22%20x%3D%22150%22%20y%3D%2224.9951%22%3EMetadataReport%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22125%22%20x%3D%22143%22%20y%3D%22466.4922%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22111%22%20x%3D%22150%22%20y%3D%22486.4873%22%3EMetadataReport%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2277%22%20x%3D%22313%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2263%22%20x%3D%22320%22%20y%3D%2224.9951%22%3EEagleEye%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2277%22%20x%3D%22313%22%20y%3D%22466.4922%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2263%22%20x%3D%22320%22%20y%3D%22486.4873%22%3EEagleEye%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2241%22%20x%3D%22492%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2227%22%20x%3D%22499%22%20y%3D%2224.9951%22%3EUnit%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2241%22%20x%3D%22492%22%20y%3D%22466.4922%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2227%22%20x%3D%22499%22%20y%3D%22486.4873%22%3EUnit%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2270%22%20x%3D%22592.5%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2256%22%20x%3D%22599.5%22%20y%3D%2224.9951%22%3ERegistry%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2270%22%20x%3D%22592.5%22%20y%3D%22466.4922%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2256%22%20x%3D%22599.5%22%20y%3D%22486.4873%22%3ERegistry%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2272%22%20x%3D%22732.5%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2258%22%20x%3D%22739.5%22%20y%3D%2224.9951%22%3ETPSRule%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2272%22%20x%3D%22732.5%22%20y%3D%22466.4922%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2258%22%20x%3D%22739.5%22%20y%3D%22486.4873%22%3ETPSRule%3C%2Ftext%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%22382.0625%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22200.5%22%20y%3D%2267.4297%22%2F%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%22331.9297%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22346.5%22%20y%3D%2296.5625%22%2F%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%22211.5313%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22507.5%22%20y%3D%22167.8281%22%2F%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%22141.3984%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22622.5%22%20y%3D%22223.9609%22%2F%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%2256.1328%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22763.5%22%20y%3D%22253.0938%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22188.5%2C63.4297%2C198.5%2C67.4297%2C188.5%2C71.4297%2C192.5%2C67.4297%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2269%22%20x2%3D%22194.5%22%20y1%3D%2267.4297%22%20y2%3D%2267.4297%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2241%22%20x%3D%2276%22%20y%3D%2262.3638%22%3Eexport%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22334.5%2C92.5625%2C344.5%2C96.5625%2C334.5%2C100.5625%2C338.5%2C96.5625%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22210.5%22%20x2%3D%22340.5%22%20y1%3D%2296.5625%22%20y2%3D%2296.5625%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2241%22%20x%3D%22217.5%22%20y%3D%2291.4966%22%3Eexport%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22356.5%22%20x2%3D%22398.5%22%20y1%3D%22125.6953%22%20y2%3D%22125.6953%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22398.5%22%20x2%3D%22398.5%22%20y1%3D%22125.6953%22%20y2%3D%22138.6953%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22357.5%22%20x2%3D%22398.5%22%20y1%3D%22138.6953%22%20y2%3D%22138.6953%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22367.5%2C134.6953%2C357.5%2C138.6953%2C367.5%2C142.6953%2C363.5%2C138.6953%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22137%22%20x%3D%22363.5%22%20y%3D%22120.6294%22%3E%26%2321457%3B%26%2324067%3B%26%2331199%3B%26%2325143%3B%26%2321040%3BServiceURL%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22495.5%2C163.8281%2C505.5%2C167.8281%2C495.5%2C171.8281%2C499.5%2C167.8281%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22356.5%22%20x2%3D%22501.5%22%20y1%3D%22167.8281%22%20y2%3D%22167.8281%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2241%22%20x%3D%22363.5%22%20y%3D%22162.7622%22%3Eexport%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22517.5%22%20x2%3D%22559.5%22%20y1%3D%22196.9609%22%20y2%3D%22196.9609%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22559.5%22%20x2%3D%22559.5%22%20y1%3D%22196.9609%22%20y2%3D%22209.9609%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22518.5%22%20x2%3D%22559.5%22%20y1%3D%22209.9609%22%20y2%3D%22209.9609%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22528.5%2C205.9609%2C518.5%2C209.9609%2C528.5%2C213.9609%2C524.5%2C209.9609%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2291%22%20x%3D%22524.5%22%20y%3D%22191.895%22%3E%26%2321333%3B%26%2320803%3B%26%2321270%3B%26%2321457%3B%26%2324067%3B%26%2335268%3B%26%2321017%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22610.5%2C219.9609%2C620.5%2C223.9609%2C610.5%2C227.9609%2C614.5%2C223.9609%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22517.5%22%20x2%3D%22616.5%22%20y1%3D%22223.9609%22%20y2%3D%22223.9609%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22751.5%2C249.0938%2C761.5%2C253.0938%2C751.5%2C257.0938%2C755.5%2C253.0938%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22632.5%22%20x2%3D%22757.5%22%20y1%3D%22253.0938%22%20y2%3D%22253.0938%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2241%22%20x%3D%22639.5%22%20y%3D%22248.0278%22%3Eexport%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22773.5%22%20x2%3D%22815.5%22%20y1%3D%22282.2266%22%20y2%3D%22282.2266%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22815.5%22%20x2%3D%22815.5%22%20y1%3D%22282.2266%22%20y2%3D%22295.2266%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22774.5%22%20x2%3D%22815.5%22%20y1%3D%22295.2266%22%20y2%3D%22295.2266%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22784.5%2C291.2266%2C774.5%2C295.2266%2C784.5%2C299.2266%2C780.5%2C295.2266%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2276%22%20x%3D%22780.5%22%20y%3D%22277.1606%22%3E%26%2335746%3B%26%2338405%3BTPS%26%2335268%3B%26%2321017%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22643.5%2C305.2266%2C633.5%2C309.2266%2C643.5%2C313.2266%2C639.5%2C309.2266%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22637.5%22%20x2%3D%22767.5%22%20y1%3D%22309.2266%22%20y2%3D%22309.2266%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22632.5%22%20x2%3D%22674.5%22%20y1%3D%22338.3594%22%20y2%3D%22338.3594%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22674.5%22%20x2%3D%22674.5%22%20y1%3D%22338.3594%22%20y2%3D%22351.3594%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22633.5%22%20x2%3D%22674.5%22%20y1%3D%22351.3594%22%20y2%3D%22351.3594%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22643.5%2C347.3594%2C633.5%2C351.3594%2C643.5%2C355.3594%2C639.5%2C351.3594%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22117%22%20x%3D%22639.5%22%20y%3D%22333.2935%22%3E%26%2321457%3B%26%2324067%3B%26%2326381%3B%26%2321153%3B%26%2321040%3B%26%2327880%3B%26%2320876%3B%26%2320013%3B%26%2324515%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22528.5%2C361.3594%2C518.5%2C365.3594%2C528.5%2C369.3594%2C524.5%2C365.3594%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22522.5%22%20x2%3D%22626.5%22%20y1%3D%22365.3594%22%20y2%3D%22365.3594%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22367.5%2C375.3594%2C357.5%2C379.3594%2C367.5%2C383.3594%2C363.5%2C379.3594%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22361.5%22%20x2%3D%22511.5%22%20y1%3D%22379.3594%22%20y2%3D%22379.3594%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22221.5%2C389.3594%2C211.5%2C393.3594%2C221.5%2C397.3594%2C217.5%2C393.3594%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22215.5%22%20x2%3D%22345.5%22%20y1%3D%22393.3594%22%20y2%3D%22393.3594%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22210.5%22%20x2%3D%22252.5%22%20y1%3D%22427.4922%22%20y2%3D%22427.4922%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22252.5%22%20x2%3D%22252.5%22%20y1%3D%22427.4922%22%20y2%3D%22440.4922%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22205.5%22%20x2%3D%22252.5%22%20y1%3D%22440.4922%22%20y2%3D%22440.4922%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22215.5%2C436.4922%2C205.5%2C440.4922%2C215.5%2C444.4922%2C211.5%2C440.4922%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22122%22%20x%3D%22217.5%22%20y%3D%22422.4263%22%3E%26%2321457%3B%26%2324067%3B%26%2326381%3B%26%2321153%3B%26%2320449%3B%26%2324687%3B%26%2321040%3Breids%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%2280%2C445.4922%2C70%2C449.4922%2C80%2C453.4922%2C76%2C449.4922%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2274%22%20x2%3D%22204.5%22%20y1%3D%22449.4922%22%20y2%3D%22449.4922%22%2F%3E%3C%2Fg%3E%3C%2Fsvg%3E"><img   src="/images/loading.svg" data-src="data:image/svg+xml;utf8,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22us-ascii%22%20standalone%3D%22no%22%3F%3E%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20contentStyleType%3D%22text%2Fcss%22%20height%3D%22502px%22%20preserveAspectRatio%3D%22none%22%20style%3D%22width%3A863px%3Bheight%3A502px%3Bbackground%3A%23FFFFFF%3B%22%20version%3D%221.1%22%20viewBox%3D%220%200%20863%20502%22%20width%3D%22863px%22%20zoomAndPan%3D%22magnify%22%3E%3Cdefs%2F%3E%3Cg%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%22382.0625%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22200.5%22%20y%3D%2267.4297%22%2F%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%22331.9297%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22346.5%22%20y%3D%2296.5625%22%2F%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%22211.5313%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22507.5%22%20y%3D%22167.8281%22%2F%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%22141.3984%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22622.5%22%20y%3D%22223.9609%22%2F%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%2256.1328%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22763.5%22%20y%3D%22253.0938%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%2269%22%20x2%3D%2269%22%20y1%3D%2236.2969%22%20y2%3D%22467.4922%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22205%22%20x2%3D%22205%22%20y1%3D%2236.2969%22%20y2%3D%22467.4922%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22351%22%20x2%3D%22351%22%20y1%3D%2236.2969%22%20y2%3D%22467.4922%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22512%22%20x2%3D%22512%22%20y1%3D%2236.2969%22%20y2%3D%22467.4922%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22627.5%22%20x2%3D%22627.5%22%20y1%3D%2236.2969%22%20y2%3D%22467.4922%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22768.5%22%20x2%3D%22768.5%22%20y1%3D%2236.2969%22%20y2%3D%22467.4922%22%2F%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22128%22%20x%3D%225%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22114%22%20x%3D%2212%22%20y%3D%2224.9951%22%3EServiceMetadata%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22128%22%20x%3D%225%22%20y%3D%22466.4922%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22114%22%20x%3D%2212%22%20y%3D%22486.4873%22%3EServiceMetadata%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22125%22%20x%3D%22143%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22111%22%20x%3D%22150%22%20y%3D%2224.9951%22%3EMetadataReport%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22125%22%20x%3D%22143%22%20y%3D%22466.4922%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22111%22%20x%3D%22150%22%20y%3D%22486.4873%22%3EMetadataReport%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2277%22%20x%3D%22313%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2263%22%20x%3D%22320%22%20y%3D%2224.9951%22%3EEagleEye%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2277%22%20x%3D%22313%22%20y%3D%22466.4922%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2263%22%20x%3D%22320%22%20y%3D%22486.4873%22%3EEagleEye%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2241%22%20x%3D%22492%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2227%22%20x%3D%22499%22%20y%3D%2224.9951%22%3EUnit%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2241%22%20x%3D%22492%22%20y%3D%22466.4922%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2227%22%20x%3D%22499%22%20y%3D%22486.4873%22%3EUnit%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2270%22%20x%3D%22592.5%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2256%22%20x%3D%22599.5%22%20y%3D%2224.9951%22%3ERegistry%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2270%22%20x%3D%22592.5%22%20y%3D%22466.4922%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2256%22%20x%3D%22599.5%22%20y%3D%22486.4873%22%3ERegistry%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2272%22%20x%3D%22732.5%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2258%22%20x%3D%22739.5%22%20y%3D%2224.9951%22%3ETPSRule%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2272%22%20x%3D%22732.5%22%20y%3D%22466.4922%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2258%22%20x%3D%22739.5%22%20y%3D%22486.4873%22%3ETPSRule%3C%2Ftext%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%22382.0625%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22200.5%22%20y%3D%2267.4297%22%2F%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%22331.9297%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22346.5%22%20y%3D%2296.5625%22%2F%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%22211.5313%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22507.5%22%20y%3D%22167.8281%22%2F%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%22141.3984%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22622.5%22%20y%3D%22223.9609%22%2F%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%2256.1328%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22763.5%22%20y%3D%22253.0938%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22188.5%2C63.4297%2C198.5%2C67.4297%2C188.5%2C71.4297%2C192.5%2C67.4297%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2269%22%20x2%3D%22194.5%22%20y1%3D%2267.4297%22%20y2%3D%2267.4297%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2241%22%20x%3D%2276%22%20y%3D%2262.3638%22%3Eexport%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22334.5%2C92.5625%2C344.5%2C96.5625%2C334.5%2C100.5625%2C338.5%2C96.5625%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22210.5%22%20x2%3D%22340.5%22%20y1%3D%2296.5625%22%20y2%3D%2296.5625%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2241%22%20x%3D%22217.5%22%20y%3D%2291.4966%22%3Eexport%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22356.5%22%20x2%3D%22398.5%22%20y1%3D%22125.6953%22%20y2%3D%22125.6953%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22398.5%22%20x2%3D%22398.5%22%20y1%3D%22125.6953%22%20y2%3D%22138.6953%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22357.5%22%20x2%3D%22398.5%22%20y1%3D%22138.6953%22%20y2%3D%22138.6953%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22367.5%2C134.6953%2C357.5%2C138.6953%2C367.5%2C142.6953%2C363.5%2C138.6953%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22137%22%20x%3D%22363.5%22%20y%3D%22120.6294%22%3E%26%2321457%3B%26%2324067%3B%26%2331199%3B%26%2325143%3B%26%2321040%3BServiceURL%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22495.5%2C163.8281%2C505.5%2C167.8281%2C495.5%2C171.8281%2C499.5%2C167.8281%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22356.5%22%20x2%3D%22501.5%22%20y1%3D%22167.8281%22%20y2%3D%22167.8281%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2241%22%20x%3D%22363.5%22%20y%3D%22162.7622%22%3Eexport%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22517.5%22%20x2%3D%22559.5%22%20y1%3D%22196.9609%22%20y2%3D%22196.9609%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22559.5%22%20x2%3D%22559.5%22%20y1%3D%22196.9609%22%20y2%3D%22209.9609%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22518.5%22%20x2%3D%22559.5%22%20y1%3D%22209.9609%22%20y2%3D%22209.9609%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22528.5%2C205.9609%2C518.5%2C209.9609%2C528.5%2C213.9609%2C524.5%2C209.9609%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2291%22%20x%3D%22524.5%22%20y%3D%22191.895%22%3E%26%2321333%3B%26%2320803%3B%26%2321270%3B%26%2321457%3B%26%2324067%3B%26%2335268%3B%26%2321017%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22610.5%2C219.9609%2C620.5%2C223.9609%2C610.5%2C227.9609%2C614.5%2C223.9609%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22517.5%22%20x2%3D%22616.5%22%20y1%3D%22223.9609%22%20y2%3D%22223.9609%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22751.5%2C249.0938%2C761.5%2C253.0938%2C751.5%2C257.0938%2C755.5%2C253.0938%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22632.5%22%20x2%3D%22757.5%22%20y1%3D%22253.0938%22%20y2%3D%22253.0938%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2241%22%20x%3D%22639.5%22%20y%3D%22248.0278%22%3Eexport%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22773.5%22%20x2%3D%22815.5%22%20y1%3D%22282.2266%22%20y2%3D%22282.2266%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22815.5%22%20x2%3D%22815.5%22%20y1%3D%22282.2266%22%20y2%3D%22295.2266%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22774.5%22%20x2%3D%22815.5%22%20y1%3D%22295.2266%22%20y2%3D%22295.2266%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22784.5%2C291.2266%2C774.5%2C295.2266%2C784.5%2C299.2266%2C780.5%2C295.2266%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2276%22%20x%3D%22780.5%22%20y%3D%22277.1606%22%3E%26%2335746%3B%26%2338405%3BTPS%26%2335268%3B%26%2321017%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22643.5%2C305.2266%2C633.5%2C309.2266%2C643.5%2C313.2266%2C639.5%2C309.2266%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22637.5%22%20x2%3D%22767.5%22%20y1%3D%22309.2266%22%20y2%3D%22309.2266%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22632.5%22%20x2%3D%22674.5%22%20y1%3D%22338.3594%22%20y2%3D%22338.3594%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22674.5%22%20x2%3D%22674.5%22%20y1%3D%22338.3594%22%20y2%3D%22351.3594%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22633.5%22%20x2%3D%22674.5%22%20y1%3D%22351.3594%22%20y2%3D%22351.3594%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22643.5%2C347.3594%2C633.5%2C351.3594%2C643.5%2C355.3594%2C639.5%2C351.3594%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22117%22%20x%3D%22639.5%22%20y%3D%22333.2935%22%3E%26%2321457%3B%26%2324067%3B%26%2326381%3B%26%2321153%3B%26%2321040%3B%26%2327880%3B%26%2320876%3B%26%2320013%3B%26%2324515%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22528.5%2C361.3594%2C518.5%2C365.3594%2C528.5%2C369.3594%2C524.5%2C365.3594%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22522.5%22%20x2%3D%22626.5%22%20y1%3D%22365.3594%22%20y2%3D%22365.3594%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22367.5%2C375.3594%2C357.5%2C379.3594%2C367.5%2C383.3594%2C363.5%2C379.3594%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22361.5%22%20x2%3D%22511.5%22%20y1%3D%22379.3594%22%20y2%3D%22379.3594%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22221.5%2C389.3594%2C211.5%2C393.3594%2C221.5%2C397.3594%2C217.5%2C393.3594%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22215.5%22%20x2%3D%22345.5%22%20y1%3D%22393.3594%22%20y2%3D%22393.3594%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22210.5%22%20x2%3D%22252.5%22%20y1%3D%22427.4922%22%20y2%3D%22427.4922%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22252.5%22%20x2%3D%22252.5%22%20y1%3D%22427.4922%22%20y2%3D%22440.4922%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22205.5%22%20x2%3D%22252.5%22%20y1%3D%22440.4922%22%20y2%3D%22440.4922%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22215.5%2C436.4922%2C205.5%2C440.4922%2C215.5%2C444.4922%2C211.5%2C440.4922%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22122%22%20x%3D%22217.5%22%20y%3D%22422.4263%22%3E%26%2321457%3B%26%2324067%3B%26%2326381%3B%26%2321153%3B%26%2320449%3B%26%2324687%3B%26%2321040%3Breids%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%2280%2C445.4922%2C70%2C449.4922%2C80%2C453.4922%2C76%2C449.4922%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2274%22%20x2%3D%22204.5%22%20y1%3D%22449.4922%22%20y2%3D%22449.4922%22%2F%3E%3C%2Fg%3E%3C%2Fsvg%3E"  lazyload></a></p>
<p>几个点：</p>
<ul>
<li>关键节点：<code>RegistryProtocolInterceptor</code>，在里面完成向注册中心发布服务。</li>
<li>每个节点通过调用<code>export()</code>使得流程传递到下一个节点</li>
<li>每个节点的处理逻辑放在<code>export()</code>之前或之后，例如<code>RegistryProtocolInterceptor</code>需要拿到后面节点生成的<code>serviceURLs</code>（服务地址列表）才能向注册中心发布，所以处理逻辑放在<code>export()</code>之后</li>
</ul>
<h3 id="6-2-3-服务订阅"><a href="#6-2-3-服务订阅" class="headerlink" title="6.2.3 服务订阅"></a>6.2.3 服务订阅</h3><p>基本流程：</p>
<ol>
<li>在<code>HSFApiConsumerBean#init</code>时，触发服务元数据对象<code>ServiceMetadata</code>初始化和同步订阅动作：<code>ServiceMetadata#referSync</code>，<code>referSync()</code>方法通过阻塞获取异步任务结果的方式实现同步；</li>
<li>遍历<code>ServiceMetadata</code>中的拦截器链，执行每一个<code>ProtocolInterceptor</code>的<code>refer()</code>方法；</li>
<li>末尾节点<code>HSFProtocol</code>的<code>refer()</code>方法，加载<code>InvocationHandler</code>，默认实现类是<code>RemotingRPCProtocolComponent</code>，用这个对象可以来触发RPC请求；</li>
</ol>
<p><a class="simple-lightbox" href="data:image/svg+xml;utf8,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22us-ascii%22%20standalone%3D%22no%22%3F%3E%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20contentStyleType%3D%22text%2Fcss%22%20height%3D%22347px%22%20preserveAspectRatio%3D%22none%22%20style%3D%22width%3A849px%3Bheight%3A347px%3Bbackground%3A%23FFFFFF%3B%22%20version%3D%221.1%22%20viewBox%3D%220%200%20849%20347%22%20width%3D%22849px%22%20zoomAndPan%3D%22magnify%22%3E%3Cdefs%2F%3E%3Cg%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%22226.6641%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22177%22%20y%3D%2267.4297%22%2F%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%22141.3984%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22279%22%20y%3D%22138.6953%22%2F%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%2256.1328%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22586%22%20y%3D%22167.8281%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%2269%22%20x2%3D%2269%22%20y1%3D%2236.2969%22%20y2%3D%22312.0938%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22182%22%20x2%3D%22182%22%20y1%3D%2236.2969%22%20y2%3D%22312.0938%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22284%22%20x2%3D%22284%22%20y1%3D%2236.2969%22%20y2%3D%22312.0938%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22591%22%20x2%3D%22591%22%20y1%3D%2236.2969%22%20y2%3D%22312.0938%22%2F%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22128%22%20x%3D%225%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22114%22%20x%3D%2212%22%20y%3D%2224.9951%22%3EServiceMetadata%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22128%22%20x%3D%225%22%20y%3D%22311.0938%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22114%22%20x%3D%2212%22%20y%3D%22331.0889%22%3EServiceMetadata%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2278%22%20x%3D%22143%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2264%22%20x%3D%22150%22%20y%3D%2224.9951%22%3EGrouping%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2278%22%20x%3D%22143%22%20y%3D%22311.0938%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2264%22%20x%3D%22150%22%20y%3D%22331.0889%22%3EGrouping%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2270%22%20x%3D%22249%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2256%22%20x%3D%22256%22%20y%3D%2224.9951%22%3ERegistry%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2270%22%20x%3D%22249%22%20y%3D%22311.0938%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2256%22%20x%3D%22256%22%20y%3D%22331.0889%22%3ERegistry%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2298%22%20x%3D%22542%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2284%22%20x%3D%22549%22%20y%3D%2224.9951%22%3EHSFProtocol%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2298%22%20x%3D%22542%22%20y%3D%22311.0938%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2284%22%20x%3D%22549%22%20y%3D%22331.0889%22%3EHSFProtocol%3C%2Ftext%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%22226.6641%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22177%22%20y%3D%2267.4297%22%2F%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%22141.3984%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22279%22%20y%3D%22138.6953%22%2F%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%2256.1328%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22586%22%20y%3D%22167.8281%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22165%2C63.4297%2C175%2C67.4297%2C165%2C71.4297%2C169%2C67.4297%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2269%22%20x2%3D%22171%22%20y1%3D%2267.4297%22%20y2%3D%2267.4297%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2230%22%20x%3D%2276%22%20y%3D%2262.3638%22%3Erefer%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22187%22%20x2%3D%22229%22%20y1%3D%2296.5625%22%20y2%3D%2296.5625%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22229%22%20x2%3D%22229%22%20y1%3D%2296.5625%22%20y2%3D%22109.5625%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22188%22%20x2%3D%22229%22%20y1%3D%22109.5625%22%20y2%3D%22109.5625%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22198%2C105.5625%2C188%2C109.5625%2C198%2C113.5625%2C194%2C109.5625%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2278%22%20x%3D%22194%22%20y%3D%2291.4966%22%3E%26%2335746%3B%26%2338405%3B%26%2324402%3B%26%2332452%3B%26%2335268%3B%26%2321017%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22267%2C134.6953%2C277%2C138.6953%2C267%2C142.6953%2C271%2C138.6953%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22187%22%20x2%3D%22273%22%20y1%3D%22138.6953%22%20y2%3D%22138.6953%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2230%22%20x%3D%22194%22%20y%3D%22133.6294%22%3Erefer%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22574%2C163.8281%2C584%2C167.8281%2C574%2C171.8281%2C578%2C167.8281%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22289%22%20x2%3D%22580%22%20y1%3D%22167.8281%22%20y2%3D%22167.8281%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2230%22%20x%3D%22296%22%20y%3D%22162.7622%22%3Erefer%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22596%22%20x2%3D%22638%22%20y1%3D%22196.9609%22%20y2%3D%22196.9609%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22638%22%20x2%3D%22638%22%20y1%3D%22196.9609%22%20y2%3D%22209.9609%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22597%22%20x2%3D%22638%22%20y1%3D%22209.9609%22%20y2%3D%22209.9609%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22607%2C205.9609%2C597%2C209.9609%2C607%2C213.9609%2C603%2C209.9609%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22239%22%20x%3D%22603%22%20y%3D%22191.895%22%3E%26%2329983%3B%26%2325104%3BRemotingRPCProtocolComponent%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22300%2C219.9609%2C290%2C223.9609%2C300%2C227.9609%2C296%2C223.9609%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22294%22%20x2%3D%22590%22%20y1%3D%22223.9609%22%20y2%3D%22223.9609%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22289%22%20x2%3D%22331%22%20y1%3D%22253.0938%22%20y2%3D%22253.0938%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22331%22%20x2%3D%22331%22%20y1%3D%22253.0938%22%20y2%3D%22266.0938%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22290%22%20x2%3D%22331%22%20y1%3D%22266.0938%22%20y2%3D%22266.0938%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22300%2C262.0938%2C290%2C266.0938%2C300%2C270.0938%2C296%2C266.0938%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22283%22%20x%3D%22296%22%20y%3D%22248.0278%22%3E%26%2326500%3B%26%2336896%3BRegistryInvocationHandler%26%2324182%3B%26%2325340%3B%26%2325509%3B%26%2321040%3B%26%2335843%3B%26%2329992%3B%26%2338142%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22198%2C276.0938%2C188%2C280.0938%2C198%2C284.0938%2C194%2C280.0938%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22192%22%20x2%3D%22283%22%20y1%3D%22280.0938%22%20y2%3D%22280.0938%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%2280%2C290.0938%2C70%2C294.0938%2C80%2C298.0938%2C76%2C294.0938%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2274%22%20x2%3D%22181%22%20y1%3D%22294.0938%22%20y2%3D%22294.0938%22%2F%3E%3C%2Fg%3E%3C%2Fsvg%3E"><img   src="/images/loading.svg" data-src="data:image/svg+xml;utf8,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22us-ascii%22%20standalone%3D%22no%22%3F%3E%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20contentStyleType%3D%22text%2Fcss%22%20height%3D%22347px%22%20preserveAspectRatio%3D%22none%22%20style%3D%22width%3A849px%3Bheight%3A347px%3Bbackground%3A%23FFFFFF%3B%22%20version%3D%221.1%22%20viewBox%3D%220%200%20849%20347%22%20width%3D%22849px%22%20zoomAndPan%3D%22magnify%22%3E%3Cdefs%2F%3E%3Cg%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%22226.6641%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22177%22%20y%3D%2267.4297%22%2F%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%22141.3984%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22279%22%20y%3D%22138.6953%22%2F%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%2256.1328%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22586%22%20y%3D%22167.8281%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%2269%22%20x2%3D%2269%22%20y1%3D%2236.2969%22%20y2%3D%22312.0938%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22182%22%20x2%3D%22182%22%20y1%3D%2236.2969%22%20y2%3D%22312.0938%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22284%22%20x2%3D%22284%22%20y1%3D%2236.2969%22%20y2%3D%22312.0938%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3Bstroke-dasharray%3A5.0%2C5.0%3B%22%20x1%3D%22591%22%20x2%3D%22591%22%20y1%3D%2236.2969%22%20y2%3D%22312.0938%22%2F%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22128%22%20x%3D%225%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22114%22%20x%3D%2212%22%20y%3D%2224.9951%22%3EServiceMetadata%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22128%22%20x%3D%225%22%20y%3D%22311.0938%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22114%22%20x%3D%2212%22%20y%3D%22331.0889%22%3EServiceMetadata%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2278%22%20x%3D%22143%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2264%22%20x%3D%22150%22%20y%3D%2224.9951%22%3EGrouping%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2278%22%20x%3D%22143%22%20y%3D%22311.0938%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2264%22%20x%3D%22150%22%20y%3D%22331.0889%22%3EGrouping%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2270%22%20x%3D%22249%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2256%22%20x%3D%22256%22%20y%3D%2224.9951%22%3ERegistry%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2270%22%20x%3D%22249%22%20y%3D%22311.0938%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2256%22%20x%3D%22256%22%20y%3D%22331.0889%22%3ERegistry%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2298%22%20x%3D%22542%22%20y%3D%225%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2284%22%20x%3D%22549%22%20y%3D%2224.9951%22%3EHSFProtocol%3C%2Ftext%3E%3Crect%20fill%3D%22%23E2E2F0%22%20height%3D%2230.2969%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%2298%22%20x%3D%22542%22%20y%3D%22311.0938%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2284%22%20x%3D%22549%22%20y%3D%22331.0889%22%3EHSFProtocol%3C%2Ftext%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%22226.6641%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22177%22%20y%3D%2267.4297%22%2F%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%22141.3984%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22279%22%20y%3D%22138.6953%22%2F%3E%3Crect%20fill%3D%22%23FFFFFF%22%20height%3D%2256.1328%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20width%3D%2210%22%20x%3D%22586%22%20y%3D%22167.8281%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22165%2C63.4297%2C175%2C67.4297%2C165%2C71.4297%2C169%2C67.4297%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2269%22%20x2%3D%22171%22%20y1%3D%2267.4297%22%20y2%3D%2267.4297%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2230%22%20x%3D%2276%22%20y%3D%2262.3638%22%3Erefer%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22187%22%20x2%3D%22229%22%20y1%3D%2296.5625%22%20y2%3D%2296.5625%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22229%22%20x2%3D%22229%22%20y1%3D%2296.5625%22%20y2%3D%22109.5625%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22188%22%20x2%3D%22229%22%20y1%3D%22109.5625%22%20y2%3D%22109.5625%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22198%2C105.5625%2C188%2C109.5625%2C198%2C113.5625%2C194%2C109.5625%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2278%22%20x%3D%22194%22%20y%3D%2291.4966%22%3E%26%2335746%3B%26%2338405%3B%26%2324402%3B%26%2332452%3B%26%2335268%3B%26%2321017%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22267%2C134.6953%2C277%2C138.6953%2C267%2C142.6953%2C271%2C138.6953%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22187%22%20x2%3D%22273%22%20y1%3D%22138.6953%22%20y2%3D%22138.6953%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2230%22%20x%3D%22194%22%20y%3D%22133.6294%22%3Erefer%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22574%2C163.8281%2C584%2C167.8281%2C574%2C171.8281%2C578%2C167.8281%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22289%22%20x2%3D%22580%22%20y1%3D%22167.8281%22%20y2%3D%22167.8281%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2230%22%20x%3D%22296%22%20y%3D%22162.7622%22%3Erefer%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22596%22%20x2%3D%22638%22%20y1%3D%22196.9609%22%20y2%3D%22196.9609%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22638%22%20x2%3D%22638%22%20y1%3D%22196.9609%22%20y2%3D%22209.9609%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22597%22%20x2%3D%22638%22%20y1%3D%22209.9609%22%20y2%3D%22209.9609%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22607%2C205.9609%2C597%2C209.9609%2C607%2C213.9609%2C603%2C209.9609%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22239%22%20x%3D%22603%22%20y%3D%22191.895%22%3E%26%2329983%3B%26%2325104%3BRemotingRPCProtocolComponent%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22300%2C219.9609%2C290%2C223.9609%2C300%2C227.9609%2C296%2C223.9609%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22294%22%20x2%3D%22590%22%20y1%3D%22223.9609%22%20y2%3D%22223.9609%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22289%22%20x2%3D%22331%22%20y1%3D%22253.0938%22%20y2%3D%22253.0938%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22331%22%20x2%3D%22331%22%20y1%3D%22253.0938%22%20y2%3D%22266.0938%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22290%22%20x2%3D%22331%22%20y1%3D%22266.0938%22%20y2%3D%22266.0938%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22300%2C262.0938%2C290%2C266.0938%2C300%2C270.0938%2C296%2C266.0938%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22283%22%20x%3D%22296%22%20y%3D%22248.0278%22%3E%26%2326500%3B%26%2336896%3BRegistryInvocationHandler%26%2324182%3B%26%2325340%3B%26%2325509%3B%26%2321040%3B%26%2335843%3B%26%2329992%3B%26%2338142%3B%3C%2Ftext%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22198%2C276.0938%2C188%2C280.0938%2C198%2C284.0938%2C194%2C280.0938%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%22192%22%20x2%3D%22283%22%20y1%3D%22280.0938%22%20y2%3D%22280.0938%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%2280%2C290.0938%2C70%2C294.0938%2C80%2C298.0938%2C76%2C294.0938%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%20x1%3D%2274%22%20x2%3D%22181%22%20y1%3D%22294.0938%22%20y2%3D%22294.0938%22%2F%3E%3C%2Fg%3E%3C%2Fsvg%3E"  lazyload></a></p>
<ul>
<li><p>关键节点：<code>RegistryProtocolInterceptor</code></p>
<ul>
<li>向注册中心订阅服务</li>
<li>使用<code>RegistryInvocationHandler</code>包装下游返回的<code>InvocationHandler</code>（主要是<code>RemotingRPCProtocolComponent</code>），目的在于使得RPC请求时，首先经过<code>RegistryInvocationHandler#invoke</code>来做负载均衡路由</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> InvocationHandler <span class="title function_">refer</span><span class="params">(ServiceMetadata serviceMetadata)</span> &#123;</span><br><span class="line">    <span class="comment">// 传递给后面的节点处理订阅流程</span></span><br><span class="line">    <span class="type">InvocationHandler</span> <span class="variable">invocationHandler</span> <span class="operator">=</span> protocol.refer(serviceMetadata);</span><br><span class="line">	<span class="comment">// 生成RegistryInvocationHandler，用来包装后面节点返回的invocationHandler</span></span><br><span class="line">    <span class="type">RegistryInvocationHandler</span> <span class="variable">registryHandler</span> <span class="operator">=</span> serviceMetadata.getAttachment(REGISTRY_INVOCATION_HANDLER_KEY);</span><br><span class="line">    <span class="comment">//TODO remove this null check</span></span><br><span class="line">    <span class="keyword">if</span> (registryHandler == <span class="literal">null</span>) &#123;</span><br><span class="line">        registryHandler = <span class="keyword">new</span> <span class="title class_">RegistryInvocationHandler</span>();</span><br><span class="line">        registryHandler.setServiceMetadata(serviceMetadata);</span><br><span class="line">        registryHandler.setProtocol(protocol);</span><br><span class="line">        <span class="comment">// 1. 构建HeadRouter对象和RouterChain用于路由</span></span><br><span class="line">        <span class="comment">// 2. 构建当前服务元数据的地址监听器</span></span><br><span class="line">        registryHandler.start();</span><br><span class="line">        serviceMetadata.putAttachment(REGISTRY_INVOCATION_HANDLER_KEY, registryHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将服务元信息注册到对应的注册中心上</span></span><br><span class="line">    registryHandler.refer();</span><br><span class="line">    <span class="comment">// 把invocationHandler加到registryHandler后面</span></span><br><span class="line">    registryHandler.setInvocationHandler(invocationHandler);</span><br><span class="line">    <span class="keyword">return</span> registryHandler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>同发布时调用<code>export()</code>一样，每个节点通过调用<code>refer()</code>使得流程传递到下一个节点，并且每个节点的处理逻辑可以放在<code>refer()</code>之前或之后</p>
</li>
</ul>
<h1 id="7-框架领域1-总体设计"><a href="#7-框架领域1-总体设计" class="headerlink" title="7 框架领域1 - 总体设计"></a>7 框架领域1 - 总体设计</h1><h2 id="7-1-层次"><a href="#7-1-层次" class="headerlink" title="7.1 层次"></a>7.1 层次</h2><p>框架领域位于HSF设计4块领域（共11层）的最底层，直接跟网络打交道，负责通信、线程、协议、序列化以及编解码。</p>
<p>对框架之上的应用层而言，框架提供的抽象屏蔽了数据编码传输这些细节，基于<code>ClientStream</code>&#x2F;<code>Client</code>&#x2F;<code>ServerStream</code>&#x2F;<code>Server</code>等接口，就可以完成客户端调用或者服务端侦听&#x2F;响应。</p>
<p>以客户端调用为例，通过操作网络链接的抽象对象<code>Stream</code>，就可以发起一次网络写请求，将RPC数据（未序列化，未编码）发送给服务端，框架层内部实现了序列化 - 编码 - 建立TCP连接（如果无连接） - 写TCP数据等工作，而这一系列工作对于应用领域来说是透明的。</p>
<p>参考<code>com.taobao.hsf.remoting.service.RemotingRPCProtocolComponent#invokeForOne</code>方法，发送RPC请求的两步：</p>
<ol>
<li>从<code>Client</code>表示的客户端对象里获取一条连接<code>ClientStream</code>；</li>
<li>调用<code>ClientStream</code>的<code>write()</code>方法写数据；</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ListenableFuture&lt;RPCResult&gt; <span class="title function_">invokeForOne</span><span class="params">(ConsumerMethodModel consumerMethodModel, Invocation invocation,</span></span><br><span class="line"><span class="params">                                                 ServiceURL remotingURL)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">timeout</span> <span class="operator">=</span> <span class="built_in">this</span>.getReadTimeout(invocation.getHsfRequest(), consumerMethodModel, remotingURL);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 获取一条连接，用ClientStream表示</span></span><br><span class="line">        <span class="type">ClientStream</span> <span class="variable">clientStream</span> <span class="operator">=</span> client.of(remotingURL);</span><br><span class="line">        <span class="comment">// 设置调用参数等代码，省略</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用clientStream写请求</span></span><br><span class="line">        <span class="keyword">return</span> clientStream.write(invocation);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">HSFException</span>(<span class="string">&quot;error on submit request on future invoke:&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7-2-内部结构"><a href="#7-2-内部结构" class="headerlink" title="7.2 内部结构"></a>7.2 内部结构</h2><p><a class="simple-lightbox" target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/jffu/jffu-blog-images@main/img/Fq6ME-N44TKBZYe1BvzFqpif3TDB.png"><img   src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/jffu/jffu-blog-images@main/img/Fq6ME-N44TKBZYe1BvzFqpif3TDB.png"  lazyload></a></p>
<p>抛开并不直接与网络打交道的<code>ThreadPool</code>和序列化器<code>Serializer</code>，代表网络和数据抽象的对象从上往下总共3层：</p>
<ol>
<li><code>Stream</code> - 网络链接对象，代表一条TCP连接，通过它来发送和接收数据</li>
<li><code>Packet</code> - 通信对象，已经序列化，未IO编码</li>
<li><code>Frame</code> - 网络数据包对象，已IO编码</li>
</ol>
<p>序列化&#x2F;反序列化也是编解码的一部分，HSF代码中分了两步：</p>
<ul>
<li>序列化（反序列化）：将应用领域产生的业务请求对象<code>Invocation</code>或者响应对象<code>RPCResult</code>转换成序列化后数据的抽象<code>Packet</code>，反序列化则反过来转换；通过<code>Serializer</code>接口的不同实现，选择不同的序列化方式，默认是<code>hessian2</code>，其他实现包括<code>java</code>、<code>hessian</code>、<code>hessian2</code>、<code>json</code>、<code>kyro</code>等；</li>
<li>IO编解码：编码即是将序列化后的数据对象<code>Packet</code>转换成真正网络层传输的数据包对象<code>Frame</code>，解码则反之；<code>Frame</code>里包装的已经是字节数据，这一步通过HSF2请求&#x2F;响应协议进行；</li>
</ul>
<h2 id="7-3-扩展点"><a href="#7-3-扩展点" class="headerlink" title="7.3 扩展点"></a>7.3 扩展点</h2><p>框架领域的5层之间是松耦合的关系，通过SPI机制，层与层之间看到的是接口而不是具体的实现，这样的设计允许每层内部可以选择不同的实现来进行扩展。</p>
<p>参考资料：</p>
<blockquote>
<table>
<thead>
<tr>
<th>名称</th>
<th>功能</th>
<th>扩展点介绍</th>
</tr>
</thead>
<tbody><tr>
<td>Packet</td>
<td>请求对象到通信对象的转换工作，能够将调用层的抽象转换成为网络层定义的抽象，也完成反向转换的工作</td>
<td>PacketFactory负责实现对象转换工作，如果需要支持不同协议，就需要扩展它</td>
</tr>
<tr>
<td>Serialize</td>
<td>完成序列化&#x2F;反序列化工作</td>
<td>Serializer对应一种序列化协议，比如：hessian2、fastjson等，如果要增加序列化协议，就需要扩展它</td>
</tr>
<tr>
<td>ThreadPool</td>
<td>线程池管理服务，维护了HSF框架对于线程资源的申请、分配以及线程指标的获取</td>
<td>ThreadPoolManager完成线程的创建工作，服务端线程动态的创建可以选择扩展它</td>
</tr>
<tr>
<td>Frame</td>
<td>完成网络层协议编解码工作</td>
<td>Framer负责完成不同RPC框架网络层协议的编解码工作，该扩展工作在IO线程上，因此要求其扩展不能阻塞</td>
</tr>
<tr>
<td>Stream</td>
<td>抽象的网络链接层，使用方可以通过Stream来发起调用以及接受响应，开发者可以将Stream适配到不同的NIO框架上</td>
<td>StreamLifecyleListener用于监听网络链接的建立、销毁等事件，扩展它可以知晓HSF和外部建立的链接 StreamMessageListener用于监听网络层发送以及接受的数据</td>
</tr>
</tbody></table>
</blockquote>
<p>以服务端接收到请求开始解码为例：</p>
<ol>
<li><p>在<code>com.taobao.hsf.io.netty.tcp.NettyProtocolHandler#decode</code>中，<code>Frame</code>对象需要解码成<code>Packet</code>对象，并不会指定一个具体实现类的解码器，而是通过<code>FramerSelector</code>选择一个解码器<code>Framer</code>实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">NettyByteBufferWrapper</span> <span class="variable">byteBufferWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyByteBufferWrapper</span>(in);</span><br><span class="line">    <span class="type">Frame</span> <span class="variable">frame</span> <span class="operator">=</span> Frame.of(byteBufferWrapper);</span><br><span class="line">    <span class="comment">// 通过FramerSelector选择解码器来decode</span></span><br><span class="line">    <span class="type">Packet</span> <span class="variable">packet</span> <span class="operator">=</span> FramerSelector.getInstance().decode(frame);</span><br><span class="line">    <span class="keyword">if</span> (packet != <span class="literal">null</span>) &#123;</span><br><span class="line">        out.add(packet);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>FramerSelector</code>内部维护一个<code>Framer</code>字典，字典里面对应了所有已经注册的<code>Framer</code>实现，并且可以利用ServiceLoader机制的特性，注册自己的扩展<code>Framer</code>类到这个词典中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerInit.LOGGER;</span><br><span class="line"><span class="keyword">private</span> Framer[] framerDict = <span class="keyword">new</span> <span class="title class_">Framer</span>[Byte.MAX_VALUE];</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="title function_">FramerSelector</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 通过ServiceLoader机制加载所有Framer实现</span></span><br><span class="line">    List&lt;Framer&gt; framerImpls = HSFServiceContainer.SHARED_CONTAINER.getInstances(Framer.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Framer framer : framerImpls) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> Math.abs(framer.protocolType());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 已经被设置过了</span></span><br><span class="line">        <span class="keyword">if</span> (framerDict[index] != <span class="literal">null</span>) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, <span class="string">&quot;Found FramerSelector Protocol code : &quot;</span> + framer.protocolType() + <span class="string">&quot; has been override&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        framerDict[index] = framer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>选择合适类型的<code>Framer</code>进行真正的解码操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Packet <span class="title function_">decode</span><span class="params">(Frame frame)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">ByteBufferWrapper</span> <span class="variable">byteBufferWrapper</span> <span class="operator">=</span> frame.getByteBufferWrapper();</span><br><span class="line">	<span class="comment">// 省略部分代码</span></span><br><span class="line">    <span class="comment">// 取出协议类型</span></span><br><span class="line">    <span class="type">byte</span> <span class="variable">protocolType</span> <span class="operator">=</span> (<span class="type">byte</span>) Math.abs(byteBufferWrapper.readByte());</span><br><span class="line">    <span class="comment">// 根据协议类型从已有Framer的字典里选择Framer实现</span></span><br><span class="line">    <span class="type">Framer</span> <span class="variable">framer</span> <span class="operator">=</span> framerDict[protocolType];</span><br><span class="line">    <span class="keyword">if</span> (framer == <span class="literal">null</span>) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;&quot;</span>, <span class="string">&quot;Receive unsupported protocol:&quot;</span> + protocolType);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">HSFException</span>(<span class="string">&quot;Receive unsupported protocol:&quot;</span> + protocolType);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解码操作</span></span><br><span class="line">    <span class="type">Packet</span> <span class="variable">packet</span> <span class="operator">=</span> framer.decode(byteBufferWrapper, originPos);</span><br><span class="line">    <span class="keyword">if</span> (packet != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> packet;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        byteBufferWrapper.setReaderIndex(originPos);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="8-框架领域2-编解码"><a href="#8-框架领域2-编解码" class="headerlink" title="8 框架领域2 - 编解码"></a>8 框架领域2 - 编解码</h1><h2 id="8-1-编解码的抽象"><a href="#8-1-编解码的抽象" class="headerlink" title="8.1 编解码的抽象"></a>8.1 编解码的抽象</h2><p>HSF中编解码部分的抽象分为两部分：</p>
<ul>
<li><p><code>Frame</code>：I&#x2F;O编解码</p>
<ul>
<li>二进制的I&#x2F;O传输对象，与<code>Stream</code>直接打交道。</li>
<li>通过I&#x2F;O编解码与<code>Packet</code>互相转换</li>
<li><code>Frame</code>对象封装：<code>byteBufferWrapper</code>二进制数据和<code>protocol</code>协议</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Frame</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">callId</span> <span class="operator">=</span> -<span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> ByteBufferWrapper byteBufferWrapper;</span><br><span class="line">    <span class="keyword">private</span> String protocol;</span><br><span class="line">    <span class="comment">// 省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Packet</code>：序列化&#x2F;反序列化</p>
<ul>
<li>通信对象，用于描述协议</li>
<li>分为为<code>RequestPacket</code>和<code>ResponsePacket</code><ul>
<li>序列化：客户端发请求时<code>Invocation</code>—&gt;<code>RequestPacket</code>，服务端发响应时<code>RPCResult</code>—&gt;<code>ResponsePacket</code></li>
<li>反序列化：客户端收响应时<code>ResponsePacket</code>—&gt;<code>RPCResult</code>—&gt;，服务端收请求时<code>RequestPacket</code>—&gt;<code>Invocation</code></li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Packet</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="title function_">requestId</span><span class="params">()</span>;</span><br><span class="line">    <span class="type">byte</span> <span class="title function_">protocolType</span><span class="params">()</span>;</span><br><span class="line">    <span class="type">byte</span> <span class="title function_">serializeType</span><span class="params">()</span>;</span><br><span class="line">    MessageType <span class="title function_">messageType</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RequestPacket</span> <span class="keyword">extends</span> <span class="title class_">Packet</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">timeout</span><span class="params">()</span>;</span><br><span class="line">    MessageAnswerHandler <span class="title function_">getMessageAnswerHandler</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setMessageAnswerHandler</span><span class="params">(MessageAnswerHandler messageAnswerHandler)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ResponsePacket</span> <span class="keyword">extends</span> <span class="title class_">Packet</span> &#123;</span><br><span class="line">    <span class="type">byte</span> <span class="title function_">status</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>针对<code>Frame</code>和<code>Packet</code>，HSF提供<code>Framer</code>和<code>PacketFactory</code>抽象来完成具体的编解码工作。</p>
<ul>
<li><p><code>Framer</code>：HSF提供不同的<code>Framer</code>实现<code>Frame</code>的编解码，即负责<code>Frame</code>和<code>Packet</code>之间的转换</p>
<p> 每种Framer有固定的协议类型，用一个byte表示，与二进制数据包的第一位对应。例如HFS协议的第一位即<code>0x0E</code>。根据协议类型来选择不同的<code>Framer</code>。</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Shared</span></span><br><span class="line"><span class="meta">@Scope(Scope.Option.SINGLETON)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Framer</span> &#123;</span><br><span class="line">    <span class="comment">// 协议类型，不同协议必须不同</span></span><br><span class="line">    <span class="type">byte</span> <span class="title function_">protocolType</span><span class="params">()</span>;</span><br><span class="line">    <span class="comment">// IO解码，将Frame解码成Packet</span></span><br><span class="line">    Packet <span class="title function_">decode</span><span class="params">(ByteBufferWrapper byteBufferWrapper, <span class="type">int</span> originPos)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">    <span class="comment">// IO编码，将Packet编码成Frame</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(Packet packet, ByteBufferWrapper byteBufferWrapper)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>PacketFactory</code>：根据协议同样有不同的实现，实现<code>RequestPacket</code>与<code>Invocation</code>，<code>ResponsePacket</code>与<code>RPCResult</code>之间的转换</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Shared</span></span><br><span class="line"><span class="meta">@Scope(Scope.Option.SINGLETON)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PacketFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">     * 将请求Invocation转换成为一次远程调用的数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 该过程完成了序列化工作</span></span><br><span class="line"><span class="comment">     * &lt;b&gt;业务调用走这里，心跳不会走这里&lt;/b&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 需要传递的调用内容包括：</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;服务的全限定名&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;服务的方法名&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;服务的参数类型名列表&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;服务的参数数组&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;调用采用的序列化方式&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;调用采用的超时时间&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * ┌──────┐          ┌──────────┐          ┌─────────────┐</span></span><br><span class="line"><span class="comment">     * │Client│          │Invocation│          │RequestPacket│</span></span><br><span class="line"><span class="comment">     * └──┬───┘          └────┬─────┘          └──────┬──────┘</span></span><br><span class="line"><span class="comment">     *    │       create      │                       │</span></span><br><span class="line"><span class="comment">     *    │ ──────────────────&gt;                       │</span></span><br><span class="line"><span class="comment">     *    │                   │                       │</span></span><br><span class="line"><span class="comment">     *    │                   │     serialization     │</span></span><br><span class="line"><span class="comment">     *    │                   │ ─────────────────────&gt;│</span></span><br><span class="line"><span class="comment">     * ┌──┴───┐          ┌────┴─────┐          ┌──────┴──────┐</span></span><br><span class="line"><span class="comment">     * │Client│          │Invocation│          │RequestPacket│</span></span><br><span class="line"><span class="comment">     * └──────┘          └──────────┘          └─────────────┘</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> invocation   远程调用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clientStream 客户端Stream</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 调用的packet</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    RequestPacket <span class="title function_">clientCreate</span><span class="params">(Invocation invocation, ClientStream clientStream)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">     * 将请求packet，RequestPacket转换成为一次调用</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 该过程完成了反序列化工作</span></span><br><span class="line"><span class="comment">     * &lt;b&gt;Tbremoting与dubbo2会在该过程完成心跳的解析&lt;/b&gt;</span></span><br><span class="line"><span class="comment">     * &lt;b&gt;hsf2不会完成心跳的解析&lt;/b&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 需要传递的内容包括：</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;服务的全限定名&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;服务的方法名&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;服务的参数类型名列表&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;服务的参数数组&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;调用采用的序列化方式&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;调用采用的超时时间&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;调用的requestId&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * ┌─────────────┐          ┌──────────┐          ┌──────┐</span></span><br><span class="line"><span class="comment">     * │RequestPacket│          │Invocation│          │Server│</span></span><br><span class="line"><span class="comment">     * └──────┬──────┘          └────┬─────┘          └──┬───┘</span></span><br><span class="line"><span class="comment">     *        │   deserialization    │                   │</span></span><br><span class="line"><span class="comment">     *        │─────────────────────&gt;│                   │</span></span><br><span class="line"><span class="comment">     *        │                      │                   │</span></span><br><span class="line"><span class="comment">     *        │                      │        get        │</span></span><br><span class="line"><span class="comment">     *        │                      │──────────────────&gt;|</span></span><br><span class="line"><span class="comment">     * ┌──────┴──────┐          ┌────┴─────┐          ┌──┴───┐</span></span><br><span class="line"><span class="comment">     * │RequestPacket│          │Invocation│          │Server│</span></span><br><span class="line"><span class="comment">     * └─────────────┘          └──────────┘          └──────┘</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> requestPacket 请求packet</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> serverStream  服务端Stream</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Invocation <span class="title function_">serverGet</span><span class="params">(RequestPacket requestPacket, ServerStream serverStream)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">     * 根据响应转换成为responsePacket</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 该过程完成序列化工作</span></span><br><span class="line"><span class="comment">     * &lt;b&gt;业务调用走这里，心跳不会走这里&lt;/b&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 需要传递的内容包括：</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;响应对象&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;序列化方式&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;调用的requestId&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * ┌──────┐          ┌─────────┐          ┌──────────────┐</span></span><br><span class="line"><span class="comment">     * │Server│          │RPCResult│          │ResponsePacket│</span></span><br><span class="line"><span class="comment">     * └──┬───┘          └────┬────┘          └──────┬───────┘</span></span><br><span class="line"><span class="comment">     *    │      create       │                      │</span></span><br><span class="line"><span class="comment">     *    │ ─────────────────&gt;│                      │</span></span><br><span class="line"><span class="comment">     *    │                   │                      │</span></span><br><span class="line"><span class="comment">     *    │                   │    serialization     │</span></span><br><span class="line"><span class="comment">     *    │                   │─────────────────────&gt;│</span></span><br><span class="line"><span class="comment">     * ┌──┴───┐          ┌────┴────┐          ┌──────┴───────┐</span></span><br><span class="line"><span class="comment">     * │Server│          │RPCResult│          │ResponsePacket│</span></span><br><span class="line"><span class="comment">     * └──────┘          └─────────┘          └──────────────┘</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rpcResult    响应</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> serverStream 服务端Stream</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 响应packet</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ResponsePacket <span class="title function_">serverCreate</span><span class="params">(RPCResult rpcResult, ServerStream serverStream)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">     * 将响应packet，ResponsePacket转换成为一次响应</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 该过程完成反序列化工作</span></span><br><span class="line"><span class="comment">     * &lt;b&gt;Tbremoting与dubbo2会在该过程完成心跳的解析&lt;/b&gt;</span></span><br><span class="line"><span class="comment">     * &lt;b&gt;hsf2不会完成心跳的解析&lt;/b&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 需要传递的内容包括：</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;响应对象&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;序列化方式&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;调用的requestId&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;协议类型&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * ┌──────────────┐          ┌─────────┐          ┌──────┐</span></span><br><span class="line"><span class="comment">     * │ResponsePacket│          │RPCResult│          │Client│</span></span><br><span class="line"><span class="comment">     * └──────┬───────┘          └────┬────┘          └──┬───┘</span></span><br><span class="line"><span class="comment">     *        │    deserialization    │                  │</span></span><br><span class="line"><span class="comment">     *        │ ─────────────────────&gt;│                  │</span></span><br><span class="line"><span class="comment">     *        │                       │                  │</span></span><br><span class="line"><span class="comment">     *        │                       │       get        │</span></span><br><span class="line"><span class="comment">     *        │                       │─────────────────&gt;│</span></span><br><span class="line"><span class="comment">     * ┌──────┴───────┐          ┌────┴────┐          ┌──┴───┐</span></span><br><span class="line"><span class="comment">     * │ResponsePacket│          │RPCResult│          │Client│</span></span><br><span class="line"><span class="comment">     * └──────────────┘          └─────────┘          └──────┘</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> responsePacket 响应packet</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clientStream   客户端Stream</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 响应</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    RPCResult <span class="title function_">clientGet</span><span class="params">(ResponsePacket responsePacket, ClientStream clientStream)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">     * 创建心跳请求</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * SendHeartbeat中发送，在clientstream中生成</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * ┌──────┐          ┌─────────────┐</span></span><br><span class="line"><span class="comment">     * │Client│          │RequestPacket│</span></span><br><span class="line"><span class="comment">     * └──┬───┘          └──────┬──────┘</span></span><br><span class="line"><span class="comment">     *    │       create        │</span></span><br><span class="line"><span class="comment">     *    │ ───────────────────&gt;│</span></span><br><span class="line"><span class="comment">     * ┌──┴───┐          ┌──────┴──────┐</span></span><br><span class="line"><span class="comment">     * │Client│          │RequestPacket│</span></span><br><span class="line"><span class="comment">     * └──────┘          └─────────────┘</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 心跳请求</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    RequestPacket <span class="title function_">clientCreateHeartbeatRequest</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">     * 创建心跳响应</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 在serverstream中写时，进行生成</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * ┌──────┐          ┌──────────────┐</span></span><br><span class="line"><span class="comment">     * │Server│          │ResponsePacket│</span></span><br><span class="line"><span class="comment">     * └──┬───┘          └──────┬───────┘</span></span><br><span class="line"><span class="comment">     *    │        create       │</span></span><br><span class="line"><span class="comment">     *    │ ────────────────────&gt;</span></span><br><span class="line"><span class="comment">     * ┌──┴───┐          ┌──────┴───────┐</span></span><br><span class="line"><span class="comment">     * │Server│          │ResponsePacket│</span></span><br><span class="line"><span class="comment">     * └──────┘          └──────────────┘</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> requestId id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 心跳响应</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ResponsePacket <span class="title function_">serverCreateHeartbeatResponse</span><span class="params">(<span class="type">long</span> requestId)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">     * 服务的协议</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 协议</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">byte</span>[] servedForProtocol();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Serializer</code>：序列化器。<code>PacketFactory</code>通过<code>SerializerSelector</code>选择一个<code>Serializer</code>进行序列化和反序列化</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Shared</span></span><br><span class="line"><span class="meta">@Scope(Scope.Option.SINGLETON)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Serializer</span> &#123;</span><br><span class="line">    String <span class="title function_">name</span><span class="params">()</span>;</span><br><span class="line">    <span class="type">byte</span> <span class="title function_">type</span><span class="params">()</span>;</span><br><span class="line">    <span class="type">byte</span>[] serialize(Object object, Stream stream) <span class="keyword">throws</span> Exception;</span><br><span class="line">    Object <span class="title function_">deserialize</span><span class="params">(<span class="type">byte</span>[] bytes, Class&lt;?&gt; type, Stream stream)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">    Object <span class="title function_">deserialize</span><span class="params">(<span class="type">byte</span>[] bytes, Stream stream)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="8-2-服务端"><a href="#8-2-服务端" class="headerlink" title="8.2 服务端"></a>8.2 服务端</h2><h3 id="8-2-1-处理请求"><a href="#8-2-1-处理请求" class="headerlink" title="8.2.1 处理请求"></a>8.2.1 处理请求</h3><p>服务端处理一个请求的流程：</p>
<ol>
<li><p>收到请求，触发IO解码<br>将底层的二进制数据转换为通信对象的过程。在Netty的编解码ChannelHandler里实现，对应<code>com.taobao.hsf.io.netty.tcp.NettyProtocolHandler#decode</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 使用byteBufferWrapper包装二进制字节对象ByteBuf</span></span><br><span class="line">    <span class="type">NettyByteBufferWrapper</span> <span class="variable">byteBufferWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyByteBufferWrapper</span>(in);</span><br><span class="line">    <span class="comment">// 使用frame包装底层的二进制字节对象</span></span><br><span class="line">    <span class="type">Frame</span> <span class="variable">frame</span> <span class="operator">=</span> Frame.of(byteBufferWrapper);</span><br><span class="line">    <span class="comment">// 选择一个Framer进行IO解码</span></span><br><span class="line">    <span class="type">Packet</span> <span class="variable">packet</span> <span class="operator">=</span> FramerSelector.getInstance().decode(frame);</span><br><span class="line">    <span class="keyword">if</span> (packet != <span class="literal">null</span>) &#123;</span><br><span class="line">        out.add(packet);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>根据协议类型，选择对应的<code>Framer</code><br>对应<code>com.taobao.hsf.io.FramerSelector#decode</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Packet <span class="title function_">decode</span><span class="params">(Frame frame)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">ByteBufferWrapper</span> <span class="variable">byteBufferWrapper</span> <span class="operator">=</span> frame.getByteBufferWrapper();</span><br><span class="line">    <span class="type">int</span> <span class="variable">originPos</span> <span class="operator">=</span> byteBufferWrapper.readerIndex();</span><br><span class="line">    <span class="keyword">if</span> (byteBufferWrapper.readableBytes() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        byteBufferWrapper.setReaderIndex(originPos);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 读出第一个字节，即协议类型</span></span><br><span class="line">    <span class="type">byte</span> <span class="variable">protocolType</span> <span class="operator">=</span> (<span class="type">byte</span>) Math.abs(byteBufferWrapper.readByte());</span><br><span class="line">    <span class="comment">// 从framer字典里选择对应协议的Framer，字典的索引是协议类型</span></span><br><span class="line">    <span class="comment">// framerDict在FramerSelector初始化时通过SPI获取生成</span></span><br><span class="line">    <span class="type">Framer</span> <span class="variable">framer</span> <span class="operator">=</span> framerDict[protocolType];</span><br><span class="line">    <span class="keyword">if</span> (framer == <span class="literal">null</span>) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;&quot;</span>, <span class="string">&quot;Receive unsupported protocol:&quot;</span> + protocolType);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">HSFException</span>(<span class="string">&quot;Receive unsupported protocol:&quot;</span> + protocolType);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 执行framer的decode，转换成Packet</span></span><br><span class="line">    <span class="type">Packet</span> <span class="variable">packet</span> <span class="operator">=</span> framer.decode(byteBufferWrapper, originPos);</span><br><span class="line">    <span class="keyword">if</span> (packet != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> packet;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        byteBufferWrapper.setReaderIndex(originPos);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Framer</code>将<code>Frame</code>解码转换成<code>Packet</code><br>参考<a target="_blank" rel="noopener" href="http://site.alibaba.net/middleware-container/hsf-guide/hsf-guide-book/chapter6-3.html">HFS2协议</a>进行解码，主要的逻辑在<code>com.taobao.hsf.io.remoting.hsf.message.HSFFramer#decode</code>和<code>com.taobao.hsf.io.remoting.hsf.message.HSFFramer#decodeRequest</code>中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Packet <span class="title function_">decode</span><span class="params">(ByteBufferWrapper wrapper, <span class="type">int</span> originPos)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (wrapper.readableBytes() &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        wrapper.setReaderIndex(originPos);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">byte</span> <span class="variable">version</span> <span class="operator">=</span> wrapper.readByte();</span><br><span class="line">    <span class="keyword">if</span> (version == VERSION) &#123;</span><br><span class="line">        <span class="type">byte</span> <span class="variable">type</span> <span class="operator">=</span> wrapper.readByte();</span><br><span class="line">        <span class="keyword">if</span> (type == REQUEST) &#123;</span><br><span class="line">            <span class="keyword">return</span> decodeRequest(wrapper, originPos);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == RESPONSE) &#123;</span><br><span class="line">            <span class="keyword">return</span> decodeRpcResponse(wrapper, originPos);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, <span class="string">&quot;protocol type : &quot;</span> + type + <span class="string">&quot; is not supported!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        log.error(<span class="string">&quot;&quot;</span>, <span class="string">&quot;protocol version :&quot;</span> + version + <span class="string">&quot; is not supported!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> Packet <span class="title function_">decodeRequest</span><span class="params">(ByteBufferWrapper wrapper, <span class="keyword">final</span> <span class="type">int</span> originPos)</span> &#123;</span><br><span class="line">    <span class="comment">// 省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
<li><p>完成IO解码后，触发消息监听器的<code>received()</code>方法，通过<code>ServerHandlerSelector</code>根据协议类型选择一个<code>ServerHandler</code>开始处理<code>Packet</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.taobao.hsf.io.stream.support.server.HandleRequest#received</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">received</span><span class="params">(Server server, ServerStream stream, RequestPacket requestPacket)</span> &#123;</span><br><span class="line">    <span class="type">ServerHandler</span> <span class="variable">serverHandler</span> <span class="operator">=</span> ServerHandlerSelector.getInstance().select(requestPacket.protocolType());</span><br><span class="line">    serverHandler.process(requestPacket, stream);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>ServerHandler</code>进行处理，两个关键步骤：反序列化和请求处理。参考<code>com.taobao.hsf.io.remoting.hsf.message.HSFServerHandler#process</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(<span class="keyword">final</span> HSFRequestPacket packet, <span class="keyword">final</span> ServerStream serverStream)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">serviceUniqueName</span> <span class="operator">=</span> packet.serviceUniqueName();</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">final</span> Invocation ioInvocation;</span><br><span class="line">    <span class="keyword">if</span> (packet.serializeType() == SerializeType.OPTIMIZED_HESSIAN2.getCode()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServiceMetadata</span> <span class="variable">serviceMetadata</span> <span class="operator">=</span> locateAndSetApplication(serviceUniqueName);</span><br><span class="line">            <span class="comment">// 关键步骤1：反序列化，将Packet转换为Invocation对象</span></span><br><span class="line">            ioInvocation = PacketFactorySelector.getInstance().select(packet.protocolType()).serverGet(</span><br><span class="line">                    packet, serverStream);</span><br><span class="line"><span class="comment">// 省略代码</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line"><span class="comment">// 省略代码</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ioInvocation = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 异步处理</span></span><br><span class="line">        processor.executor(serviceUniqueName).execute(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">// 省略，invocation的属性赋值</span></span><br><span class="line">		</span><br><span class="line">                    <span class="comment">// 关键步骤2：交给processor进行真正的请求处理</span></span><br><span class="line">                    processor.handleRequest(invocation, <span class="keyword">new</span> <span class="title class_">RpcOutput</span>(invocation, serverStream));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;HSF-0037&quot;</span>, <span class="string">&quot;decode error on channel &quot;</span> + serverStream, e);</span><br><span class="line">                    processSerializationError(packet, serverStream);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="comment">// 省略，错误处理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>反序列化，参考<code>com.taobao.hsf.io.remoting.hsf.HSFPacketFactory#serverGet</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 选择指定序列化类型的序列化器</span></span><br><span class="line"><span class="type">Serializer</span> <span class="variable">serializer</span> <span class="operator">=</span> SerializerSelector.getInstance().select(hsfRequestPacket.serializeType());</span><br><span class="line"><span class="comment">// 进行反序列化，将字节转换为原始对象</span></span><br><span class="line">Object[] argsObjects = <span class="keyword">new</span> <span class="title class_">Object</span>[hsfRequestPacket.getArgs().length];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; argsObjects.length; i++) &#123;</span><br><span class="line">    argsObjects[i] = serializer.deserialize(hsfRequestPacket.getArgs()[i],</span><br><span class="line">            ClassUtils.forName(argTypeStrings[i]), serverStream);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="8-2-2-发送响应"><a href="#8-2-2-发送响应" class="headerlink" title="8.2.2 发送响应"></a>8.2.2 发送响应</h3><p>与处理请求的流程相反。</p>
<ol>
<li><p>通过<code>ServerStream</code>发送RPC响应对象<code>RPCResult</code>，触发<code>RPCResult</code>到<code>Packet</code>的转换，即<strong>序列化</strong></p>
<p>参考<code>com.taobao.hsf.io.stream.AbstractServerStream#write</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(RPCResult rpcResult)</span> &#123;</span><br><span class="line">    <span class="comment">// 同样根据协议类型，将RPCResult转换为ResponsePacket</span></span><br><span class="line">    <span class="type">byte</span> <span class="variable">protocolType</span> <span class="operator">=</span> rpcResult.getResponseContext().getProtocolType();</span><br><span class="line">    <span class="type">PacketFactory</span> <span class="variable">packetFactory</span> <span class="operator">=</span> PacketFactorySelector.getInstance().select(protocolType);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据请求类型(业务请求or心跳)组装streamWriteRequest</span></span><br><span class="line">    <span class="type">StreamWriteRequest</span> <span class="variable">streamWriteRequest</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (rpcResult.getInvocationType() == InvocationType.BIZ) &#123;</span><br><span class="line">        <span class="keyword">if</span> (rpcResult.getResponseContext().getSerializeType() == SerializeType.OPTIMIZED_HESSIAN2.getCode()) &#123;</span><br><span class="line">            streamWriteRequest = <span class="keyword">new</span> <span class="title class_">StreamWriteRequest</span>(rpcResult);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 关键步骤：通过packetFactory执行序列化，得到responsePacket</span></span><br><span class="line">            <span class="type">ResponsePacket</span> <span class="variable">responsePacket</span> <span class="operator">=</span> packetFactory.serverCreate(rpcResult, <span class="built_in">this</span>);</span><br><span class="line">            streamWriteRequest = <span class="keyword">new</span> <span class="title class_">StreamWriteRequest</span>(responsePacket);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">requestId</span> <span class="operator">=</span> rpcResult.getResponseContext().getRequestId();</span><br><span class="line">        <span class="type">ResponsePacket</span> <span class="variable">responsePacket</span> <span class="operator">=</span> packetFactory.serverCreateHeartbeatResponse(requestId);</span><br><span class="line">        streamWriteRequest = <span class="keyword">new</span> <span class="title class_">StreamWriteRequest</span>(responsePacket);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向Netty的Channel写出Packet对象，通过ChannelPipeline会走到I/O编码的Handler，进一步进行I/O编码</span></span><br><span class="line">    send(streamWriteRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过一个<code>Serializer</code>进行序列化，参考<code>com.taobao.hsf.io.remoting.hsf.HSFPacketFactory#serverCreate</code></p>
</li>
<li><p>发送时，将<code>ResponsePacket</code>经I&#x2F;O编码转换为<code>Frame</code>，与I&#x2F;O编码同样在Netty的<code>com.taobao.hsf.io.netty.tcp.NettyProtocolHandler</code>中处理，对应<code>encode()</code>方法流程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(ChannelHandlerContext ctx, Packet msg, ByteBuf out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">NettyByteBufferWrapper</span> <span class="variable">byteBufferWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyByteBufferWrapper</span>(out);</span><br><span class="line">    FramerSelector.getInstance().encode(msg, byteBufferWrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="8-3-客户端"><a href="#8-3-客户端" class="headerlink" title="8.3 客户端"></a>8.3 客户端</h2><h3 id="8-3-1-发送请求"><a href="#8-3-1-发送请求" class="headerlink" title="8.3.1 发送请求"></a>8.3.1 发送请求</h3><p>客户端发送请求与服务端发送响应对IO编解码这一层来说是相同的机制。区别在于服务端发送响应是<code>RPCResult</code>对象，客户端发送请求是<code>Invocation</code>对象。</p>
<h3 id="8-3-2-接收响应"><a href="#8-3-2-接收响应" class="headerlink" title="8.3.2 接收响应"></a>8.3.2 接收响应</h3><p>同样，与服务端处理请求是相同的机制。只是处理的对象不同。</p>
<h1 id="9-框架领域3-网络层"><a href="#9-框架领域3-网络层" class="headerlink" title="9 框架领域3-网络层"></a>9 框架领域3-网络层</h1><h2 id="9-1-设计理念"><a href="#9-1-设计理念" class="headerlink" title="9.1 设计理念"></a>9.1 设计理念</h2><p>HSF网络层设计的几个特点：</p>
<ul>
<li>SPI：接口与实现分离，接口只负责提供I&#x2F;O操作抽象（<code>hsf-io</code>模块）。具体实现默认使用Netty（<code>hsf-io-netty</code>模块），可以灵活地替换为其他NIO框架</li>
<li>事件驱动：使用Netty实现异步非阻塞，并且把逻辑抽取到监听器中，由I&#x2F;O事件触发</li>
<li>可扩展：通过实现监听器（<code>ClientStreamMessageListener</code>&#x2F;<code>ServerStreamLifecycleListener</code>等），实现功能扩展</li>
</ul>
<p>两个核心概念：网络抽象、事件监听。</p>
<h3 id="9-1-1-网络抽象"><a href="#9-1-1-网络抽象" class="headerlink" title="9.1.1 网络抽象"></a>9.1.1 网络抽象</h3><ol>
<li><p>连接的抽象</p>
<p><a class="simple-lightbox" href="data:image/svg+xml;utf8,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22us-ascii%22%20standalone%3D%22no%22%3F%3E%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20contentStyleType%3D%22text%2Fcss%22%20height%3D%22473px%22%20preserveAspectRatio%3D%22none%22%20style%3D%22width%3A475px%3Bheight%3A473px%3Bbackground%3A%23FFFFFF%3B%22%20version%3D%221.1%22%20viewBox%3D%220%200%20475%20473%22%20width%3D%22475px%22%20zoomAndPan%3D%22magnify%22%3E%3Cdefs%2F%3E%3Cg%3E%3Cg%20id%3D%22elem_Stream%22%3E%3Crect%20codeLine%3D%221%22%20fill%3D%22%23F1F1F1%22%20height%3D%22113.1875%22%20id%3D%22Stream%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22289%22%20x%3D%22106.5%22%20y%3D%22353%22%2F%3E%3Cellipse%20cx%3D%22222.25%22%20cy%3D%22369%22%20fill%3D%22%23B4A7E5%22%20rx%3D%2211%22%20ry%3D%2211%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpath%20d%3D%22M218.1719%2C364.7656%20L218.1719%2C362.6094%20L225.5625%2C362.6094%20L225.5625%2C364.7656%20L223.0938%2C364.7656%20L223.0938%2C372.8438%20L225.5625%2C372.8438%20L225.5625%2C375%20L218.1719%2C375%20L218.1719%2C372.8438%20L220.6406%2C372.8438%20L220.6406%2C364.7656%20L218.1719%2C364.7656%20Z%20%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20font-style%3D%22italic%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2249%22%20x%3D%22242.75%22%20y%3D%22373.8467%22%3EStream%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22107.5%22%20x2%3D%22394.5%22%20y1%3D%22385%22%20y2%3D%22385%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22107.5%22%20x2%3D%22394.5%22%20y1%3D%22393%22%20y2%3D%22393%22%2F%3E%3Cellipse%20cx%3D%22117.5%22%20cy%3D%22406.6484%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22131%22%20x%3D%22126.5%22%20y%3D%22409.9951%22%3EisActive()%20%3A%20boolean%3C%2Ftext%3E%3Cellipse%20cx%3D%22117.5%22%20cy%3D%22422.9453%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22243%22%20x%3D%22126.5%22%20y%3D%22426.292%22%3EgetLocalAddress()%20%3A%20SocketAddress%3C%2Ftext%3E%3Cellipse%20cx%3D%22117.5%22%20cy%3D%22439.2422%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22263%22%20x%3D%22126.5%22%20y%3D%22442.5889%22%3EgetRemoteAddress()%20%3A%20SocketAddress%3C%2Ftext%3E%3Cellipse%20cx%3D%22117.5%22%20cy%3D%22455.5391%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2247%22%20x%3D%22126.5%22%20y%3D%22458.8857%22%3Eclose()%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_ClientStream%22%3E%3Crect%20codeLine%3D%228%22%20fill%3D%22%23F1F1F1%22%20height%3D%22113.1875%22%20id%3D%22ClientStream%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22256%22%20x%3D%227%22%20y%3D%22180%22%2F%3E%3Cellipse%20cx%3D%2286.75%22%20cy%3D%22196%22%20fill%3D%22%23B4A7E5%22%20rx%3D%2211%22%20ry%3D%2211%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpath%20d%3D%22M82.6719%2C191.7656%20L82.6719%2C189.6094%20L90.0625%2C189.6094%20L90.0625%2C191.7656%20L87.5938%2C191.7656%20L87.5938%2C199.8438%20L90.0625%2C199.8438%20L90.0625%2C202%20L82.6719%2C202%20L82.6719%2C199.8438%20L85.1406%2C199.8438%20L85.1406%2C191.7656%20L82.6719%2C191.7656%20Z%20%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20font-style%3D%22italic%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2288%22%20x%3D%22107.25%22%20y%3D%22200.8467%22%3EClientStream%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%228%22%20x2%3D%22262%22%20y1%3D%22212%22%20y2%3D%22212%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%228%22%20x2%3D%22262%22%20y1%3D%22220%22%20y2%3D%22220%22%2F%3E%3Cellipse%20cx%3D%2218%22%20cy%3D%22233.6484%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22230%22%20x%3D%2227%22%20y%3D%22236.9951%22%3Ewrite(Request)%20%3A%20ListenableFuture%3C%2Ftext%3E%3Cellipse%20cx%3D%2218%22%20cy%3D%22249.9453%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22204%22%20x%3D%2227%22%20y%3D%22253.292%22%3EgetContinuousHbTimes()%20%3A%20int%3C%2Ftext%3E%3Cellipse%20cx%3D%2218%22%20cy%3D%22266.2422%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22177%22%20x%3D%2227%22%20y%3D%22269.5889%22%3EaddContinuousHbTimes()%3C%2Ftext%3E%3Cellipse%20cx%3D%2218%22%20cy%3D%22282.5391%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22184%22%20x%3D%2227%22%20y%3D%22285.8857%22%3EclearContinuousHbTimes()%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_ServerStream%22%3E%3Crect%20codeLine%3D%2215%22%20fill%3D%22%23F1F1F1%22%20height%3D%2264.2969%22%20id%3D%22ServerStream%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22140%22%20x%3D%22298%22%20y%3D%22204.5%22%2F%3E%3Cellipse%20cx%3D%22319.75%22%20cy%3D%22220.5%22%20fill%3D%22%23B4A7E5%22%20rx%3D%2211%22%20ry%3D%2211%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpath%20d%3D%22M315.6719%2C216.2656%20L315.6719%2C214.1094%20L323.0625%2C214.1094%20L323.0625%2C216.2656%20L320.5938%2C216.2656%20L320.5938%2C224.3438%20L323.0625%2C224.3438%20L323.0625%2C226.5%20L315.6719%2C226.5%20L315.6719%2C224.3438%20L318.1406%2C224.3438%20L318.1406%2C216.2656%20L315.6719%2C216.2656%20Z%20%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20font-style%3D%22italic%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2293%22%20x%3D%22335.25%22%20y%3D%22225.3467%22%3EServerStream%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22299%22%20x2%3D%22437%22%20y1%3D%22236.5%22%20y2%3D%22236.5%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22299%22%20x2%3D%22437%22%20y1%3D%22244.5%22%20y2%3D%22244.5%22%2F%3E%3Cellipse%20cx%3D%22309%22%20cy%3D%22258.1484%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22114%22%20x%3D%22318%22%20y%3D%22261.4951%22%3Ewrite(Response)%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_Client%22%3E%3Crect%20codeLine%3D%2219%22%20fill%3D%22%23F1F1F1%22%20height%3D%2264.2969%22%20id%3D%22Client%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22227%22%20x%3D%2221.5%22%20y%3D%2231.5%22%2F%3E%3Cellipse%20cx%3D%22111.25%22%20cy%3D%2247.5%22%20fill%3D%22%23B4A7E5%22%20rx%3D%2211%22%20ry%3D%2211%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpath%20d%3D%22M107.1719%2C43.2656%20L107.1719%2C41.1094%20L114.5625%2C41.1094%20L114.5625%2C43.2656%20L112.0938%2C43.2656%20L112.0938%2C51.3438%20L114.5625%2C51.3438%20L114.5625%2C53.5%20L107.1719%2C53.5%20L107.1719%2C51.3438%20L109.6406%2C51.3438%20L109.6406%2C43.2656%20L107.1719%2C43.2656%20Z%20%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20font-style%3D%22italic%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2239%22%20x%3D%22131.75%22%20y%3D%2252.3467%22%3EClient%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%2222.5%22%20x2%3D%22247.5%22%20y1%3D%2263.5%22%20y2%3D%2263.5%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%2222.5%22%20x2%3D%22247.5%22%20y1%3D%2271.5%22%20y2%3D%2271.5%22%2F%3E%3Cellipse%20cx%3D%2232.5%22%20cy%3D%2285.1484%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22201%22%20x%3D%2241.5%22%20y%3D%2288.4951%22%3Eof(ServiceURL)%20%3A%20ClientStream%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_Server%22%3E%3Crect%20codeLine%3D%2223%22%20fill%3D%22%23F1F1F1%22%20height%3D%22113.1875%22%20id%3D%22Server%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22184%22%20x%3D%22284%22%20y%3D%227%22%2F%3E%3Cellipse%20cx%3D%22349.75%22%20cy%3D%2223%22%20fill%3D%22%23B4A7E5%22%20rx%3D%2211%22%20ry%3D%2211%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpath%20d%3D%22M345.6719%2C18.7656%20L345.6719%2C16.6094%20L353.0625%2C16.6094%20L353.0625%2C18.7656%20L350.5938%2C18.7656%20L350.5938%2C26.8438%20L353.0625%2C26.8438%20L353.0625%2C29%20L345.6719%2C29%20L345.6719%2C26.8438%20L348.1406%2C26.8438%20L348.1406%2C18.7656%20L345.6719%2C18.7656%20Z%20%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20font-style%3D%22italic%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2244%22%20x%3D%22370.25%22%20y%3D%2227.8467%22%3EServer%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22285%22%20x2%3D%22467%22%20y1%3D%2239%22%20y2%3D%2239%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22285%22%20x2%3D%22467%22%20y1%3D%2247%22%20y2%3D%2247%22%2F%3E%3Cellipse%20cx%3D%22295%22%20cy%3D%2260.6484%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22105%22%20x%3D%22304%22%20y%3D%2263.9951%22%3Ebind(String%2C%20int)%3C%2Ftext%3E%3Cellipse%20cx%3D%22295%22%20cy%3D%2276.9453%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22158%22%20x%3D%22304%22%20y%3D%2280.292%22%3EgetHostName()%20%3A%20String%3C%2Ftext%3E%3Cellipse%20cx%3D%22295%22%20cy%3D%2293.2422%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2291%22%20x%3D%22304%22%20y%3D%2296.5889%22%3EgetPort()%20%3A%20int%3C%2Ftext%3E%3Cellipse%20cx%3D%22295%22%20cy%3D%22109.5391%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2247%22%20x%3D%22304%22%20y%3D%22112.8857%22%3Eclose()%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22link_Client_ClientStream%22%3E%3Cpath%20codeLine%3D%2230%22%20d%3D%22M135%2C95.864%20C135%2C119.294%20135%2C145.937%20135%2C173.771%20%22%20fill%3D%22none%22%20id%3D%22Client-to-ClientStream%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22135%2C179.771%2C139%2C170.771%2C135%2C174.771%2C131%2C170.771%2C135%2C179.771%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22link_ClientStream_Stream%22%3E%3Cpath%20codeLine%3D%2231%22%20d%3D%22M172.662%2C293.019%20C185.694%2C312.23%20190.1894%2C318.8595%20203.2234%2C338.0715%20%22%20fill%3D%22none%22%20id%3D%22ClientStream-to-Stream%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22none%22%20points%3D%22213.329%2C352.967%2C208.1886%2C334.7029%2C198.2582%2C341.44%2C213.329%2C352.967%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22link_ServerStream_Stream%22%3E%3Cpath%20codeLine%3D%2232%22%20d%3D%22M346.54%2C268.864%20C330.51%2C292.294%20318.3392%2C310.0814%20299.2952%2C337.9154%20%22%20fill%3D%22none%22%20id%3D%22ServerStream-to-Stream%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22none%22%20points%3D%22289.131%2C352.771%2C304.2471%2C341.3035%2C294.3433%2C334.5273%2C289.131%2C352.771%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E"><img   src="/images/loading.svg" data-src="data:image/svg+xml;utf8,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22us-ascii%22%20standalone%3D%22no%22%3F%3E%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20contentStyleType%3D%22text%2Fcss%22%20height%3D%22473px%22%20preserveAspectRatio%3D%22none%22%20style%3D%22width%3A475px%3Bheight%3A473px%3Bbackground%3A%23FFFFFF%3B%22%20version%3D%221.1%22%20viewBox%3D%220%200%20475%20473%22%20width%3D%22475px%22%20zoomAndPan%3D%22magnify%22%3E%3Cdefs%2F%3E%3Cg%3E%3Cg%20id%3D%22elem_Stream%22%3E%3Crect%20codeLine%3D%221%22%20fill%3D%22%23F1F1F1%22%20height%3D%22113.1875%22%20id%3D%22Stream%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22289%22%20x%3D%22106.5%22%20y%3D%22353%22%2F%3E%3Cellipse%20cx%3D%22222.25%22%20cy%3D%22369%22%20fill%3D%22%23B4A7E5%22%20rx%3D%2211%22%20ry%3D%2211%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpath%20d%3D%22M218.1719%2C364.7656%20L218.1719%2C362.6094%20L225.5625%2C362.6094%20L225.5625%2C364.7656%20L223.0938%2C364.7656%20L223.0938%2C372.8438%20L225.5625%2C372.8438%20L225.5625%2C375%20L218.1719%2C375%20L218.1719%2C372.8438%20L220.6406%2C372.8438%20L220.6406%2C364.7656%20L218.1719%2C364.7656%20Z%20%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20font-style%3D%22italic%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2249%22%20x%3D%22242.75%22%20y%3D%22373.8467%22%3EStream%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22107.5%22%20x2%3D%22394.5%22%20y1%3D%22385%22%20y2%3D%22385%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22107.5%22%20x2%3D%22394.5%22%20y1%3D%22393%22%20y2%3D%22393%22%2F%3E%3Cellipse%20cx%3D%22117.5%22%20cy%3D%22406.6484%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22131%22%20x%3D%22126.5%22%20y%3D%22409.9951%22%3EisActive()%20%3A%20boolean%3C%2Ftext%3E%3Cellipse%20cx%3D%22117.5%22%20cy%3D%22422.9453%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22243%22%20x%3D%22126.5%22%20y%3D%22426.292%22%3EgetLocalAddress()%20%3A%20SocketAddress%3C%2Ftext%3E%3Cellipse%20cx%3D%22117.5%22%20cy%3D%22439.2422%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22263%22%20x%3D%22126.5%22%20y%3D%22442.5889%22%3EgetRemoteAddress()%20%3A%20SocketAddress%3C%2Ftext%3E%3Cellipse%20cx%3D%22117.5%22%20cy%3D%22455.5391%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2247%22%20x%3D%22126.5%22%20y%3D%22458.8857%22%3Eclose()%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_ClientStream%22%3E%3Crect%20codeLine%3D%228%22%20fill%3D%22%23F1F1F1%22%20height%3D%22113.1875%22%20id%3D%22ClientStream%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22256%22%20x%3D%227%22%20y%3D%22180%22%2F%3E%3Cellipse%20cx%3D%2286.75%22%20cy%3D%22196%22%20fill%3D%22%23B4A7E5%22%20rx%3D%2211%22%20ry%3D%2211%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpath%20d%3D%22M82.6719%2C191.7656%20L82.6719%2C189.6094%20L90.0625%2C189.6094%20L90.0625%2C191.7656%20L87.5938%2C191.7656%20L87.5938%2C199.8438%20L90.0625%2C199.8438%20L90.0625%2C202%20L82.6719%2C202%20L82.6719%2C199.8438%20L85.1406%2C199.8438%20L85.1406%2C191.7656%20L82.6719%2C191.7656%20Z%20%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20font-style%3D%22italic%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2288%22%20x%3D%22107.25%22%20y%3D%22200.8467%22%3EClientStream%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%228%22%20x2%3D%22262%22%20y1%3D%22212%22%20y2%3D%22212%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%228%22%20x2%3D%22262%22%20y1%3D%22220%22%20y2%3D%22220%22%2F%3E%3Cellipse%20cx%3D%2218%22%20cy%3D%22233.6484%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22230%22%20x%3D%2227%22%20y%3D%22236.9951%22%3Ewrite(Request)%20%3A%20ListenableFuture%3C%2Ftext%3E%3Cellipse%20cx%3D%2218%22%20cy%3D%22249.9453%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22204%22%20x%3D%2227%22%20y%3D%22253.292%22%3EgetContinuousHbTimes()%20%3A%20int%3C%2Ftext%3E%3Cellipse%20cx%3D%2218%22%20cy%3D%22266.2422%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22177%22%20x%3D%2227%22%20y%3D%22269.5889%22%3EaddContinuousHbTimes()%3C%2Ftext%3E%3Cellipse%20cx%3D%2218%22%20cy%3D%22282.5391%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22184%22%20x%3D%2227%22%20y%3D%22285.8857%22%3EclearContinuousHbTimes()%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_ServerStream%22%3E%3Crect%20codeLine%3D%2215%22%20fill%3D%22%23F1F1F1%22%20height%3D%2264.2969%22%20id%3D%22ServerStream%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22140%22%20x%3D%22298%22%20y%3D%22204.5%22%2F%3E%3Cellipse%20cx%3D%22319.75%22%20cy%3D%22220.5%22%20fill%3D%22%23B4A7E5%22%20rx%3D%2211%22%20ry%3D%2211%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpath%20d%3D%22M315.6719%2C216.2656%20L315.6719%2C214.1094%20L323.0625%2C214.1094%20L323.0625%2C216.2656%20L320.5938%2C216.2656%20L320.5938%2C224.3438%20L323.0625%2C224.3438%20L323.0625%2C226.5%20L315.6719%2C226.5%20L315.6719%2C224.3438%20L318.1406%2C224.3438%20L318.1406%2C216.2656%20L315.6719%2C216.2656%20Z%20%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20font-style%3D%22italic%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2293%22%20x%3D%22335.25%22%20y%3D%22225.3467%22%3EServerStream%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22299%22%20x2%3D%22437%22%20y1%3D%22236.5%22%20y2%3D%22236.5%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22299%22%20x2%3D%22437%22%20y1%3D%22244.5%22%20y2%3D%22244.5%22%2F%3E%3Cellipse%20cx%3D%22309%22%20cy%3D%22258.1484%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22114%22%20x%3D%22318%22%20y%3D%22261.4951%22%3Ewrite(Response)%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_Client%22%3E%3Crect%20codeLine%3D%2219%22%20fill%3D%22%23F1F1F1%22%20height%3D%2264.2969%22%20id%3D%22Client%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22227%22%20x%3D%2221.5%22%20y%3D%2231.5%22%2F%3E%3Cellipse%20cx%3D%22111.25%22%20cy%3D%2247.5%22%20fill%3D%22%23B4A7E5%22%20rx%3D%2211%22%20ry%3D%2211%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpath%20d%3D%22M107.1719%2C43.2656%20L107.1719%2C41.1094%20L114.5625%2C41.1094%20L114.5625%2C43.2656%20L112.0938%2C43.2656%20L112.0938%2C51.3438%20L114.5625%2C51.3438%20L114.5625%2C53.5%20L107.1719%2C53.5%20L107.1719%2C51.3438%20L109.6406%2C51.3438%20L109.6406%2C43.2656%20L107.1719%2C43.2656%20Z%20%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20font-style%3D%22italic%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2239%22%20x%3D%22131.75%22%20y%3D%2252.3467%22%3EClient%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%2222.5%22%20x2%3D%22247.5%22%20y1%3D%2263.5%22%20y2%3D%2263.5%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%2222.5%22%20x2%3D%22247.5%22%20y1%3D%2271.5%22%20y2%3D%2271.5%22%2F%3E%3Cellipse%20cx%3D%2232.5%22%20cy%3D%2285.1484%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22201%22%20x%3D%2241.5%22%20y%3D%2288.4951%22%3Eof(ServiceURL)%20%3A%20ClientStream%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22elem_Server%22%3E%3Crect%20codeLine%3D%2223%22%20fill%3D%22%23F1F1F1%22%20height%3D%22113.1875%22%20id%3D%22Server%22%20rx%3D%222.5%22%20ry%3D%222.5%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20width%3D%22184%22%20x%3D%22284%22%20y%3D%227%22%2F%3E%3Cellipse%20cx%3D%22349.75%22%20cy%3D%2223%22%20fill%3D%22%23B4A7E5%22%20rx%3D%2211%22%20ry%3D%2211%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpath%20d%3D%22M345.6719%2C18.7656%20L345.6719%2C16.6094%20L353.0625%2C16.6094%20L353.0625%2C18.7656%20L350.5938%2C18.7656%20L350.5938%2C26.8438%20L353.0625%2C26.8438%20L353.0625%2C29%20L345.6719%2C29%20L345.6719%2C26.8438%20L348.1406%2C26.8438%20L348.1406%2C18.7656%20L345.6719%2C18.7656%20Z%20%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20font-style%3D%22italic%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2244%22%20x%3D%22370.25%22%20y%3D%2227.8467%22%3EServer%3C%2Ftext%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22285%22%20x2%3D%22467%22%20y1%3D%2239%22%20y2%3D%2239%22%2F%3E%3Cline%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A0.5%3B%22%20x1%3D%22285%22%20x2%3D%22467%22%20y1%3D%2247%22%20y2%3D%2247%22%2F%3E%3Cellipse%20cx%3D%22295%22%20cy%3D%2260.6484%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22105%22%20x%3D%22304%22%20y%3D%2263.9951%22%3Ebind(String%2C%20int)%3C%2Ftext%3E%3Cellipse%20cx%3D%22295%22%20cy%3D%2276.9453%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%22158%22%20x%3D%22304%22%20y%3D%2280.292%22%3EgetHostName()%20%3A%20String%3C%2Ftext%3E%3Cellipse%20cx%3D%22295%22%20cy%3D%2293.2422%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2291%22%20x%3D%22304%22%20y%3D%2296.5889%22%3EgetPort()%20%3A%20int%3C%2Ftext%3E%3Cellipse%20cx%3D%22295%22%20cy%3D%22109.5391%22%20fill%3D%22%2384BE84%22%20rx%3D%223%22%20ry%3D%223%22%20style%3D%22stroke%3A%23038048%3Bstroke-width%3A1.0%3B%22%2F%3E%3Ctext%20fill%3D%22%23000000%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20lengthAdjust%3D%22spacing%22%20textLength%3D%2247%22%20x%3D%22304%22%20y%3D%22112.8857%22%3Eclose()%3C%2Ftext%3E%3C%2Fg%3E%3Cg%20id%3D%22link_Client_ClientStream%22%3E%3Cpath%20codeLine%3D%2230%22%20d%3D%22M135%2C95.864%20C135%2C119.294%20135%2C145.937%20135%2C173.771%20%22%20fill%3D%22none%22%20id%3D%22Client-to-ClientStream%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22%23181818%22%20points%3D%22135%2C179.771%2C139%2C170.771%2C135%2C174.771%2C131%2C170.771%2C135%2C179.771%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22link_ClientStream_Stream%22%3E%3Cpath%20codeLine%3D%2231%22%20d%3D%22M172.662%2C293.019%20C185.694%2C312.23%20190.1894%2C318.8595%20203.2234%2C338.0715%20%22%20fill%3D%22none%22%20id%3D%22ClientStream-to-Stream%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22none%22%20points%3D%22213.329%2C352.967%2C208.1886%2C334.7029%2C198.2582%2C341.44%2C213.329%2C352.967%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3Cg%20id%3D%22link_ServerStream_Stream%22%3E%3Cpath%20codeLine%3D%2232%22%20d%3D%22M346.54%2C268.864%20C330.51%2C292.294%20318.3392%2C310.0814%20299.2952%2C337.9154%20%22%20fill%3D%22none%22%20id%3D%22ServerStream-to-Stream%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3Cpolygon%20fill%3D%22none%22%20points%3D%22289.131%2C352.771%2C304.2471%2C341.3035%2C294.3433%2C334.5273%2C289.131%2C352.771%22%20style%3D%22stroke%3A%23181818%3Bstroke-width%3A1.0%3B%22%2F%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E"  lazyload></a></p>
<p>将一个点对点的连接抽象为<code>Stream</code>，客户端对应<code>ClientStream</code>，服务端对应<code>ServerStream</code></p>
</li>
<li><p>端点的抽象</p>
<p>服务端<code>Server</code>和客户端<code>Client</code></p>
</li>
</ol>
<p>HSF允许使用不同的网络框架来实现上述的抽象，默认的是Netty。</p>
<h3 id="9-1-2-事件监听"><a href="#9-1-2-事件监听" class="headerlink" title="9.1.2 事件监听"></a>9.1.2 事件监听</h3><p>如果把I&#x2F;O事件的处理逻辑直接耦合在框架内部，扩展性会打折扣。HSF 2.2使用事件监听器将逻辑抽取出来，而不是直接放在Netty的<code>ChannelHandler</code>中。</p>
<p>监听器分客户端&#x2F;服务端，根据对连接生命周期事件还是消息事件感兴趣分类：</p>
<blockquote>
<table>
<thead>
<tr>
<th>监听器名称</th>
<th>功能描述</th>
<th>作用域</th>
</tr>
</thead>
<tbody><tr>
<td>ClientStreamLifecycleListener</td>
<td>客户端连接生命周期监听器 1.当前<code>Client</code>连接<code>ClientStream</code>建立失败 2.当前<code>Client</code>建立了一个连接<code>ClientStream</code> 3.当前<code>Client</code>关闭了一个连接<code>ClientStream</code> 4.当前的<code>Client</code>上的连接<code>ClientStream</code>处于空闲状态 5.当前<code>Client</code>上的连接<code>ClientStream</code>出现了异常</td>
<td>客户端</td>
</tr>
<tr>
<td>ClientStreamMessageListener</td>
<td>客户端连接消息监听器 1.客户端<code>Client</code>开始通过<code>ClientStream</code>写出一个数据 2.客户端<code>Client</code>通过<code>ClientStream</code>写出一个数据完毕 3.客户端<code>Client</code>通过<code>ClientStream</code>写出一个数据失败 4.客户端<code>Client</code>通过<code>ClientStream</code>收到一个数据</td>
<td>客户端</td>
</tr>
<tr>
<td>ServerStreamLifecycleListener</td>
<td>服务端连接生命周期监听器 1.服务端<code>Server</code>绑定成功 2.服务端<code>Server</code>绑定失败 3.服务端<code>Server</code>关闭 4.当前的<code>Server</code>接受建立了一个连接<code>ServerStream</code> 5.当前的<code>Server</code>关闭了一个连接<code>ServerStream</code> 6.当前的<code>Server</code>上<code>ServerStream</code>处于空闲状态 7.当前的<code>Server</code>上的<code>ServerStream</code>出现了异常</td>
<td>服务端</td>
</tr>
<tr>
<td>ServerStreamMessageListener</td>
<td>服务端连接消息监听器 1.服务端<code>Server</code>开始通过<code>ServerStream</code>写出一个数据 2.服务端<code>Server</code>通过<code>ServerStream</code>写出一个数据完毕 3.服务端<code>Server</code>通过<code>ServerStream</code>写出一个数据失败 4.服务端<code>Server</code>通过<code>ServerStream</code>收到一个数据</td>
<td>服务端</td>
</tr>
</tbody></table>
</blockquote>
<p>客户端监听器位于<code>com.taobao.hsf.io.stream.support.client</code>包下：<code>Close</code>&#x2F;<code>Connect</code>&#x2F;<code>ExcetpionCaught</code>&#x2F;<code>ReceiveResponse</code>&#x2F;<code>SendHeartbeat</code>&#x2F;<code>SendRequest</code>。</p>
<p>服务端监听器位于<code>com.taobao.hsf.io.stream.support.server</code>包下：<code>Accept</code>&#x2F;<code>Bind</code>&#x2F;<code>Close</code>&#x2F;<code>CloseIdle</code>&#x2F;<code>ExceptionLog</code>&#x2F;<code>HandleRequest</code></p>
<p>大部分监听器只对一种事件感兴趣，所以HSF提供了<code>Adapter</code>抽象类，例如<code>ClientStreamLifecycleListenerAdapter</code>，通过继承<code>Adapter</code>，重写感兴趣事件的方法实现对应事件监听。</p>
<h2 id="9-2-Server"><a href="#9-2-Server" class="headerlink" title="9.2 Server"></a>9.2 Server</h2><p>根据基于的协议，HSF提供两类<code>Server</code>。使用SPI的思路，接口和实现分离，实现默认使用Netty。</p>
<ul>
<li>TCP：默认，对应<code>com.taobao.hsf.io.netty.tcp.NettyTcpServer</code></li>
<li>HTTP：通过配置开关可以打开，对应<code>com.taobao.hsf.io.netty.http.NettyHttpServer</code></li>
</ul>
<p>HSF的Provider服务端需要具备的功能主要是：</p>
<ul>
<li>启动服务端侦听，接收Consumer的RPC请求连接</li>
<li>读数据，解码RPC请求</li>
<li>编码RPC响应，写数据</li>
</ul>
<h3 id="9-2-1-启动服务端侦听"><a href="#9-2-1-启动服务端侦听" class="headerlink" title="9.2.1 启动服务端侦听"></a>9.2.1 启动服务端侦听</h3><p>在发布第一个接口服务时，HSF就启动了Server。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">com.taobao.hsf.remoting.service.HSFProtocol#registerProvider --&gt; com.taobao.hsf.io.provider.impl.ProviderServerImpl#startHSFServer --&gt;</span><br><span class="line">com.taobao.hsf.io.server.AbstractServer#bind</span><br></pre></td></tr></table></figure>

<p><code>NettyTcpServer</code>提供真正的Server实现。</p>
<h4 id="9-2-1-1-主要变量"><a href="#9-2-1-1-主要变量" class="headerlink" title="9.2.1.1 主要变量"></a>9.2.1.1 主要变量</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">1</span>, <span class="keyword">new</span> <span class="title class_">PooledThreadFactory</span>(</span><br><span class="line">        HSFThreadNameSpace.HSF_NETTY_BOSS));</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">EventLoopGroup</span> <span class="variable">workerGroup</span> <span class="operator">=</span> Holder.WORKER_POOL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> List&lt;ServerStreamLifecycleListener&gt; serverStreamLifecycleListeners = HSFServiceContainer.getInstances(</span><br><span class="line">        ServerStreamLifecycleListener.class, <span class="string">&quot;tcp&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> List&lt;ServerStreamMessageListener&gt; serverStreamMessageListeners = HSFServiceContainer.getInstances(</span><br><span class="line">        ServerStreamMessageListener.class, <span class="string">&quot;tcp&quot;</span>);</span><br></pre></td></tr></table></figure>
<p><strong>注意点：</strong></p>
<ol>
<li><code>bossGroup</code>并没有使用默认线程数，而是指定使用一条线程，因为对于监听一个IP+端口的情况，只会用到一条；</li>
<li><code>workerGroup</code>是从<code>Holder</code>类中获取的**共享的<code>EventLoopGroup</code>**（考虑不应该在I&#x2F;O线程中执行耗时操作的原则）</li>
</ol>
<ul>
<li>可以通过配置项<code>hsf.ioworkers</code>指定线程数，不指定的话默认为核数*2</li>
<li>如果启用了HTTP的Server，也会共享这一<code>EventLoopGroup</code></li>
<li>如果应用兼具Provider和Consuer角色，作为客户端时也会共享这一<code>EventLoopGroup</code></li>
</ul>
<ol start="3">
<li>一组<code>serverStreamLifecycleListeners</code>和<code>serverStreamMessageListeners</code>分别监听连接生命周期（<code>bind</code>&#x2F;<code>close</code>&#x2F;<code>idle</code>&#x2F;<code>accept</code>等）和消息事件（<code>write</code>&#x2F;<code>received</code>等）</li>
</ol>
<h4 id="9-2-1-2-启动流程"><a href="#9-2-1-2-启动流程" class="headerlink" title="9.2.1.2 启动流程"></a>9.2.1.2 启动流程</h4><p>通过<code>doBind()</code>方法实现真正的绑定IP端口启动侦听动作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doBind</span><span class="params">(String hostName, <span class="type">int</span> port)</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> HSFServiceContainer.getInstance(ConfigService.class).getConfig();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可配置的几个</span></span><br><span class="line">    serverBootstrap.group(bossGroup, workerGroup)</span><br><span class="line">            .channel(NioServerSocketChannel.class)</span><br><span class="line">            .option(ChannelOption.ALLOCATOR, Holder.byteBufAllocator)</span><br><span class="line">            .option(ChannelOption.SO_BACKLOG, config.getInt(Server.HSF_BACKLOG_KEY))</span><br><span class="line">            .childOption(ChannelOption.ALLOCATOR, Holder.byteBufAllocator)</span><br><span class="line">            .childOption(ChannelOption.TCP_NODELAY, Boolean.TRUE)</span><br><span class="line">            .childOption(ChannelOption.SO_REUSEADDR, Boolean.TRUE)</span><br><span class="line">            .childOption(ChannelOption.AUTO_CLOSE, Boolean.TRUE)</span><br><span class="line">            .childOption(ChannelOption.ALLOW_HALF_CLOSURE, Boolean.FALSE)</span><br><span class="line">            .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;ServerSocketChannel&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(ServerSocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                    ch.pipeline()</span><br><span class="line">                            .addLast(<span class="string">&quot;serverBindHandler&quot;</span>,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">NettyBindHandler</span>(NettyTcpServer.<span class="built_in">this</span>,</span><br><span class="line">                                            serverStreamLifecycleListeners));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;NioSocketChannel&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(NioSocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                    ch.pipeline()</span><br><span class="line">                            .addLast(<span class="string">&quot;protocolHandler&quot;</span>, <span class="keyword">new</span> <span class="title class_">NettyProtocolHandler</span>())</span><br><span class="line">                            .addLast(<span class="string">&quot;serverIdleHandler&quot;</span>,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">IdleStateHandler</span>(<span class="number">0</span>, <span class="number">0</span>, serverIdleTimeInSeconds))</span><br><span class="line">                            .addLast(<span class="string">&quot;serverHandler&quot;</span>,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">NettyServerStreamHandler</span>(NettyTcpServer.<span class="built_in">this</span>, <span class="literal">false</span>,</span><br><span class="line">                                            serverStreamLifecycleListeners, serverStreamMessageListeners));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isWaterMarkEnabled()) &#123;</span><br><span class="line">        serverBootstrap.childOption(ChannelOption.WRITE_BUFFER_WATER_MARK,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">WriteBufferWaterMark</span>(lowWaterMark, highWaterMark));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> serverBootstrap.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(hostName, port));</span><br><span class="line">    future.syncUninterruptibly();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>主要工作：</strong></p>
<ol>
<li><p>设置tcp参数</p>
<ul>
<li>ChannelOption.SO_BACKLOG - so_backlog队列大小这个参数比较关键，所以HSF提供配置能力</li>
<li>ChannelOption.TCP_NODELAY - 禁用Nagle算法，保证实时性</li>
<li>ChannelOption.SO_REUSEADDR - 开启地址重用，底层对应<em>tcp_tw_reuse</em>，快速重用TIME_WAIT连接</li>
<li>ChannelOption.AUTO_CLOSE - 写出错时关闭socket，默认就是true，已经Deprecated</li>
<li>ChannelOption.ALLOW_HALF_CLOSURE - 不允许半关闭，半关闭的连接对HSF来说应该等同关闭了</li>
</ul>
</li>
<li><p>设置服务端连接handler - <code>NettyBindHandler</code>，作用在于在绑定成功或失败时回调生命周期监听器的<code>bindSuccess()</code>或<code>bindFailed()</code></p>
<ul>
<li>监听器实现：<code>com.taobao.hsf.io.stream.support.server.Bind</code>，记录日志</li>
</ul>
</li>
<li><p>设置每个客户端连接时的handler</p>
<ul>
<li><code>NettyProtocolHandler</code>：编解码</li>
<li><code>IdleStateHandler</code>：空闲时间到后触发idle事件</li>
<li><code>NettyServerStreamHandler</code>：连接状态监听</li>
</ul>
</li>
</ol>
<h3 id="9-2-2-连接处理"><a href="#9-2-2-连接处理" class="headerlink" title="9.2.2 连接处理"></a>9.2.2 连接处理</h3><p>对应3个<code>ChannelHandler</code>的处理。</p>
<h4 id="9-2-2-1-编解码处理：NettyProtocolHandler"><a href="#9-2-2-1-编解码处理：NettyProtocolHandler" class="headerlink" title="9.2.2.1 编解码处理：NettyProtocolHandler"></a>9.2.2.1 编解码处理：<code>NettyProtocolHandler</code></h4><p>作为ChannelPipeline中第一个ChannelHander，用于编解码。Netty提供<code>ByteToMessageCodec</code>类用于简化常用的字节—对象间转换。<code>NettyProtocolHandler</code>实现字节与序列化后的数据对象<code>Packet</code>间的转换。</p>
<ul>
<li>编码encode：将RPC响应编码成字节</li>
<li>解码decode：将字节转成RPC请求</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">NettyProtocolHandler</span> <span class="keyword">extends</span> <span class="title class_">ByteToMessageCodec</span>&lt;Packet&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(ChannelHandlerContext ctx, Packet msg, ByteBuf out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">NettyByteBufferWrapper</span> <span class="variable">byteBufferWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyByteBufferWrapper</span>(out);</span><br><span class="line">        <span class="comment">// 根据消息类型选择合适的Framer进行编码</span></span><br><span class="line">        FramerSelector.getInstance().encode(msg, byteBufferWrapper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 将Netty的ByteBuf包装成HSF的Frame</span></span><br><span class="line">        <span class="type">NettyByteBufferWrapper</span> <span class="variable">byteBufferWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyByteBufferWrapper</span>(in);</span><br><span class="line">        <span class="type">Frame</span> <span class="variable">frame</span> <span class="operator">=</span> Frame.of(byteBufferWrapper);</span><br><span class="line">        <span class="comment">// 根据消息类型选择合适的Framer进行编码</span></span><br><span class="line">        <span class="type">Packet</span> <span class="variable">packet</span> <span class="operator">=</span> FramerSelector.getInstance().decode(frame);</span><br><span class="line">        <span class="keyword">if</span> (packet != <span class="literal">null</span>) &#123;</span><br><span class="line">            out.add(packet);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="9-2-2-2-空闲处理：IdleStateHandler"><a href="#9-2-2-2-空闲处理：IdleStateHandler" class="headerlink" title="9.2.2.2 空闲处理：IdleStateHandler"></a>9.2.2.2 空闲处理：<code>IdleStateHandler</code></h4><p>Netty原生的ChannelHandler，配置时默认空闲时间90s，可以通过<code>hsf.server.idle.time</code>配置项配置。</p>
<p>HSF框架只关心链路上读和写都空闲时的状态：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">new IdleStateHandler(0, 0, serverIdleTimeInSeconds)</span><br></pre></td></tr></table></figure>

<p>在空闲时间到后，<code>IdleStateHandler</code>触发<code>IdleStateEvent</code>，进而<code>userEventTriggered</code>触发，回调事件监听器的<code>idle()</code>方法。HSF由此实现空闲链路的监控：</p>
<ul>
<li>客户端在空闲时发送心跳：<code>com.taobao.hsf.io.stream.support.client.SendHeartbeat#idle</code></li>
<li>服务端在空闲时关闭空闲连接：<code>com.taobao.hsf.io.stream.support.server.CloseIdle#idle</code></li>
</ul>
<h4 id="9-2-2-3-I-x2F-O处理：NettyServerStreamHandler"><a href="#9-2-2-3-I-x2F-O处理：NettyServerStreamHandler" class="headerlink" title="9.2.2.3 I&#x2F;O处理：NettyServerStreamHandler"></a>9.2.2.3 I&#x2F;O处理：<code>NettyServerStreamHandler</code></h4><p>处理连接上的I&#x2F;O事件。在每种事件发生时会回调事件监听器的对应方法，以此实现具体处理逻辑与NIO框架的解耦。</p>
<ul>
<li><p>连接建立 <code>channelActive</code></p>
<p>回调<code>ServerStreamLifecycleListener#accept</code></p>
</li>
<li><p>连接断开 <code>channelInactive</code></p>
<p>回调<code>ServerStreamLifecycleListener#accept</code></p>
</li>
<li><p>异常事件 <code>exceptionCaught</code></p>
<p>回调<code>ServerStreamLifecycleListener#exceptionCaught</code></p>
</li>
<li><p>自定义事件 <code>userEventTriggered</code></p>
<p>如果是<code>IdleStateEvent</code>，回调<code>ServerStreamLifecycleListener#idle</code></p>
</li>
<li><p>写 <code>write</code></p>
<ul>
<li>开始写，回调<code>ServerStreamMessageListener#write</code></li>
<li>写完，根据成功或失败，回调<code>ServerStreamMessageListener#writeSuccess</code>或<code>ServerStreamMessageListener#writeFailed</code></li>
</ul>
</li>
<li><p>读 <code>channelRead</code></p>
<p>回调<code>ServerStreamMessageListener#received</code></p>
</li>
</ul>
<p><strong>关键点：</strong></p>
<ol>
<li><p>连接建立时，在<code>channelActive()</code>方法中将Netty的连接对象<code>Channel</code>与HSF的连接对象<code>Stream</code>绑定</p>
<ul>
<li><p>通过将<code>Stream</code>作为<code>Channel</code>的属性<code>Attribute</code>实现</p>
</li>
<li><p>后续这个连接上的其他事件触发时，可以从<code>Channel</code>的<code>Attribute</code>中取出对应的<code>Stream</code>并回调监听器方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    AbstractServerStream serverStream;</span><br><span class="line">    <span class="keyword">if</span> (http) &#123;</span><br><span class="line">        serverStream = <span class="keyword">new</span> <span class="title class_">NettyHttpProviderStream</span>(ctx.channel());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        serverStream = <span class="keyword">new</span> <span class="title class_">NettyServerStream</span>(ctx.channel());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 配置serverStream，并绑定到Netty的Channel上</span></span><br><span class="line">    serverStream.setServer(server);</span><br><span class="line">    StreamUtils.bindChannel(ctx.channel(), serverStream);</span><br><span class="line">    <span class="comment">// 完成绑定后回调生命周期监听器的accept()方法</span></span><br><span class="line">    callConnectionAcceptListeners(server, serverStream);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>服务端的主要任务，处理RPC请求，通过回调监听器的<code>received()</code>方法实现，具体的实现类是<code>com.taobao.hsf.io.stream.support.server.HandleRequest</code>，处理时会根据解码后<code>RequestPacket</code>中的协议类型选择一个处理协议的<code>ServerHandler</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Tag(&#123;&quot;http&quot;, &quot;tcp&quot;&#125;)</span></span><br><span class="line"><span class="meta">@Order(20)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HandleRequest</span> <span class="keyword">extends</span> <span class="title class_">ServerStreamMessageListenerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">received</span><span class="params">(Server server, ServerStream stream, RequestPacket requestPacket)</span> &#123;</span><br><span class="line">        <span class="comment">// 根据protocolType选择合适的ServerHandler处理</span></span><br><span class="line">        <span class="type">ServerHandler</span> <span class="variable">serverHandler</span> <span class="operator">=</span> ServerHandlerSelector.getInstance().select(requestPacket.protocolType());</span><br><span class="line">        serverHandler.process(requestPacket, stream);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="9-3-Client"><a href="#9-3-Client" class="headerlink" title="9.3 Client"></a>9.3 Client</h2><blockquote>
<p>调用链路从客户端发起调用开始，经历了客户端的选址和负载均衡后，将参数对象完成序列化，经过框架协议编码后，通过网络层发送出去。服务端接受到数据后进行解码，解码获得的二进制协议派发到服务端线程完成反序列化，生成出参数对象，最终完成反射调用。</p>
</blockquote>
<p>Consumer发出一个RPC请求后，Client网络层主要的工作：</p>
<ol>
<li>建立连接</li>
<li>编码，发送RPC请求</li>
<li>接收RPC响应，解码</li>
</ol>
<h3 id="9-3-1-建立和获取连接"><a href="#9-3-1-建立和获取连接" class="headerlink" title="9.3.1 建立和获取连接"></a>9.3.1 建立和获取连接</h3><ol>
<li>客户端和服务端之间建立的是TCP长连接，连接会被缓存</li>
<li>在进行路由选址时，由<code>com.taobao.hsf.cluster.ConnectivityRouter</code>进行连通性检测，此时会尝试建立连接，如果连接建立成功，检测通过</li>
<li>最终进行调用时，由<code>com.taobao.hsf.remoting.service.RemotingRPCProtocolComponent#invokeForOne</code>尝试获取<code>ClientStream</code>并写请求给服务端</li>
</ol>
<p>类层次：</p>
<ol>
<li><p><code>com.taobao.hsf.io.client.Client</code>接口提供获取和建立连接的抽象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据serviceURL创建或者选择一个客户端连接</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> remotingURL 服务地址</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 客户端连接</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ClientStream <span class="title function_">of</span><span class="params">(ServiceURL remotingURL)</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>com.taobao.hsf.io.client.AbstractClient</code>提供实现提供和获取的实现，具体连接动作交给底层网络框架实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 如果无法建连会返回null,需要调用者重试</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> serviceURL 需要调用的url</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 客户端连接</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ClientStream <span class="title function_">of</span><span class="params">(ServiceURL serviceURL)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> serviceURL == <span class="literal">null</span> ? <span class="literal">null</span> : getClientStream(serviceURL.getConnectionSupport().pollConnectionID());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ClientStream <span class="title function_">getClientStream</span><span class="params">(<span class="keyword">final</span> ConnectionID connectionID)</span> &#123;</span><br><span class="line">    <span class="type">ClientStream</span> <span class="variable">stream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (connectionID != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 使用双重校验锁从缓存中获取连接</span></span><br><span class="line">        stream = streams.get(connectionID);</span><br><span class="line">        <span class="keyword">if</span> (stream == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (getStreamConnectLock(connectionID)) &#123;</span><br><span class="line">                stream = streams.get(connectionID);</span><br><span class="line">                <span class="keyword">if</span> (stream == <span class="literal">null</span>) &#123;</span><br><span class="line">                    stream = connect(connectionID);</span><br><span class="line">                    <span class="comment">// 能连接上才会放置到缓存中，防止空放置</span></span><br><span class="line">                    <span class="keyword">if</span> (stream != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="type">ClientStream</span> <span class="variable">oldStream</span> <span class="operator">=</span> streams.putIfAbsent(connectionID, stream);</span><br><span class="line">                        <span class="keyword">if</span> (oldStream != <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="comment">// 发现已经有线程完成了创建</span></span><br><span class="line">                            stream.close();</span><br><span class="line">                            stream = oldStream;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> stream;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>com.taobao.hsf.io.netty.tcp.NettyClient</code>中对应底层网络框架的实现，参考<code>connect()</code>方法。。</p>
<ul>
<li>TCP参数配置与服务端类似</li>
<li><code>ChannelHandler</code>与服务端基本相同<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> ClientStream <span class="title function_">connect</span><span class="params">(<span class="keyword">final</span> ConnectionID connectionID)</span> &#123;</span><br><span class="line">      <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">      bootstrap.group(Holder.WORKER_POOL) <span class="comment">// 使用共享的EventLoopGroup</span></span><br><span class="line">              .option(ChannelOption.TCP_NODELAY, <span class="literal">true</span>) <span class="comment">// 禁用Nagle算法</span></span><br><span class="line">              .option(ChannelOption.SO_REUSEADDR, <span class="literal">true</span>) <span class="comment">// 开启socket重用</span></span><br><span class="line">                      <span class="comment">// .option(ChannelOption.SO_KEEPALIVE, true)// 没有启用TCP层keepalive，而是使用自发心跳</span></span><br><span class="line">              .option(ChannelOption.ALLOCATOR, Holder.byteBufAllocator)</span><br><span class="line">              .option(ChannelOption.AUTO_CLOSE, Boolean.TRUE)</span><br><span class="line">              .option(ChannelOption.ALLOW_HALF_CLOSURE, Boolean.FALSE)</span><br><span class="line">              .channel(NioSocketChannel.class)</span><br><span class="line">              .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;NioSocketChannel&gt;() &#123;</span><br><span class="line">   </span><br><span class="line">                  <span class="meta">@Override</span></span><br><span class="line">                  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(NioSocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                      ch.pipeline()</span><br><span class="line">                          	<span class="comment">// 编解码</span></span><br><span class="line">                              .addLast(<span class="string">&quot;protocol&quot;</span>, <span class="keyword">new</span> <span class="title class_">NettyProtocolHandler</span>())</span><br><span class="line">                          	<span class="comment">// 空闲检测</span></span><br><span class="line">                              .addLast(<span class="string">&quot;clientIdleHandler&quot;</span>, <span class="keyword">new</span> <span class="title class_">IdleStateHandler</span>(getHbSentInterval(), <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">                          	<span class="comment">// I/O事件处理，触发监听器方法</span></span><br><span class="line">                              .addLast(<span class="string">&quot;clientHandler&quot;</span>,</span><br><span class="line">                                      <span class="keyword">new</span> <span class="title class_">NettyClientStreamHandler</span>(NettyClient.<span class="built_in">this</span>, connectionID,</span><br><span class="line">                                              clientStreamLifecycleListeners, clientStreamMessageListeners));</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;);</span><br><span class="line"><span class="comment">// 指定连接超时，会影响连通性检测等待时间</span></span><br><span class="line">      <span class="comment">//int connectTimeout = connectionID.getParameter(TRConstants.CONNECT_TIMEOUT_KEY, 4000);</span></span><br><span class="line">      <span class="type">int</span> <span class="variable">connectTimeout</span> <span class="operator">=</span> connectionID.getServiceURL().getParameter(CONNECT_TIMEOUT_KEY, <span class="number">4000</span>);</span><br><span class="line">      <span class="keyword">if</span> (connectTimeout &lt; <span class="number">1000</span>) &#123;</span><br><span class="line">          connectTimeout = <span class="number">4000</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      bootstrap.option(ChannelOption.CONNECT_TIMEOUT_MILLIS, connectTimeout);</span><br><span class="line">   </span><br><span class="line">      <span class="keyword">if</span> (isWaterMarkEnabled()) &#123;</span><br><span class="line">          bootstrap.option(ChannelOption.WRITE_BUFFER_WATER_MARK,</span><br><span class="line">                  <span class="keyword">new</span> <span class="title class_">WriteBufferWaterMark</span>(getLowWaterMark(), getHighWaterMark()));</span><br><span class="line">      &#125;</span><br><span class="line">   </span><br><span class="line">      <span class="comment">// 从connectionID中获取服务端IP和端口进行连接</span></span><br><span class="line">      <span class="type">String</span> <span class="variable">targetIP</span> <span class="operator">=</span> connectionID.getServiceURL().getHost();</span><br><span class="line">      <span class="type">int</span> <span class="variable">targetPort</span> <span class="operator">=</span> connectionID.getServiceURL().getPort();</span><br><span class="line">      <span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> bootstrap.connect(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(targetIP, targetPort));</span><br><span class="line">      <span class="comment">// 阻塞等待</span></span><br><span class="line">      future.awaitUninterruptibly();</span><br><span class="line">   </span><br><span class="line">      <span class="comment">// 判断连接结果</span></span><br><span class="line">      <span class="type">ClientStream</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">if</span> (future.isSuccess()) &#123;</span><br><span class="line">          <span class="comment">// 如果Channel上没有绑定一个ClientStream，则进行绑定</span></span><br><span class="line">          <span class="keyword">if</span> (StreamUtils.streamOfChannel(future.channel()) == <span class="literal">null</span>) &#123;</span><br><span class="line">              <span class="type">NettyClientStream</span> <span class="variable">clientStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyClientStream</span>(connectionID, future.channel());</span><br><span class="line">              clientStream.setClient(<span class="built_in">this</span>);</span><br><span class="line">              StreamUtils.bindChannel(future.channel(), clientStream);</span><br><span class="line">          &#125;</span><br><span class="line">          result = (ClientStream) StreamUtils.streamOfChannel(future.channel());</span><br><span class="line">      &#125;</span><br><span class="line">   </span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">   </span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<h3 id="9-3-2-连接缓存"><a href="#9-3-2-连接缓存" class="headerlink" title="9.3.2 连接缓存"></a>9.3.2 连接缓存</h3><p><code>AbstractClient</code>中使用了一个<code>ConcurrentHashMap</code>保存连接，建立完成的连接放到Map中缓存。</p>
<p>如果从Map中获取不到连接，需要新建连接时，采用双重检查锁形式新建（参考<code>getClientStream（）</code>），因此提供一组并行加载锁<code>parallelLockMap</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ConnectionId到Stream</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;ConnectionID, ClientStream&gt; streams = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;ConnectionID, ClientStream&gt;();</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ConnectionId并行加载锁</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;ConnectionID, Object&gt; parallelLockMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;ConnectionID, Object&gt;();</span><br></pre></td></tr></table></figure>

<h3 id="9-3-3-连通性检测"><a href="#9-3-3-连通性检测" class="headerlink" title="9.3.3 连通性检测"></a>9.3.3 连通性检测</h3><p>由<code>com.taobao.hsf.cluster.ConnectivityRouter#validTarget</code>完成检测，检测时会尝试建立连接。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">validTarget</span><span class="params">(ServiceURL serviceURL)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// validate通过时，ClientStream已经创建完成，连接建立</span></span><br><span class="line">        <span class="type">ClientStream</span> <span class="variable">clientStream</span> <span class="operator">=</span> client.validate(serviceURL);</span><br><span class="line">        <span class="keyword">if</span> (clientStream != <span class="literal">null</span> &amp;&amp; !clientStream.isActive()) &#123;</span><br><span class="line">            LoggerInit.LOGGER.warn(<span class="string">&quot;HSF&quot;</span>, <span class="string">&quot;The channel is invalid: &quot;</span> + clientStream);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> clientStream != <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="9-3-4-最终调用"><a href="#9-3-4-最终调用" class="headerlink" title="9.3.4 最终调用"></a>9.3.4 最终调用</h3><p>一个RPC请求经历一系列<code>InvocationHandler</code>和<code>ClientFilter</code>，最终来到<code>com.taobao.hsf.remoting.service.RemotingRPCProtocolComponent#invokeForOne</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ListenableFuture&lt;RPCResult&gt; <span class="title function_">invokeForOne</span><span class="params">(ConsumerMethodModel consumerMethodModel, Invocation invocation,</span></span><br><span class="line"><span class="params">                                                 ServiceURL remotingURL)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">timeout</span> <span class="operator">=</span> <span class="built_in">this</span>.getReadTimeout(invocation.getHsfRequest(), consumerMethodModel, remotingURL);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 获取ClientStream，如果没有建立过连接，会新建连接</span></span><br><span class="line">        <span class="type">ClientStream</span> <span class="variable">clientStream</span> <span class="operator">=</span> client.of(remotingURL);</span><br><span class="line">        <span class="keyword">if</span> (clientStream == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">HSFException</span>(<span class="string">&quot;Target server [&quot;</span> + remotingURL + <span class="string">&quot;] has become unreachable.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//used by sync invoke</span></span><br><span class="line">        invocation.getInvokerContext().setTimeout(timeout);</span><br><span class="line">        invocation.getInvokerContext().setSerializeType(</span><br><span class="line">                serializeType(consumerMethodModel.getMetadata(), remotingURL, clientStream));</span><br><span class="line">        invocation.getInvokerContext().setProtocolType(remotingURL.getProtocolType());</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 写请求给服务端，返回一个异步结果ListenableFuture&lt;RPCResult&gt;</span></span><br><span class="line">        <span class="keyword">return</span> clientStream.write(invocation);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">HSFException</span>(<span class="string">&quot;error on submit request on future invoke:&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="9-3-5-I-x2F-O处理"><a href="#9-3-5-I-x2F-O处理" class="headerlink" title="9.3.5 I&#x2F;O处理"></a>9.3.5 I&#x2F;O处理</h3><p>机制上与服务端类似，客户端使用<code>com.taobao.hsf.io.netty.client.NettyClientStreamHandler</code>处理Netty事件驱动回调的I&#x2F;O方法。</p>
<p>一次写请求的流程：</p>
<ol>
<li><p>由<code>com.taobao.hsf.io.stream.ClientStream#write</code>发起写操作</p>
</li>
<li><p>将请求封装成<code>com.taobao.hsf.io.stream.StreamWriteRequest</code></p>
</li>
<li><p>使用<code>com.taobao.hsf.io.stream.AbstractClientStream#send</code>异步发送请求，触发Netty的<code>channel.writeAndFlush</code></p>
</li>
<li><p>触发<code>com.taobao.hsf.io.netty.client.NettyClientStreamHandler#write</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置响应Handler     </span></span><br><span class="line">requestPacket.setMessageAnswerHandler(streamWriteRequest.getMessageAnswerHandler());</span><br><span class="line"><span class="comment">// 回调监听器</span></span><br><span class="line">callConnectWriteListeners(client, stream, requestPacket);</span><br><span class="line"><span class="comment">// 注册写操作结果的回调</span></span><br><span class="line">promise.addListener(<span class="keyword">new</span> <span class="title class_">ChannelFutureListener</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (future.isSuccess()) &#123;</span><br><span class="line">            callConnectionWriteSuccessListeners(client, stream, requestPacket);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            callConnectionWriteFailedListeners(client, stream, requestPacket, future.cause());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 传递写操作</span></span><br><span class="line">ctx.write(requestPacket, promise);</span><br></pre></td></tr></table></figure>
</li>
<li><p>写成功或失败时回调监听器<code>com.taobao.hsf.io.stream.support.client.SendRequest</code>对应方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeFailed</span><span class="params">(Client client, ClientStream stream, RequestPacket message, Throwable cause)</span> &#123;</span><br><span class="line">    <span class="type">MessageAnswerHandler</span> <span class="variable">answerHandler</span> <span class="operator">=</span> stream.removeAnswerHandler(message.requestId());</span><br><span class="line">    <span class="keyword">if</span> (answerHandler != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">RPCResult</span> <span class="variable">rpcResult</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RPCResult</span>();</span><br><span class="line">        <span class="type">HSFResponse</span> <span class="variable">hsfResponse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HSFResponse</span>();</span><br><span class="line">        hsfResponse.setAppResponse(cause);</span><br><span class="line">        rpcResult.setHsfResponse(hsfResponse);</span><br><span class="line">        rpcResult.setClientErrorMsg(RemotingConstants.USELESS_OF_WRITE_ERROR + stream.remoteIp());</span><br><span class="line">        rpcResult.setStatus(ResponseStatus.CLIENT_WRITE_ERROR.getCode());</span><br><span class="line">        answerHandler.setAnswer(<span class="keyword">new</span> <span class="title class_">RpcResultResponsePacketWrapper</span>(rpcResult));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//the channel is auto closed when write failed and inactive will be invoked</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeSuccess</span><span class="params">(Client client, ClientStream stream, <span class="keyword">final</span> RequestPacket message)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (message.messageType() == MessageType.HeartBeatRequest) &#123;</span><br><span class="line">        stream.addContinuousHbTimes();</span><br><span class="line">        <span class="keyword">if</span> (client.getMaxConnIdleTime() &gt; <span class="number">0</span> &amp;&amp; stream.getContinuousHbTimes() * client.getHbSentInterval() &gt; client.getMaxConnIdleTime()) &#123;</span><br><span class="line">            stream.close();</span><br><span class="line">            log.warn(<span class="string">&quot;client is closed because it&#x27;s idle for &quot;</span> + client.getMaxConnIdleTime() + <span class="string">&quot;s&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        stream.clearContinuousHbTimes();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>收到响应，由<code>com.taobao.hsf.io.netty.client.NettyClientStreamHandler#channelRead</code>回调<code>com.taobao.hsf.io.stream.support.client.ReceiveResponse</code>处理响应</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">received</span><span class="params">(Client client, ClientStream stream, ResponsePacket message)</span> &#123;</span><br><span class="line">    <span class="comment">// 在write时会将MessageAnswerHandler绑定到stream上，收到响应时取出进行处理</span></span><br><span class="line">    <span class="type">MessageAnswerHandler</span> <span class="variable">answerHandler</span> <span class="operator">=</span> stream.removeAnswerHandler(message.requestId());</span><br><span class="line">    <span class="keyword">if</span> (answerHandler != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 设置响应</span></span><br><span class="line">        <span class="keyword">if</span> (answerHandler.getSerializePhase() == SerializePhase.IO) &#123;</span><br><span class="line">            <span class="type">RPCResult</span> <span class="variable">rpcResult</span> <span class="operator">=</span> answerHandler.call(message);</span><br><span class="line">            answerHandler.setAnswer(<span class="keyword">new</span> <span class="title class_">RpcResultResponsePacketWrapper</span>(rpcResult));</span><br><span class="line">            <span class="keyword">if</span> (rpcResult.getHsfResponse().getStatus() == ResponseStatus.CLIENT_DESERIALIZE_ERROR) &#123;</span><br><span class="line">                <span class="comment">//just failback to normal serialization</span></span><br><span class="line">                stream.attributeMap().put(STREAM_OPTIMIZED_HESSIAN_ENABLE_KEY, <span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            answerHandler.setAnswer(message);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//成功收到服务端的业务响应，清除心跳失败的计数</span></span><br><span class="line">        stream.clearContinuousHbFailedTimes();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        log.warn(<span class="string">&quot;Receive response which requestId has not been stored, maybe some problem happened on network.&quot;</span> + stream);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>

        </div>
          
        <div class="top-div">
          <ol class="top-box"><li class="top-box-item top-box-level-1"><a class="top-box-link" href="#%E5%89%8D%E8%A8%80"><span class="top-box-text">前言</span></a></li><li class="top-box-item top-box-level-1"><a class="top-box-link" href="#1-%E9%85%8D%E7%BD%AE%E9%A2%86%E5%9F%9F"><span class="top-box-text">1 配置领域</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#1-1-%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F"><span class="top-box-text">1.1 配置方式</span></a></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#1-2-%E4%BB%A3%E7%A0%81%E6%B5%81%E7%A8%8B"><span class="top-box-text">1.2 代码流程</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#1-2-1-APIBean%E9%85%8D%E7%BD%AE"><span class="top-box-text">1.2.1 APIBean配置</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#1-2-2-ServiceMetaData%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="top-box-text">1.2.2 ServiceMetaData初始化</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#1-2-3-%E5%85%B6%E4%BB%96"><span class="top-box-text">1.2.3 其他</span></a></li></ol></li></ol></li><li class="top-box-item top-box-level-1"><a class="top-box-link" href="#2-%E6%9C%8D%E5%8A%A1%E9%A2%86%E5%9F%9F1-%E8%B0%83%E7%94%A8%E5%B1%82"><span class="top-box-text">2 服务领域1 - 调用层</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#2-1-%E8%B0%83%E7%94%A8%E5%B1%82%E8%AE%BE%E8%AE%A1"><span class="top-box-text">2.1 调用层设计</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#2-1-1-%E8%AE%BE%E8%AE%A1%E7%90%86%E5%BF%B5"><span class="top-box-text">2.1.1 设计理念</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#2-1-2-%E4%B8%BB%E8%A6%81%E7%B1%BB"><span class="top-box-text">2.1.2 主要类</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#2-2-%E6%89%A9%E5%B1%95%E6%9C%BA%E5%88%B6"><span class="top-box-text">2.2 扩展机制</span></a></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#2-3-%E4%BB%A3%E7%A0%81%E6%B5%81%E7%A8%8B"><span class="top-box-text">2.3 代码流程</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#2-3-1-%E8%B0%83%E7%94%A8%E9%93%BE%E6%8B%BC%E6%8E%A5"><span class="top-box-text">2.3.1 调用链拼接</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#2-3-2-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B0%83%E7%94%A8"><span class="top-box-text">2.3.2 客户端调用</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#2-3-3-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%B0%83%E7%94%A8"><span class="top-box-text">2.3.3 服务端调用</span></a></li></ol></li></ol></li><li class="top-box-item top-box-level-1"><a class="top-box-link" href="#3-%E6%9C%8D%E5%8A%A1%E9%A2%86%E5%9F%9F2-%E8%B7%AF%E7%94%B1"><span class="top-box-text">3 服务领域2 - 路由</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#3-1-%E8%AE%BE%E8%AE%A1"><span class="top-box-text">3.1 设计</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#3-1-1-%E8%AE%BE%E8%AE%A1%E6%A1%86%E6%9E%B6"><span class="top-box-text">3.1.1 设计框架</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#3-1-2-%E4%B8%BB%E8%A6%81%E7%B1%BB"><span class="top-box-text">3.1.2 主要类</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#3-2-%E4%BB%A3%E7%A0%81%E6%B5%81%E7%A8%8B"><span class="top-box-text">3.2 代码流程</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#3-2-1-%E8%B7%AF%E7%94%B1%E9%93%BE%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="top-box-text">3.2.1 路由链初始化</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#3-2-2-%E5%9C%B0%E5%9D%80%E5%88%87%E5%88%86"><span class="top-box-text">3.2.2 地址切分</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#3-2-3-%E5%9C%B0%E5%9D%80%E9%80%89%E6%8B%A9"><span class="top-box-text">3.2.3 地址选择</span></a></li></ol></li></ol></li><li class="top-box-item top-box-level-1"><a class="top-box-link" href="#4-%E6%9C%8D%E5%8A%A1%E9%A2%86%E5%9F%9F3-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="top-box-text">4 服务领域3 - 负载均衡</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#4-1-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E8%AE%BE%E8%AE%A1%E5%92%8C%E5%AE%9A%E4%B9%89"><span class="top-box-text">4.1 负载均衡的设计和定义</span></a></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#4-2-%E4%BB%A3%E7%A0%81%E6%B5%81%E7%A8%8B"><span class="top-box-text">4.2 代码流程</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#4-2-1-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="top-box-text">4.2.1 初始化</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#4-2-2-%E5%AE%9E%E7%8E%B0%E7%B1%BB"><span class="top-box-text">4.2.2 实现类</span></a></li></ol></li></ol></li><li class="top-box-item top-box-level-1"><a class="top-box-link" href="#5-%E5%BA%94%E7%94%A8%E9%A2%86%E5%9F%9F1-Registry"><span class="top-box-text">5 应用领域1 - Registry</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#5-1-%E6%8E%A5%E5%8F%A3%E5%92%8C%E8%83%BD%E5%8A%9B"><span class="top-box-text">5.1 接口和能力</span></a></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#5-2-%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83"><span class="top-box-text">5.2 服务发布</span></a></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#5-3-%E6%9C%8D%E5%8A%A1%E8%AE%A2%E9%98%85"><span class="top-box-text">5.3 服务订阅</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#5-3-1-%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B"><span class="top-box-text">5.3.1 基本流程</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#5-3-2-%E5%9C%B0%E5%9D%80%E7%9B%91%E5%90%AC%E5%99%A8"><span class="top-box-text">5.3.2 地址监听器</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#5-4-%E6%80%BB%E7%BB%93"><span class="top-box-text">5.4 总结</span></a></li></ol></li><li class="top-box-item top-box-level-1"><a class="top-box-link" href="#6-%E5%BA%94%E7%94%A8%E9%A2%86%E5%9F%9F2-Protocol"><span class="top-box-text">6 应用领域2 - Protocol</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#6-1-%E6%8E%A5%E5%8F%A3%E5%92%8C%E8%83%BD%E5%8A%9B"><span class="top-box-text">6.1 接口和能力</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#6-1-1-Protocol"><span class="top-box-text">6.1.1 Protocol</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#6-1-2-ProtocolInterceptor"><span class="top-box-text">6.1.2 ProtocolInterceptor</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#6-2-%E4%BB%A3%E7%A0%81%E6%B5%81%E7%A8%8B"><span class="top-box-text">6.2 代码流程</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#6-2-1-%E6%9E%84%E9%80%A0ProtocolInterceptor%E9%93%BE"><span class="top-box-text">6.2.1 构造ProtocolInterceptor链</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#6-2-2-%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83"><span class="top-box-text">6.2.2 服务发布</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#6-2-3-%E6%9C%8D%E5%8A%A1%E8%AE%A2%E9%98%85"><span class="top-box-text">6.2.3 服务订阅</span></a></li></ol></li></ol></li><li class="top-box-item top-box-level-1"><a class="top-box-link" href="#7-%E6%A1%86%E6%9E%B6%E9%A2%86%E5%9F%9F1-%E6%80%BB%E4%BD%93%E8%AE%BE%E8%AE%A1"><span class="top-box-text">7 框架领域1 - 总体设计</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#7-1-%E5%B1%82%E6%AC%A1"><span class="top-box-text">7.1 层次</span></a></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#7-2-%E5%86%85%E9%83%A8%E7%BB%93%E6%9E%84"><span class="top-box-text">7.2 内部结构</span></a></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#7-3-%E6%89%A9%E5%B1%95%E7%82%B9"><span class="top-box-text">7.3 扩展点</span></a></li></ol></li><li class="top-box-item top-box-level-1"><a class="top-box-link" href="#8-%E6%A1%86%E6%9E%B6%E9%A2%86%E5%9F%9F2-%E7%BC%96%E8%A7%A3%E7%A0%81"><span class="top-box-text">8 框架领域2 - 编解码</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#8-1-%E7%BC%96%E8%A7%A3%E7%A0%81%E7%9A%84%E6%8A%BD%E8%B1%A1"><span class="top-box-text">8.1 编解码的抽象</span></a></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#8-2-%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="top-box-text">8.2 服务端</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#8-2-1-%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82"><span class="top-box-text">8.2.1 处理请求</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#8-2-2-%E5%8F%91%E9%80%81%E5%93%8D%E5%BA%94"><span class="top-box-text">8.2.2 发送响应</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#8-3-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="top-box-text">8.3 客户端</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#8-3-1-%E5%8F%91%E9%80%81%E8%AF%B7%E6%B1%82"><span class="top-box-text">8.3.1 发送请求</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#8-3-2-%E6%8E%A5%E6%94%B6%E5%93%8D%E5%BA%94"><span class="top-box-text">8.3.2 接收响应</span></a></li></ol></li></ol></li><li class="top-box-item top-box-level-1"><a class="top-box-link" href="#9-%E6%A1%86%E6%9E%B6%E9%A2%86%E5%9F%9F3-%E7%BD%91%E7%BB%9C%E5%B1%82"><span class="top-box-text">9 框架领域3-网络层</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#9-1-%E8%AE%BE%E8%AE%A1%E7%90%86%E5%BF%B5"><span class="top-box-text">9.1 设计理念</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#9-1-1-%E7%BD%91%E7%BB%9C%E6%8A%BD%E8%B1%A1"><span class="top-box-text">9.1.1 网络抽象</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#9-1-2-%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC"><span class="top-box-text">9.1.2 事件监听</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#9-2-Server"><span class="top-box-text">9.2 Server</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#9-2-1-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BE%A6%E5%90%AC"><span class="top-box-text">9.2.1 启动服务端侦听</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#9-2-2-%E8%BF%9E%E6%8E%A5%E5%A4%84%E7%90%86"><span class="top-box-text">9.2.2 连接处理</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#9-3-Client"><span class="top-box-text">9.3 Client</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#9-3-1-%E5%BB%BA%E7%AB%8B%E5%92%8C%E8%8E%B7%E5%8F%96%E8%BF%9E%E6%8E%A5"><span class="top-box-text">9.3.1 建立和获取连接</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#9-3-2-%E8%BF%9E%E6%8E%A5%E7%BC%93%E5%AD%98"><span class="top-box-text">9.3.2 连接缓存</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#9-3-3-%E8%BF%9E%E9%80%9A%E6%80%A7%E6%A3%80%E6%B5%8B"><span class="top-box-text">9.3.3 连通性检测</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#9-3-4-%E6%9C%80%E7%BB%88%E8%B0%83%E7%94%A8"><span class="top-box-text">9.3.4 最终调用</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#9-3-5-I-x2F-O%E5%A4%84%E7%90%86"><span class="top-box-text">9.3.5 I&#x2F;O处理</span></a></li></ol></li></ol></li></ol>
        </div>
          
      </div>
    </div>

    
  </div>










<footer>
<div class="site-footer">
  <div class="social-container">
    
      
        <a aria-label="跳转至github" href="https://github.com/f-dong" target="_blank">
          <i class="icon icon-github"></i>
        </a>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  </div>
  
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <a href="https://github.com/f-dong/hexo-theme-minimalism" target="_blank">Theme</a>
  
  
  
  
  
  
</div>
</footer>


      </div>
    </div>
    
<script id="hexo-configurations"> window.theme_config = {"image":{"lazyload_enable":true,"photo_zoom":"simple-lightbox"}}; window.is_post = true; </script>

<script src="/js/main.js"></script>






  <script src="/js/simple-lightbox.min.js"></script><script>document.addEventListener('DOMContentLoaded', function() {new SimpleLightbox('.post-detail .simple-lightbox', {fileExt: false,captionsData:'alt'});});</script></body>
</html>

