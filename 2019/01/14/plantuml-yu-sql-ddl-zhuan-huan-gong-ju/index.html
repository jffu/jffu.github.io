<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    

    
<script>!function(){var e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("use-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script>
    

<meta charset="utf-8" >

<title>PlantUML与SQL DDL转换工具</title>
<meta name="keywords" content="PlantUML与SQL DDL转换工具, jffu&#39;s blog">
<meta name="description" content="将PlantUML跟SQL DDL一键转换">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta property="og:title" content="PlantUML与SQL DDL转换工具">
<meta property="og:description" content="将PlantUML跟SQL DDL一键转换">

<link rel="shortcut icon" href="/favicon.ico">
<link rel="stylesheet" href="/style/main.css">

  <link rel="stylesheet" href="/style/simple-lightbox.min.css"><meta name="generator" content="Hexo 6.3.0"></head>
  <body>
    <div id="app" class="main">

<div class="site-header-container">
  <div class="site-header">
    <div class="left">
      <a href="https://jffu.github.io">
        <img class="avatar" src="/images/avatar.jpeg" alt="logo" width="32px" height="32px">
      </a>
      <a href="https://jffu.github.io">
        <h1 class="site-title">jffu&#39;s blog</h1>
      </a>
    </div>
    <div class="right">
        <i class="icon menu-switch icon-menu-outline" ></i>
    </div>
  </div>
</div>

<div class="menu-container" style="height: 0;opacity: 0;">
<nav class="menu-list">
  
    
      <a href="/" class="menu purple-link">
        首页
      </a>
    
  
    
      <a href="/tags" class="menu purple-link">
        标签
      </a>
    
  
    
      <a href="/archives" class="menu purple-link">
        归档
      </a>
    
  
    
      <a href="/about" class="menu purple-link">
        关于
      </a>
    
  
</nav>
</div>



  <div class="content-container">
    <div class="post-detail">
      
      <h2 class="post-title">PlantUML与SQL DDL转换工具</h2>
      <div class="post-info post-detail-info">
        <span><i class="icon icon-calendar-outline"></i> 2019-01-14</span>
        
          <span>
          <i class="icon icon-pricetags-outline"></i>
            
              <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">
              数据库
                
              </a>
            
          </span>
        
      </div>
      <div class="post-content-wrapper">
        <div class="post-content">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>工具的初衷：</p>
<ul>
<li>开发设计时经常会用到PlantUML之类的工具画ER图，然后在iDB上手动建表，效率很慢。如果能通过ER图导出MySQL DDL，就可以直接通过iDB的“导入建表语句”功能建表；</li>
<li>逆向流程，需要从已有的表里生成ER图，也是个头疼耗时的事情；</li>
</ul>
<hr>
<h1 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h1><ol>
<li><p>将PlantUML文件转换为对应的SQL DDL建表语句</p>
</li>
<li><p>通过TDDL_APP名生成MySQL DDL语句</p>
<blockquote>
<ol>
<li>TDDL_APP名即应用运行时配置的<code>spring.tddl.app</code>属性值，例如<code>RHINO_BIZ_STYLECENTER_APP</code></li>
<li>影子表会被自动忽略</li>
</ol>
</blockquote>
</li>
<li><p>通过TDDL_APP名生成PlantUML ER图文件</p>
<blockquote>
<p>输出后可以直接在语雀之类的文档上粘贴，显示为ER图</p>
</blockquote>
</li>
<li><p>通过PlantUML文件生成PNG格式图片的ER图</p>
</li>
</ol>
<h1 id="使用说明"><a href="#使用说明" class="headerlink" title="使用说明"></a>使用说明</h1><p>工具依赖于Python环境，建议使用Python3（某些功能依赖于Python3的特性和lib）。</p>
<p><code>tool.sh</code>说明：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Usage:</span><br><span class="line">  -h, --<span class="built_in">help</span>:                            <span class="built_in">print</span> usage</span><br><span class="line">  -d, --ddl=TDDL_APP_NAME:               convert MySQL ddl to PlantUML, input tddl app name</span><br><span class="line">  -p, --puml=PLANTUML_FILE:              convert PlantUML file to MySQL ddl</span><br><span class="line">  -o, --output=OUTPUT_FILE:              <span class="built_in">set</span> output file, <span class="keyword">if</span> not specified, console is <span class="built_in">set</span> as output</span><br><span class="line">  --dump=TDDL_APP_NAME:                  dump MySQL ddl from tddl daily <span class="built_in">env</span>, input tddl app name</span><br><span class="line">  --png=PLANTUML_FILE/TDDL_APP_NAME:     convert PlantUML file to PNG picture</span><br></pre></td></tr></table></figure>

<h1 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h1><h2 id="将PlantUML的ER图文件转换为DDL"><a href="#将PlantUML的ER图文件转换为DDL" class="headerlink" title="将PlantUML的ER图文件转换为DDL"></a>将PlantUML的ER图文件转换为DDL</h2><p>ER图：<br><a class="simple-lightbox" target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/jffu/jffu-blog-images@main/img/FsQkAtL0QjToEVvWIhAHIfhh30Hc.png"><img   src="/images/loading.svg" data-src="https://cdn.jsdelivr.net/gh/jffu/jffu-blog-images@main/img/FsQkAtL0QjToEVvWIhAHIfhh30Hc.png"  lazyload></a></p>
<p>UML文件内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">&#x27; 如果非视网膜屏，可以注释掉这一行</span><br><span class="line">skinparam dpi 300</span><br><span class="line">&#x27; 定义表关键字，包括了表名和描述</span><br><span class="line">!define Table(name,desc) class name as &quot;desc&quot; &lt;&lt; (T,#FFAAAA) &gt;&gt;</span><br><span class="line">&#x27; 约束定义：</span><br><span class="line">&#x27; 使用加粗作为主键</span><br><span class="line">!define primary_key(x) &lt;b&gt;x&lt;/b&gt;</span><br><span class="line">&#x27; 使用绿色作为unique</span><br><span class="line">!define unique &lt;color:green&gt;unique&lt;/color&gt;</span><br><span class="line">&#x27; 使用斜体作为索引</span><br><span class="line">!define index(x) //x//</span><br><span class="line">&#x27; 使用下划线表示不能为null</span><br><span class="line">!define not_null(x) &lt;u&gt;x&lt;/u&gt;</span><br><span class="line">&#x27; 默认值，红色表示</span><br><span class="line">!define default(x) &lt;color:red&gt;x&lt;/color&gt;</span><br><span class="line">&#x27; 字段类型定义，灰色表示</span><br><span class="line">!define bit &lt;color:gray&gt;bit&lt;/color&gt;</span><br><span class="line">!define tinyint &lt;color:gray&gt;tinyint&lt;/color&gt;</span><br><span class="line">!define smallint &lt;color:gray&gt;smallint&lt;/color&gt;</span><br><span class="line">!define mediumint &lt;color:gray&gt;mediumint&lt;/color&gt;</span><br><span class="line">!define int &lt;color:gray&gt;int&lt;/color&gt;</span><br><span class="line">!define bigint &lt;color:gray&gt;bigint&lt;/color&gt;</span><br><span class="line">!define unsigned &lt;color:gray&gt;unsigned&lt;/color&gt;</span><br><span class="line">!define decimal &lt;color:gray&gt;decimal&lt;/color&gt;</span><br><span class="line">!define date &lt;color:gray&gt;date&lt;/color&gt;</span><br><span class="line">!define datetime &lt;color:gray&gt;datetime&lt;/color&gt;</span><br><span class="line">!define timestamp &lt;color:gray&gt;timestamp&lt;/color&gt;</span><br><span class="line">!define blob &lt;color:gray&gt;blob&lt;/color&gt;</span><br><span class="line">!define text &lt;color:gray&gt;text&lt;/color&gt;</span><br><span class="line">!define varchar(x) &lt;color:gray&gt;varchar[x]&lt;/color&gt;</span><br><span class="line">&#x27; 注释，斜体表示</span><br><span class="line">!define comment(x) //x//</span><br><span class="line">hide methods</span><br><span class="line">hide stereotypes</span><br><span class="line"></span><br><span class="line">Table(user, &quot;user\n(用户)&quot;) &#123;</span><br><span class="line">    primary_key(id) int</span><br><span class="line">    not_null(username) varchar(32) comment(用户名)</span><br><span class="line">    not_null(password) varchar(64) comment(用户密码)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Table(session, &quot;session\n(session for user)&quot;) &#123;</span><br><span class="line">    primary_key(id) int</span><br><span class="line">    not_null(user_id) int comment(用户id)</span><br><span class="line">    not_null(session_id) varchar(64) comment(&quot;session id&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Table(user_profile, &quot;user_profile\n(用户信息)&quot;) &#123;</span><br><span class="line">    primary_key(user_id) int</span><br><span class="line">    age smallint comment(年龄)</span><br><span class="line">    gender smallint comment(性别)</span><br><span class="line">    birthday datetime comment(生日)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Table(group, &quot;group\n(用户组)&quot;) &#123;</span><br><span class="line">primary_key(id) int</span><br><span class="line">not_null(name) varchar(32) comment(组名)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Table(user_group, &quot;user_group\n(用户组关系表)&quot;) &#123;</span><br><span class="line">    primary_key(user_id) int comment(用户id)</span><br><span class="line">    primary_key(group_id) int comment(用户组id)</span><br><span class="line">    joined_at datetime comment(加入时间)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x27; relationships</span><br><span class="line">&#x27; one-to-one relationship</span><br><span class="line">user -- user_profile : &quot;A user only \nhas one profile&quot;</span><br><span class="line">&#x27; one to may relationship</span><br><span class="line">user &quot;1&quot;--&gt;&quot;0..N&quot;  session : &quot;A user may have\n many sessions&quot;</span><br><span class="line">&#x27; many to many relationship</span><br><span class="line">&#x27; Add mark if you like</span><br><span class="line">user &quot;1&quot; --&gt; &quot;*&quot; user_group : &quot;A user may be \nin many groups&quot;</span><br><span class="line">group &quot;1&quot; --&gt; &quot;0..N&quot; user_group : &quot;A group may \ncontain many users&quot;</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p>1、 运行命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tool.sh -p sample/sample2.puml</span><br></pre></td></tr></table></figure>

<p>2、 输出结果</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `<span class="keyword">user</span>` (</span><br><span class="line">  `id` <span class="type">bigint</span> unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  `creator` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建者&#x27;</span>,</span><br><span class="line">  `modifier` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改者&#x27;</span>,</span><br><span class="line">  `is_deleted` tinyint <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;是否删除&#x27;</span>,</span><br><span class="line">  `primary_key(id)` <span class="type">int</span>,</span><br><span class="line">  `username` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">  `password` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户密码&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `session` (</span><br><span class="line">  `id` <span class="type">bigint</span> unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  `creator` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建者&#x27;</span>,</span><br><span class="line">  `modifier` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改者&#x27;</span>,</span><br><span class="line">  `is_deleted` tinyint <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;是否删除&#x27;</span>,</span><br><span class="line">  `primary_key(id)` <span class="type">int</span>,</span><br><span class="line">  `user_id` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户id&#x27;</span>,</span><br><span class="line">  `session_id` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;session id&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `user_profile` (</span><br><span class="line">  `id` <span class="type">bigint</span> unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  `creator` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建者&#x27;</span>,</span><br><span class="line">  `modifier` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改者&#x27;</span>,</span><br><span class="line">  `is_deleted` tinyint <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;是否删除&#x27;</span>,</span><br><span class="line">  `primary_key(user_id)` <span class="type">int</span>,</span><br><span class="line">  `age` <span class="type">smallint</span> COMMENT <span class="string">&#x27;年龄&#x27;</span>,</span><br><span class="line">  `gender` <span class="type">smallint</span> COMMENT <span class="string">&#x27;性别&#x27;</span>,</span><br><span class="line">  `birthday` datetime COMMENT <span class="string">&#x27;生日&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `<span class="keyword">group</span>` (</span><br><span class="line">  `id` <span class="type">bigint</span> unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  `creator` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建者&#x27;</span>,</span><br><span class="line">  `modifier` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改者&#x27;</span>,</span><br><span class="line">  `is_deleted` tinyint <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;是否删除&#x27;</span>,</span><br><span class="line">  `primary_key(id)` <span class="type">int</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;组名&#x27;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="通过TDDL-APP名生成PlantUML-ER图文件"><a href="#通过TDDL-APP名生成PlantUML-ER图文件" class="headerlink" title="通过TDDL_APP名生成PlantUML ER图文件"></a>通过TDDL_APP名生成PlantUML ER图文件</h2><p>1、 运行命令（使用<code>-o/—output</code>指定输出文件，不指定会输出到console）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./tool.sh -d TDDL_TEST_APP -o er.puml</span><br></pre></td></tr></table></figure>

<p>2、 查看<code>er.puml</code>，可以使用PlantUML工具（eg.语雀，idea插件）查看效果</p>
<h1 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h1><p><code>template</code>目录下保存了模板文件，可以通过修改模板的形式自定义输出。</p>
<h2 id="自定义PlantUML的ER图风格"><a href="#自定义PlantUML的ER图风格" class="headerlink" title="自定义PlantUML的ER图风格"></a>自定义PlantUML的ER图风格</h2><p>默认情况下，使用<code>template/puml.template</code>指定PlantUML的展示ER图的风格，可以通过修改这个文件来自定义ER图风格。</p>
<h2 id="自定义MySQL-DDL的默认字段"><a href="#自定义MySQL-DDL的默认字段" class="headerlink" title="自定义MySQL DDL的默认字段"></a>自定义MySQL DDL的默认字段</h2><p>团队的数据库规范会要求建表时带一些默认的字段，例如阿里集团规约中要求的<code>id</code>、<code>gmt_create</code>、<code>gmt_modified</code>，而在画ER图时并不想带上这些字段。可以通过修改<code>template/rhino_ddl_fields.template</code>来自定义默认添加的字段。默认情况下，文件的内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">`id` bigint(20) unsigned NOT NULL AUTO_INCREMENT BY GROUP COMMENT &#x27;主键&#x27;,</span><br><span class="line">`gmt_create` datetime NOT NULL COMMENT &#x27;创建时间&#x27;,</span><br><span class="line">`gmt_modified` datetime NOT NULL COMMENT &#x27;修改时间&#x27;,</span><br><span class="line">`creator` varchar(32) NOT NULL COMMENT &#x27;创建者&#x27;,</span><br><span class="line">`modifier` varchar(32) NOT NULL COMMENT &#x27;修改者&#x27;,</span><br><span class="line">`is_deleted` tinyint(4) NOT NULL COMMENT &#x27;是否删除&#x27;,</span><br></pre></td></tr></table></figure>

<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><h2 id="tool-sh"><a href="#tool-sh" class="headerlink" title="tool.sh"></a>tool.sh</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line">CUR_DIR=&quot;$( cd &quot;$( dirname &quot;$0&quot; )&quot; &amp;&amp; pwd )&quot;</span><br><span class="line"></span><br><span class="line">PY=python3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pre-check python <span class="built_in">env</span></span></span><br><span class="line">! which python3 &gt; /dev/null &amp;&amp; echo &quot;Error: no python3 env found, output may be malformed&quot; &amp;&amp; PY=python</span><br><span class="line"></span><br><span class="line">export PYTHONPATH=$CUR_DIR/lib:$PYTHONPATH</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">PY <span class="variable">$CUR_DIR</span>/main.py <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span></span><br></pre></td></tr></table></figure>



<h2 id="main-py"><a href="#main-py" class="headerlink" title="main.py"></a>main.py</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*-coding:utf-8-*-</span></span><br><span class="line"><span class="keyword">import</span> getopt</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> common</span><br><span class="line"><span class="keyword">import</span> db</span><br><span class="line"><span class="keyword">from</span> er <span class="keyword">import</span> ER, Table</span><br><span class="line"></span><br><span class="line">PLANTUML_JAR = <span class="string">&#x27;lib/plantuml.jar&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">usage</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Usage:&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;  -h, --help:                            print usage&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;  -d, --ddl=TDDL_APP_NAME:               convert MySQL ddl to PlantUML, input tddl app name&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;  -p, --puml=PLANTUML_FILE:              convert PlantUML file to MySQL ddl&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;  -o, --output=OUTPUT_FILE:              set output file, if not specified, console is set as output&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;  --dump=TDDL_APP_NAME:                  dump MySQL ddl from tddl daily env, input tddl app name&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;  --png=PLANTUML_FILE/TDDL_APP_NAME:     convert PlantUML file to PNG picture&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;  --fromsql=MYSQL_DDL_FILE:              convert MySQL ddl file to PlantUML file&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump_ddl_by_tddl_app</span>(<span class="params">tddl_app</span>):</span><br><span class="line">    mysql = db.Mysql(user=tddl_app, db=tddl_app)</span><br><span class="line">    ddl_dict = mysql.get_ddl_dict()</span><br><span class="line"></span><br><span class="line">    result = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> ddl <span class="keyword">in</span> ddl_dict.values():</span><br><span class="line">        <span class="keyword">if</span> ddl:</span><br><span class="line">            result += ddl + <span class="string">&#x27;\n\n&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_puml_by_tddl_app</span>(<span class="params">tddl_app</span>):</span><br><span class="line">    mysql = db.Mysql(user=tddl_app, db=tddl_app)</span><br><span class="line">    table_names = mysql.get_table_names()</span><br><span class="line"></span><br><span class="line">    er = ER()</span><br><span class="line">    <span class="keyword">for</span> table_name <span class="keyword">in</span> table_names:</span><br><span class="line">        <span class="comment"># 忽略影子表</span></span><br><span class="line">        <span class="keyword">if</span> table_name.startswith(<span class="string">&#x27;__test_&#x27;</span>):</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        create_table = mysql.get_create_table(table_name)</span><br><span class="line">        <span class="keyword">if</span> create_table:</span><br><span class="line">            lines = create_table.split(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">            table = Table.from_ddl(lines)</span><br><span class="line">            er.add_table(table)</span><br><span class="line">    puml = er.to_puml()</span><br><span class="line">    <span class="keyword">return</span> puml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">convert_to_ddl</span>(<span class="params">puml_file</span>):</span><br><span class="line">    lines = common.read_file_lines(puml_file)</span><br><span class="line">    er = ER.from_puml(lines)</span><br><span class="line">    <span class="keyword">return</span> er.to_ddl()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">convert_to_png</span>(<span class="params">puml_file, output_file</span>):</span><br><span class="line">    puml_file_name = os.path.basename(puml_file)</span><br><span class="line">    <span class="keyword">if</span> puml_file_name.endswith(<span class="string">&#x27;.puml&#x27;</span>):</span><br><span class="line">        default_output = puml_file_name[:puml_file_name.rfind(<span class="string">&#x27;.puml&#x27;</span>)] + <span class="string">&#x27;.png&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        default_output = puml_file_name</span><br><span class="line">    cmd = <span class="string">&#x27;java -jar %s -nbthread auto %s&#x27;</span> % (PLANTUML_JAR, puml_file)</span><br><span class="line">    common.run_cmd(cmd)</span><br><span class="line">    <span class="keyword">if</span> output_file:</span><br><span class="line">        common.run_cmd(<span class="string">&#x27;mv %s %s&#x27;</span> % ((os.path.join(os.path.dirname(puml_file), default_output)), output_file))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;%s generated&#x27;</span> % output_file)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;%s generated&#x27;</span> % default_output)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">convert_to_puml</span>(<span class="params">sql_ddl_file</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(sql_ddl_file) <span class="keyword">as</span> f:</span><br><span class="line">        lines = f.readlines()</span><br><span class="line"></span><br><span class="line">    er = ER()</span><br><span class="line">    start = <span class="number">0</span></span><br><span class="line">    end = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(lines)):</span><br><span class="line">        line = lines[n].strip()</span><br><span class="line">        <span class="keyword">if</span> line.startswith(<span class="string">&#x27;CREATE TABLE&#x27;</span>):</span><br><span class="line">            start = n</span><br><span class="line">        <span class="keyword">elif</span> line.endswith(<span class="string">&#x27;;&#x27;</span>):</span><br><span class="line">            end = n</span><br><span class="line">        <span class="keyword">if</span> end &gt; start:</span><br><span class="line">            table = Table.from_ddl(lines[start:end])</span><br><span class="line">            er.add_table(table)</span><br><span class="line">            start = end + <span class="number">1</span></span><br><span class="line">    puml = er.to_puml()</span><br><span class="line">    <span class="keyword">return</span> puml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">output</span>(<span class="params">data, file</span>):</span><br><span class="line">    <span class="keyword">if</span> file:</span><br><span class="line">        common.write_file(data, file)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) == <span class="number">1</span>:</span><br><span class="line">        usage()</span><br><span class="line">        sys.exit()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        opts, args = getopt.getopt(sys.argv[<span class="number">1</span>:], <span class="string">&#x27;hd:p:o:&#x27;</span>,</span><br><span class="line">                                   [<span class="string">&#x27;help&#x27;</span>, <span class="string">&#x27;ddl=&#x27;</span>, <span class="string">&#x27;puml=&#x27;</span>, <span class="string">&#x27;output=&#x27;</span>, <span class="string">&#x27;dump=&#x27;</span>, <span class="string">&#x27;png=&#x27;</span>, <span class="string">&#x27;fromsql=&#x27;</span>])</span><br><span class="line">    <span class="keyword">except</span> getopt.GetoptError <span class="keyword">as</span> err:</span><br><span class="line">        <span class="built_in">print</span>(err)</span><br><span class="line">        usage()</span><br><span class="line">        sys.exit(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    puml_file = <span class="literal">None</span></span><br><span class="line">    output_file = <span class="literal">None</span></span><br><span class="line">    tddl_app = <span class="literal">None</span></span><br><span class="line">    do_dump = <span class="literal">False</span></span><br><span class="line">    do_png = <span class="literal">False</span></span><br><span class="line">    sql_file = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> o, a <span class="keyword">in</span> opts:</span><br><span class="line">        <span class="keyword">if</span> o <span class="keyword">in</span> (<span class="string">&#x27;-h&#x27;</span>, <span class="string">&#x27;--help&#x27;</span>):</span><br><span class="line">            usage()</span><br><span class="line">            sys.exit()</span><br><span class="line">        <span class="keyword">elif</span> o <span class="keyword">in</span> (<span class="string">&#x27;-d&#x27;</span>, <span class="string">&#x27;--ddl&#x27;</span>):</span><br><span class="line">            tddl_app = a</span><br><span class="line">        <span class="keyword">elif</span> o <span class="keyword">in</span> (<span class="string">&#x27;-p&#x27;</span>, <span class="string">&#x27;--puml&#x27;</span>):</span><br><span class="line">            puml_file = a</span><br><span class="line">        <span class="keyword">elif</span> o <span class="keyword">in</span> (<span class="string">&#x27;-o&#x27;</span>, <span class="string">&#x27;--output&#x27;</span>):</span><br><span class="line">            output_file = a</span><br><span class="line">        <span class="keyword">elif</span> o <span class="keyword">in</span> (<span class="string">&#x27;--dump&#x27;</span>):</span><br><span class="line">            tddl_app = a</span><br><span class="line">            do_dump = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">elif</span> o <span class="keyword">in</span> (<span class="string">&#x27;--png&#x27;</span>):</span><br><span class="line">            do_png = <span class="literal">True</span></span><br><span class="line">            puml_file = a</span><br><span class="line">        <span class="keyword">elif</span> o <span class="keyword">in</span> (<span class="string">&#x27;--fromsql&#x27;</span>):</span><br><span class="line">            sql_file = a</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">assert</span> <span class="literal">False</span>, <span class="string">&#x27;unhandled option&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> puml_file:</span><br><span class="line">        <span class="keyword">if</span> do_png:</span><br><span class="line">            <span class="comment"># 转换plantuml文件为png格式</span></span><br><span class="line">            convert_to_png(puml_file, output_file)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 转换plantuml为ddl</span></span><br><span class="line">            ddl = convert_to_ddl(puml_file)</span><br><span class="line">            output(ddl, output_file)</span><br><span class="line">    <span class="keyword">if</span> tddl_app:</span><br><span class="line">        <span class="keyword">if</span> do_dump:</span><br><span class="line">            <span class="comment"># 从数据库dump出ddl语句</span></span><br><span class="line">            ddls = dump_ddl_by_tddl_app(tddl_app)</span><br><span class="line">            output(ddls, output_file)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 从数据库生成plantuml文件</span></span><br><span class="line">            puml = get_puml_by_tddl_app(tddl_app)</span><br><span class="line">            output(puml, output_file)</span><br><span class="line">    <span class="keyword">if</span> sql_file:</span><br><span class="line">        <span class="comment"># 从SQL DDL生成plantuml</span></span><br><span class="line">        puml = convert_to_puml(sql_file)</span><br><span class="line">        output(puml, output_file)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h2 id="er-py"><a href="#er-py" class="headerlink" title="er.py"></a>er.py</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*-coding:utf-8-*-</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> traceback</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> common</span><br><span class="line"></span><br><span class="line">PUML_TEMPLATE = <span class="string">&#x27;template/puml.template&#x27;</span></span><br><span class="line">RHINO_DDL_FIELDS_TEMPLATE = <span class="string">&#x27;template/rhino_ddl_fields.template&#x27;</span></span><br><span class="line">PUML_IGNORE_FIELDS_TEMPLATE = <span class="string">&quot;template/puml_ignore_fields.template&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ER</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, tables=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="keyword">if</span> tables <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            tables = []</span><br><span class="line">        self.tables = tables</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_table</span>(<span class="params">self, table</span>):</span><br><span class="line">        self.tables.append(table)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">to_ddl</span>(<span class="params">self</span>):</span><br><span class="line">        ddl = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">for</span> table <span class="keyword">in</span> self.tables:</span><br><span class="line">            ddl += table.to_ddl() + <span class="string">&#x27;\n\n&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> ddl</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">to_puml</span>(<span class="params">self</span>):</span><br><span class="line">        puml = common.read_file(PUML_TEMPLATE)</span><br><span class="line">        <span class="comment"># puml = puml.encode(&#x27;utf-8&#x27;)</span></span><br><span class="line">        <span class="keyword">for</span> table <span class="keyword">in</span> self.tables:</span><br><span class="line">            puml += <span class="string">&#x27;\n&#x27;</span> + table.to_puml()</span><br><span class="line">        puml += <span class="string">&#x27;\n@enduml&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> puml</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">from_puml</span>(<span class="params">lines</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            tables = _parse_puml(lines)</span><br><span class="line">            <span class="keyword">return</span> ER(tables)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Error: unknown error, please check file format&#x27;</span>)</span><br><span class="line">            traceback.print_exc()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Table</span>:</span><br><span class="line">    _RHINO_COLS = <span class="literal">None</span></span><br><span class="line">    _PUML_IGNORE_FIELD_SET = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name=<span class="string">&#x27;&#x27;</span>, comment=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.comment = comment</span><br><span class="line">        self.cols = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_col</span>(<span class="params">self, col</span>):</span><br><span class="line">        <span class="comment"># 不添加重复行</span></span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> self.cols:</span><br><span class="line">            <span class="keyword">if</span> c.name == col.name:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">        self.cols.append(col)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">to_ddl</span>(<span class="params">self</span>):</span><br><span class="line">        ddl = <span class="string">&#x27;CREATE TABLE `%s` (\n&#x27;</span> % self.name</span><br><span class="line">        ddl += common.read_file(RHINO_DDL_FIELDS_TEMPLATE)</span><br><span class="line">        ddl += <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">        col_set = <span class="built_in">set</span>()</span><br><span class="line">        <span class="keyword">for</span> col <span class="keyword">in</span> self.cols:</span><br><span class="line">            <span class="keyword">if</span> col.name <span class="keyword">in</span> col_set:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            col_set.add(col.name)</span><br><span class="line">            ddl += <span class="string">&#x27;  %s,\n&#x27;</span> % col.to_ddl()</span><br><span class="line">        ddl += <span class="string">&#x27;  PRIMARY KEY (`id`)\n&#x27;</span></span><br><span class="line">        ddl += <span class="string">&#x27;) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=\&#x27;%s\&#x27;\n&#x27;</span> % self.comment</span><br><span class="line">        <span class="comment"># ddl = ddl[0:-2] + &#x27;\n)&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> ddl</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">to_puml</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Table(table1, &quot;table_1\n(This is table 1)&quot;) &#123;</span></span><br><span class="line">        puml = <span class="string">&#x27;Table(%s, &quot;%s\\n(%s)&quot;) &#123;\n&#x27;</span> % (self.name, self.name, self.comment)</span><br><span class="line">        <span class="keyword">for</span> col <span class="keyword">in</span> self.cols:</span><br><span class="line">            <span class="keyword">if</span> col.name <span class="keyword">not</span> <span class="keyword">in</span> Table.puml_ignore_filed_set():</span><br><span class="line">                puml += <span class="string">&#x27;    &#x27;</span> + col.to_puml() + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">        puml += <span class="string">&#x27;&#125;\n&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> puml</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">puml_ignore_filed_set</span>(<span class="params">cls</span>):</span><br><span class="line">        <span class="keyword">if</span> cls._PUML_IGNORE_FIELD_SET <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            cls._PUML_IGNORE_FIELD_SET = <span class="built_in">set</span>()</span><br><span class="line">            lines = common.read_file_lines(PUML_IGNORE_FIELDS_TEMPLATE)</span><br><span class="line">            <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">                line = line.strip()</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(line) &gt; <span class="number">0</span>:</span><br><span class="line">                    cls._PUML_IGNORE_FIELD_SET.add(line)</span><br><span class="line">        <span class="keyword">return</span> cls._PUML_IGNORE_FIELD_SET</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">from_ddl</span>(<span class="params">lines</span>):</span><br><span class="line">        table_flag = <span class="literal">False</span></span><br><span class="line">        table = Table()</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">            line = line.strip()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> table_flag <span class="keyword">and</span> line.startswith(<span class="string">&#x27;CREATE TABLE&#x27;</span>):</span><br><span class="line">                table_name = _get_token_value(line)</span><br><span class="line">                table.name = table_name</span><br><span class="line">                table_flag = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">elif</span> table_flag:</span><br><span class="line">                <span class="keyword">if</span> line.startswith(<span class="string">&#x27;`&#x27;</span>):</span><br><span class="line">                    col = Column.from_ddl(line)</span><br><span class="line">                    table.add_col(col)</span><br><span class="line">                <span class="keyword">elif</span> line.startswith(<span class="string">&#x27;)&#x27;</span>):</span><br><span class="line">                    table_flag = <span class="literal">False</span></span><br><span class="line">                    index = line.find(<span class="string">&#x27;COMMENT&#x27;</span>)</span><br><span class="line">                    <span class="keyword">if</span> index &gt; <span class="number">0</span>:</span><br><span class="line">                        table.comment = _get_token_value(line[index:], <span class="string">&#x27;\&#x27;&#x27;</span>)</span><br><span class="line">                <span class="comment"># TODO： key</span></span><br><span class="line">        <span class="keyword">return</span> table</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Column</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name=<span class="string">&#x27;&#x27;</span>, <span class="built_in">type</span>=<span class="string">&#x27;VARCHAR&#x27;</span>, nullable=<span class="literal">False</span>, default=<span class="literal">None</span>, comment=<span class="literal">None</span></span>):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.<span class="built_in">type</span> = <span class="built_in">type</span></span><br><span class="line">        self.nullable = nullable</span><br><span class="line">        self.default = default</span><br><span class="line">        self.comment = comment</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">to_ddl</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># `id` bigint(20) NOT NULL COMMENT &#x27;主键&#x27;,</span></span><br><span class="line">        ddl = <span class="string">&#x27;`%s` %s&#x27;</span> % (self.name, self.<span class="built_in">type</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.nullable:</span><br><span class="line">            ddl += <span class="string">&#x27; NOT NULL&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> self.default:</span><br><span class="line">            ddl += <span class="string">&#x27; DEFAULT \&#x27;%s\&#x27;&#x27;</span> % self.default</span><br><span class="line">        <span class="keyword">if</span> self.comment:</span><br><span class="line">            ddl += <span class="string">&#x27; COMMENT \&#x27;%s\&#x27;&#x27;</span> % self.comment</span><br><span class="line">        <span class="keyword">return</span> ddl</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">to_puml</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># not_null(online_type)   tinyint default(0) comment(&quot;0:上线 1:未上线&quot;)</span></span><br><span class="line">        puml = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> self.nullable:</span><br><span class="line">            puml += self.name</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            puml += <span class="string">&#x27;not_null(%s)&#x27;</span> % self.name</span><br><span class="line">        puml += <span class="string">&#x27; &#x27;</span> + self.<span class="built_in">type</span></span><br><span class="line">        <span class="keyword">if</span> self.default:</span><br><span class="line">            puml += <span class="string">&#x27; default(%s)&#x27;</span> % self.default</span><br><span class="line">        <span class="keyword">if</span> self.comment:</span><br><span class="line">            puml += <span class="string">&#x27; comment(&quot;%s&quot;)&#x27;</span> % self.comment</span><br><span class="line">        <span class="keyword">return</span> puml</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">from_ddl</span>(<span class="params">line</span>):</span><br><span class="line">        tokens = line.split()</span><br><span class="line">        <span class="comment"># 列名</span></span><br><span class="line">        col_name = _get_token_value(tokens[<span class="number">0</span>])</span><br><span class="line">        <span class="comment"># 类型</span></span><br><span class="line">        col_type = tokens[<span class="number">1</span>]</span><br><span class="line">        <span class="comment"># 删除bigint等字段后面的长度，例：bigint(20) --&gt; bigint，只保留varchar和char字段的长度</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> col_type.startswith(<span class="string">&#x27;char&#x27;</span>) <span class="keyword">and</span> <span class="keyword">not</span> col_type.startswith(<span class="string">&#x27;varchar&#x27;</span>) <span class="keyword">and</span> col_type.find(<span class="string">&#x27;(&#x27;</span>) &gt;= <span class="number">0</span>:</span><br><span class="line">            col_type = col_type[<span class="number">0</span>: col_type.index(<span class="string">&#x27;(&#x27;</span>)]</span><br><span class="line">        <span class="keyword">if</span> line.find(<span class="string">&#x27;unsigned&#x27;</span>) &gt; <span class="number">0</span>:</span><br><span class="line">            col_type += <span class="string">&#x27; unsigned&#x27;</span></span><br><span class="line">        col_nullable = line.find(<span class="string">&#x27;NOT NULL&#x27;</span>) &lt; <span class="number">0</span></span><br><span class="line">        <span class="comment"># 默认值</span></span><br><span class="line">        col_default = <span class="literal">None</span></span><br><span class="line">        index = line.find(<span class="string">&#x27;DEFAULT&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> index &gt; <span class="number">0</span>:</span><br><span class="line">            sub_line = line[index + <span class="built_in">len</span>(<span class="string">&#x27;DEFAULT&#x27;</span>):].strip()</span><br><span class="line">            <span class="keyword">if</span> sub_line.startswith(<span class="string">&#x27;NULL&#x27;</span>):</span><br><span class="line">                col_default = <span class="string">&#x27;NULL&#x27;</span></span><br><span class="line">            <span class="keyword">elif</span> sub_line.startswith(<span class="string">&#x27;\&#x27;&#x27;</span>):</span><br><span class="line">                col_default = _get_token_value(sub_line, delimiter=<span class="string">&#x27;\&#x27;&#x27;</span>)</span><br><span class="line">        <span class="comment"># 注释</span></span><br><span class="line">        col_comment = <span class="literal">None</span></span><br><span class="line">        index = line.find(<span class="string">&#x27;COMMENT&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> index &gt;= <span class="number">0</span>:</span><br><span class="line">            col_comment = _get_token_value(line[index:], delimiter=<span class="string">&#x27;\&#x27;&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> Column(name=col_name, <span class="built_in">type</span>=col_type, nullable=col_nullable, default=col_default, comment=col_comment)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_get_token_value</span>(<span class="params">token, delimiter=<span class="string">&#x27;`&#x27;</span></span>):</span><br><span class="line">    start = token.index(delimiter) + <span class="number">1</span></span><br><span class="line">    end = token[start:].index(delimiter)</span><br><span class="line">    value = token[start: start + end].strip()</span><br><span class="line">    <span class="keyword">return</span> value.strip()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_parse_puml</span>(<span class="params">lines</span>):</span><br><span class="line">    uml_flag = <span class="literal">False</span></span><br><span class="line">    table_flag = <span class="literal">False</span></span><br><span class="line">    tables = []</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">        line = line.strip()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># uml起始行</span></span><br><span class="line">        <span class="keyword">if</span> line == <span class="string">&#x27;@startuml&#x27;</span>:</span><br><span class="line">            uml_flag = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> uml_flag:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="comment"># 空行</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> line:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="comment"># 注释行</span></span><br><span class="line">        <span class="keyword">if</span> line.startswith(<span class="string">&#x27;\&#x27;&#x27;</span>):</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        upper_line = line.upper()</span><br><span class="line">        <span class="comment"># 表起始行</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> table_flag <span class="keyword">and</span> upper_line.startswith(<span class="string">&#x27;TABLE&#x27;</span>):</span><br><span class="line">            table_flag = <span class="literal">True</span></span><br><span class="line">            table_name = _parse_table_name(line)</span><br><span class="line">            table_comment = _parse_table_comment(line, table_name)</span><br><span class="line">            table = Table(table_name, table_comment)</span><br><span class="line">        <span class="keyword">elif</span> table_flag:</span><br><span class="line">            <span class="comment"># 表结束行</span></span><br><span class="line">            <span class="keyword">if</span> line == <span class="string">&#x27;&#125;&#x27;</span>:</span><br><span class="line">                table_flag = <span class="literal">False</span></span><br><span class="line">                tables.append(table)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                col = _parse_col(line)</span><br><span class="line">                <span class="keyword">if</span> col:</span><br><span class="line">                    table.cols.append(col)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tables</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_parse_table_name</span>(<span class="params">line</span>):</span><br><span class="line">    <span class="comment"># example: Table(  style, &quot;style&quot;) &#123;</span></span><br><span class="line">    <span class="keyword">return</span> line[line.index(<span class="string">&#x27;(&#x27;</span>) + <span class="number">1</span>: line.index(<span class="string">&#x27;,&#x27;</span>)].strip()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_parse_table_comment</span>(<span class="params">line, table_name</span>):</span><br><span class="line">    <span class="comment"># example: Table(biz_partner_entrant, &quot;biz_partner_entrant\n(业务合作方入驻表)&quot;) &#123;</span></span><br><span class="line">    pattern = re.<span class="built_in">compile</span>(<span class="string">r&#x27;[(](.*?)[)]&#x27;</span>, re.S)</span><br><span class="line">    table_comment = re.findall(pattern, line[line.index(table_name) : -<span class="number">1</span>])[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> table_comment:</span><br><span class="line">        <span class="keyword">return</span> table_name</span><br><span class="line">    <span class="keyword">return</span> table_comment</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_parse_col</span>(<span class="params">line</span>):</span><br><span class="line">    <span class="comment"># example: not_null(id) BIGINT(20) comment(&quot;主键&quot;)</span></span><br><span class="line">    <span class="comment"># 预处理，删除(和)符号间的无用空格</span></span><br><span class="line">    line = re.sub(<span class="string">&#x27;\(\s+&#x27;</span>, <span class="string">&#x27;(&#x27;</span>, line)</span><br><span class="line">    line = re.sub(<span class="string">&#x27;\s+\)&#x27;</span>, <span class="string">&#x27;)&#x27;</span>, line)</span><br><span class="line">    tokens = line.split()</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(tokens) == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    col = Column()</span><br><span class="line">    <span class="keyword">if</span> tokens[<span class="number">0</span>].startswith(<span class="string">&#x27;not_null&#x27;</span>):</span><br><span class="line">        col.nullable = <span class="literal">False</span></span><br><span class="line">        col.name = _get_bracket_value(tokens[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        col.nullable = <span class="literal">True</span></span><br><span class="line">        col.name = tokens[<span class="number">0</span>]</span><br><span class="line">    col.<span class="built_in">type</span> = _get_type_value(tokens[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(tokens) &gt;= <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> tokens[<span class="number">2</span>] == <span class="string">&#x27;unsigned&#x27;</span> <span class="keyword">and</span> <span class="keyword">not</span> col.<span class="built_in">type</span>.endswith(<span class="string">&#x27;unsigned&#x27;</span>):</span><br><span class="line">            col.<span class="built_in">type</span> += <span class="string">&#x27; unsigned&#x27;</span></span><br><span class="line">        <span class="keyword">for</span> token <span class="keyword">in</span> tokens:</span><br><span class="line">            <span class="keyword">if</span> token.startswith(<span class="string">&#x27;default(&#x27;</span>):</span><br><span class="line">                col.default = _get_bracket_value(token)</span><br><span class="line">            <span class="keyword">elif</span> token.startswith(<span class="string">&#x27;comment(&#x27;</span>):</span><br><span class="line">                col.comment = _get_bracket_value(line[line.index(<span class="string">&#x27;comment(&#x27;</span>):])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> col</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_get_bracket_value</span>(<span class="params">token</span>):</span><br><span class="line">    value = token[token.index(<span class="string">&#x27;(&#x27;</span>) + <span class="number">1</span>: token.index(<span class="string">&#x27;)&#x27;</span>)].strip()</span><br><span class="line">    <span class="keyword">if</span> (value.startswith(<span class="string">&#x27;&quot;&#x27;</span>) <span class="keyword">and</span> value.endswith(<span class="string">&#x27;&quot;&#x27;</span>)) <span class="keyword">or</span> (value.startswith(<span class="string">&#x27;\&#x27;&#x27;</span>) <span class="keyword">and</span> value.endswith(<span class="string">&#x27;\&#x27;&#x27;</span>)):</span><br><span class="line">        value = value[<span class="number">1</span>:-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> value.strip()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_get_type_value</span>(<span class="params">type_token</span>):</span><br><span class="line">    <span class="comment"># 如果有下划线，替换为空格，例如bigint_unsigned --&gt; bigint unsigned</span></span><br><span class="line">    <span class="built_in">type</span> = re.sub(<span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27; &#x27;</span>, type_token)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">type</span>.lower()</span><br></pre></td></tr></table></figure>

<h2 id="db-py"><a href="#db-py" class="headerlink" title="db.py"></a>db.py</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*-coding:utf-8-*-</span></span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Mysql</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, user, db, host=<span class="string">&#x27;127.0.0.1&#x27;</span>, port=<span class="number">8000</span>, password=<span class="string">&#x27;123456&#x27;</span>, charset=<span class="string">&#x27;utf8mb4&#x27;</span></span>):</span><br><span class="line">        self.host = host</span><br><span class="line">        self.port = port</span><br><span class="line">        self.user = user</span><br><span class="line">        self.password = password</span><br><span class="line">        self.db = db</span><br><span class="line">        self.charset = charset</span><br><span class="line">        self._connection = <span class="literal">None</span></span><br><span class="line">        self._connect()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_table_names</span>(<span class="params">self</span>):</span><br><span class="line">        self._connect()</span><br><span class="line">        tables = []</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cursor = self._connection.cursor()</span><br><span class="line">            cursor.execute(<span class="string">&#x27;SHOW TABLES&#x27;</span>)</span><br><span class="line">            result = cursor.fetchall()</span><br><span class="line">            <span class="keyword">for</span> record <span class="keyword">in</span> result:</span><br><span class="line">                tables.extend(<span class="built_in">list</span>(record.values()))</span><br><span class="line">            <span class="keyword">return</span> tables</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            self._close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_create_table</span>(<span class="params">self, table_name</span>):</span><br><span class="line">        self._connect()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cursor = self._connection.cursor()</span><br><span class="line">            cursor.execute(<span class="string">&#x27;SHOW CREATE TABLE &#x27;</span> + table_name)</span><br><span class="line">            result = cursor.fetchone()</span><br><span class="line">            create_table = result[<span class="string">&#x27;Create Table&#x27;</span>]</span><br><span class="line">            <span class="keyword">return</span> create_table</span><br><span class="line">        <span class="keyword">except</span> pymysql.err.ProgrammingError:</span><br><span class="line">            <span class="comment"># print(&#x27;DB Error: cannot read table info: &#x27; + table_name)</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            self._close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_ddl_dict</span>(<span class="params">self</span>):</span><br><span class="line">        ddl_dict = &#123;&#125;</span><br><span class="line">        table_names = self.get_table_names()</span><br><span class="line">        <span class="keyword">for</span> table_name <span class="keyword">in</span> table_names:</span><br><span class="line">            create_table = self.get_create_table(table_name)</span><br><span class="line">            ddl_dict[table_name] = create_table</span><br><span class="line">        <span class="keyword">return</span> ddl_dict</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_connect</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self._is_connected():</span><br><span class="line">            self._connection = pymysql.connect(host=self.host,</span><br><span class="line">                                               port=self.port,</span><br><span class="line">                                               user=self.user,</span><br><span class="line">                                               password=self.password,</span><br><span class="line">                                               db=self.db,</span><br><span class="line">                                               charset=self.charset,</span><br><span class="line">                                               cursorclass=pymysql.cursors.DictCursor)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_is_connected</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self._connection <span class="keyword">and</span> self._connection.<span class="built_in">open</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_close</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> self._is_connected():</span><br><span class="line">            self._connection.close()</span><br></pre></td></tr></table></figure>


        </div>
          
        <div class="top-div">
          <ol class="top-box"><li class="top-box-item top-box-level-1"><a class="top-box-link" href="#%E5%89%8D%E8%A8%80"><span class="top-box-text">前言</span></a></li><li class="top-box-item top-box-level-1"><a class="top-box-link" href="#%E5%8A%9F%E8%83%BD"><span class="top-box-text">功能</span></a></li><li class="top-box-item top-box-level-1"><a class="top-box-link" href="#%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E"><span class="top-box-text">使用说明</span></a></li><li class="top-box-item top-box-level-1"><a class="top-box-link" href="#%E7%A4%BA%E4%BE%8B"><span class="top-box-text">示例</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E5%B0%86PlantUML%E7%9A%84ER%E5%9B%BE%E6%96%87%E4%BB%B6%E8%BD%AC%E6%8D%A2%E4%B8%BADDL"><span class="top-box-text">将PlantUML的ER图文件转换为DDL</span></a></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E9%80%9A%E8%BF%87TDDL-APP%E5%90%8D%E7%94%9F%E6%88%90PlantUML-ER%E5%9B%BE%E6%96%87%E4%BB%B6"><span class="top-box-text">通过TDDL_APP名生成PlantUML ER图文件</span></a></li></ol></li><li class="top-box-item top-box-level-1"><a class="top-box-link" href="#%E6%89%A9%E5%B1%95"><span class="top-box-text">扩展</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89PlantUML%E7%9A%84ER%E5%9B%BE%E9%A3%8E%E6%A0%BC"><span class="top-box-text">自定义PlantUML的ER图风格</span></a></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89MySQL-DDL%E7%9A%84%E9%BB%98%E8%AE%A4%E5%AD%97%E6%AE%B5"><span class="top-box-text">自定义MySQL DDL的默认字段</span></a></li></ol></li><li class="top-box-item top-box-level-1"><a class="top-box-link" href="#%E4%BB%A3%E7%A0%81"><span class="top-box-text">代码</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#tool-sh"><span class="top-box-text">tool.sh</span></a></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#main-py"><span class="top-box-text">main.py</span></a></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#er-py"><span class="top-box-text">er.py</span></a></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#db-py"><span class="top-box-text">db.py</span></a></li></ol></li></ol>
        </div>
          
      </div>
    </div>

    
      <div class="next-post">
        <a class="purple-link" href="/2019/01/09/netty-zhi-bei-xi-lie-1-ru-men/">
          <h3 class="post-title">
            下一篇：Netty指北系列1-入门
          </h3>
        </a>
      </div>
    
  </div>










<footer>
<div class="site-footer">
  <div class="social-container">
    
      
        <a aria-label="跳转至github" href="https://github.com/f-dong" target="_blank">
          <i class="icon icon-github"></i>
        </a>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  </div>
  
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <a href="https://github.com/f-dong/hexo-theme-minimalism" target="_blank">Theme</a>
  
  
  
  
  
  
</div>
</footer>


      </div>
    </div>
    
<script id="hexo-configurations"> window.theme_config = {"image":{"lazyload_enable":true,"photo_zoom":"simple-lightbox"}}; window.is_post = true; </script>

<script src="/js/main.js"></script>






  <script src="/js/simple-lightbox.min.js"></script><script>document.addEventListener('DOMContentLoaded', function() {new SimpleLightbox('.post-detail .simple-lightbox', {fileExt: false,captionsData:'alt'});});</script></body>
</html>

